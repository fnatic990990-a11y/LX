<script type="module">
  // ================== Firebase ==================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAjbvQo7NrGZiFbFbdY3a7UtDjlv0SwU3w",
    authDomain: "smart-load-analyzer-56cb2.firebaseapp.com",
    projectId: "smart-load-analyzer-56cb2",
    storageBucket: "smart-load-analyzer-56cb2.firebasestorage.app",
    messagingSenderId: "253721588070",
    appId: "1:253721588070:web:c24bc2fbc27c2fba9e18a7",
    measurementId: "G-60RF97SGWN"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ================== TRANSLATIONS ==================
  const translations = {
    en: {
      hdr_sub: "SMART LOAD â€“ DRIVER PORTAL",
      hdr_tag: "Driver & Admin Access",

      land_title: "Who is using this portal?",
      land_sub: "Choose your role to continue.",
      land_admin_title: "I am an Admin",
      land_driver_title: "I am a Driver",
      land_admin_btn: "Go to Admin Platform",
      land_driver_btn: "Continue as Driver",

      login_title: "Driver Login",
      login_sub: "Enter your Driver ID and Company Code.",
      login_back: "â¬… Back",
      login_driverId_label: "Driver ID",
      login_company_label: "Company Code",
      login_btn: "Login as Driver",
      login_error_missing: "Please enter both Driver ID and Company Code.",
      login_error_generic: "Login error. Please try again.",
      login_error_company_not_found: "Company code not found. Please check with your admin.",
      login_generic: "Logged in as demo driver.",

      dash_logout: "Logout",
      dash_assign_title: "Current Assignment",
      dash_status_ready: "âœ… Status: Ready for assignment",
      dash_status_arrived: "ğŸŸ¡ Status: Arrived at location, waiting for loading",
      dash_status_loaded: "âœ… Status: Loaded â€“ ready to depart",
      dash_route_title: "Today's Route & Instructions",
      dash_route_sub: "Simple guidance from operations â€” where to go and what to do.",
      dash_btn_arrived: "Mark as Arrived at Location",
      dash_btn_loaded: "Confirm Loading Complete",
      dash_note: "This driver view is connected to your company's Smart Load Analyzer data.",
      dash_msg_arrived: "Arrival confirmed. Dispatch will see this status.",
      dash_msg_loaded: "Loading confirmed. You are ready to depart.",
      dash_welcome_prefix: "Welcome, ",
      dash_driver_info: "Driver ID: ",
      dash_company_info: " Â· Company code: ",
      dash_truck_info: " Â· Truck: ",
      dash_no_assign: "No active assignment yet. Please wait for dispatch instructions.",
      dash_assign_text: "Next route: {route}. Notes: {note}",

      tl1_label: "1. Go to:",
      tl1_desc: "Follow dispatch instructions for this location / route.",
      tl2_label: "2. Confirm arrival",
      tl2_desc: "Use \"Mark as Arrived\" when you reach the location.",
      tl3_label: "3. Confirm loading",
      tl3_desc: "Use \"Confirm Loading Complete\" after finishing loading.",

      sup_title: "Customer Support",
      sup_phone_label: "Phone:",
      sup_email_label: "Email:",
      sup_fax_label: "Fax:",
      foot_portal: "Driver Portal"
    },

    ar: {
      hdr_sub: "SMART LOAD â€“ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚",
      hdr_tag: "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚",

      land_title: "Ù…Ù† ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©ØŸ",
      land_sub: "Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.",
      land_admin_title: "Ø£Ù†Ø§ Ø¥Ø¯Ø§Ø±ÙŠ",
      land_driver_title: "Ø£Ù†Ø§ Ø³Ø§Ø¦Ù‚",
      land_admin_btn: "Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
      land_driver_btn: "Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙƒØ³Ø§Ø¦Ù‚",

      login_title: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚",
      login_sub: "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ©.",
      login_back: "â¬… Ø±Ø¬ÙˆØ¹",
      login_driverId_label: "Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚",
      login_company_label: "ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ©",
      login_btn: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚",
      login_error_missing: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ©.",
      login_error_generic: "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
      login_error_company_not_found: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ©ØŒ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.",
      login_generic: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚ ØªØ¬Ø±ÙŠØ¨ÙŠ.",

      dash_logout: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",
      dash_assign_title: "Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
      dash_status_ready: "âœ… Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø­Ù„Ø©",
      dash_status_arrived: "ğŸŸ¡ Ø§Ù„Ø­Ø§Ù„Ø©: ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ£Ù†ØªØ¸Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„",
      dash_status_loaded: "âœ… Ø§Ù„Ø­Ø§Ù„Ø©: ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ â€“ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…ØºØ§Ø¯Ø±Ø©",
      dash_route_title: "Ù…Ø³Ø§Ø± Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª",
      dash_route_sub: "Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù…Ù† Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª â€” Ø¥Ù„Ù‰ Ø£ÙŠÙ† ØªØ°Ù‡Ø¨ ÙˆÙ…Ø§Ø°Ø§ ØªÙØ¹Ù„.",
      dash_btn_arrived: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹",
      dash_btn_loaded: "ØªØ£ÙƒÙŠØ¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„",
      dash_note: "Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø±ÙƒØªÙƒ ÙÙŠ Ù†Ø¸Ø§Ù… Smart Load Analyzer.",
      dash_msg_arrived: "ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ØŒ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.",
      dash_msg_loaded: "ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¢Ù†.",
      dash_welcome_prefix: "Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ ",
      dash_driver_info: "Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚: ",
      dash_company_info: " Â· ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ©: ",
      dash_truck_info: " Â· Ø§Ù„Ø´Ø§Ø­Ù†Ø©: ",
      dash_no_assign: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø© Ù…ÙØ¹Ù‘Ù„Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.",
      dash_assign_text: "Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ: {route}. Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª: {note}",

      tl1_label: "1. Ø§Ù„ØªÙˆØ¬Ù‘Ù‡ Ø¥Ù„Ù‰:",
      tl1_desc: "Ø§ØªØ¨Ø¹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§Ø±.",
      tl2_label: "2. ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„",
      tl2_desc: "Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± \"ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„\" Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹.",
      tl3_label: "3. ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„",
      tl3_desc: "Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± \"ØªØ£ÙƒÙŠØ¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„\" Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.",

      sup_title: "Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
      sup_phone_label: "Ø§Ù„Ù‡Ø§ØªÙ:",
      sup_email_label: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:",
      sup_fax_label: "Ø§Ù„ÙØ§ÙƒØ³:",
      foot_portal: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚"
    }
  };

  let currentLang = "en";
  let currentDriver = null;
  let currentCompanyDocId = null;

  // ================== HELPERS ==================
  function getLocalized(driver, key) {
    if (!driver) return "";
    if (currentLang === "ar") {
      return driver[key + "Ar"] || driver[key + "En"] || "";
    } else {
      return driver[key + "En"] || driver[key + "Ar"] || "";
    }
  }

  // ================== LANGUAGE ==================
  function setLanguage(lang) {
    currentLang = lang;
    const t = translations[lang];

    document.documentElement.lang = lang;
    document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";

    document.getElementById("btnLangEn").classList.toggle("active", lang === "en");
    document.getElementById("btnLangAr").classList.toggle("active", lang === "ar");

    document.getElementById("hdr_sub").textContent = t.hdr_sub;
    document.getElementById("hdr_tag").textContent = t.hdr_tag;

    document.getElementById("land_title").textContent = t.land_title;
    document.getElementById("land_sub").textContent = t.land_sub;
    document.getElementById("land_admin_title").textContent = t.land_admin_title;
    document.getElementById("land_driver_title").textContent = t.land_driver_title;
    document.getElementById("land_admin_btn").textContent = t.land_admin_btn;
    document.getElementById("land_driver_btn").textContent = t.land_driver_btn;

    document.getElementById("login_title").textContent = t.login_title;
    document.getElementById("login_sub").textContent = t.login_sub;
    document.getElementById("login_back").textContent = t.login_back;
    document.getElementById("login_driverId_label").textContent = t.login_driverId_label;
    document.getElementById("login_company_label").textContent = t.login_company_label;
    document.getElementById("login_btn").textContent = t.login_btn;

    document.getElementById("dash_logout").textContent = t.dash_logout;
    document.getElementById("dash_assign_title").textContent = t.dash_assign_title;
    document.getElementById("dash_route_title").textContent = t.dash_route_title;
    document.getElementById("dash_route_sub").textContent = t.dash_route_sub;
    document.getElementById("dash_btn_arrived").textContent = t.dash_btn_arrived;
    document.getElementById("dash_btn_loaded").textContent = t.dash_btn_loaded;
    document.getElementById("dash_note").textContent = t.dash_note;

    document.getElementById("sup_title").textContent = t.sup_title;
    document.getElementById("sup_phone_label").textContent = t.sup_phone_label;
    document.getElementById("sup_email_label").textContent = t.sup_email_label;
    document.getElementById("sup_fax_label").textContent = t.sup_fax_label;
    document.getElementById("foot_portal").textContent = t.foot_portal;

    const footer = document.getElementById("footerBox");
    footer.className = (lang === "ar") ? "footer-right" : "footer-left";

    document.getElementById("driverId").placeholder =
      (lang === "en") ? "e.g. 1023" : "Ù…Ø«Ø§Ù„: 1023";
    document.getElementById("companyCode").placeholder =
      (lang === "en") ? "e.g. LXPRT" : "Ù…Ø«Ø§Ù„: ABC123";

    if (currentDriver) {
      fillDriverDashboard(currentDriver);
    }
  }

  // ================== VIEWS ==================
  function switchView(id) {
    const views = document.querySelectorAll(".view");
    views.forEach(v => v.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  function goToAdmin() {
    window.location.href = "admin.html";
  }

  // ================== DRIVER LOGIN (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ© / Firebase) ==================
  function driverLogin() {
    const idInput  = document.getElementById("driverId");
    const codeInput = document.getElementById("companyCode");
    const msgEl    = document.getElementById("driverLoginMsg");
    const t        = translations[currentLang];

    const driverId   = (idInput.value || "").trim();
    const companyRaw = (codeInput.value || "").trim();
    const company    = companyRaw.toUpperCase();

    // Ù†ÙƒØªÙÙŠ Ø¨Ø£Ù†Ù‡ ÙŠÙƒØªØ¨ Ø£ÙŠ Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ø®Ø§Ù†ØªÙŠÙ†
    if (!driverId || !company) {
      msgEl.textContent = t.login_error_missing;
      msgEl.classList.add("hint-error");
      return;
    }

    msgEl.textContent = "";
    msgEl.classList.remove("hint-error");

    // Ù†Ø¨Ù†ÙŠ Ø³Ø§Ø¦Ù‚ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø±Ø¨Ø· Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    currentDriver = {
      driverId,
      companyCode: company,
      nameEn: `Driver ${driverId}`,
      nameAr: `Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driverId}`,
      truck: "â€”",
      nextRouteEn: "To be assigned",
      nextRouteAr: "Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ø§Ø­Ù‚Ù‹Ø§",
      noteEn: "Please contact dispatch for your next assignment.",
      noteAr: "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©."
    };

    fillDriverDashboard(currentDriver);
    switchView("view-driver-dashboard");
  }

  // ================== DASHBOARD RENDER ==================
  function fillDriverDashboard(d) {
    const t = translations[currentLang];

    const name = getLocalized(d, "name");
    const route = getLocalized(
      { routeEn: d.nextRouteEn, routeAr: d.nextRouteAr },
      "route"
    );
    const note = getLocalized(
      { noteEn: d.noteEn, noteAr: d.noteAr },
      "note"
    );

    document.getElementById("driverWelcome").textContent =
      t.dash_welcome_prefix + name;

    let info = t.dash_driver_info + d.driverId +
               t.dash_company_info + d.companyCode;
    if (d.truck && d.truck !== "â€”") {
      info += t.dash_truck_info + d.truck;
    }
    document.getElementById("driverInfo").textContent = info;

    const statusEl = document.getElementById("driverStatusPill");
    statusEl.textContent = t.dash_status_ready;
    statusEl.className = "status-pill status-ok";

    const assignEl = document.getElementById("currentAssignment");
    assignEl.textContent =
      t.dash_assign_text
        .replace("{route}", route)
        .replace("{note}", note);

    updateTimeline(route);
    document.getElementById("driverActionMsg").textContent = "";
  }

  function updateTimeline(route) {
    const t = translations[currentLang];
    const tl = document.getElementById("driverTimeline");
    const routeText = route || "";

    tl.innerHTML =
      '<div class="timeline-item">' +
        '<div class="timeline-label">' + t.tl1_label + ' ' + routeText + '</div>' +
        '<div>' + t.tl1_desc + '</div>' +
      '</div>' +
      '<div class="timeline-item">' +
        '<div class="timeline-label">' + t.tl2_label + '</div>' +
        '<div>' + t.tl2_desc + '</div>' +
      '</div>' +
      '<div class="timeline-item">' +
        '<div class="timeline-label">' + t.tl3_label + '</div>' +
        '<div>' + t.tl3_desc + '</div>' +
      '</div>';
  }

  // ================== BUTTON ACTIONS ==================
  function markArrived() {
    const t = translations[currentLang];
    const statusEl = document.getElementById("driverStatusPill");
    statusEl.textContent = t.dash_status_arrived;
    statusEl.className = "status-pill status-warn";
    document.getElementById("driverActionMsg").textContent = t.dash_msg_arrived;
  }

  function markLoaded() {
    const t = translations[currentLang];
    const statusEl = document.getElementById("driverStatusPill");
    statusEl.textContent = t.dash_status_loaded;
    statusEl.className = "status-pill status-ok";
    document.getElementById("driverActionMsg").textContent = t.dash_msg_loaded;
  }

  function driverLogout() {
    currentDriver = null;
    currentCompanyDocId = null;
    document.getElementById("driverId").value = "";
    document.getElementById("companyCode").value = "";
    document.getElementById("driverLoginMsg").textContent = "";
    switchView("view-driver-login");
  }

  // ================== EXPOSE TO WINDOW ==================
  window.setLanguage  = setLanguage;
  window.switchView   = switchView;
  window.goToAdmin    = goToAdmin;
  window.driverLogin  = driverLogin;
  window.markArrived  = markArrived;
  window.markLoaded   = markLoaded;
  window.driverLogout = driverLogout;

  // ================== INIT ==================
  window.addEventListener("DOMContentLoaded", () => {
    setLanguage("en");
  });
</script>
