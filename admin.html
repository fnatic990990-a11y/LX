<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Logixperts - Smart Load Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --card: #111827;
      --accent: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .app {
      max-width: 1200px; width: 100%;
      background: #020617;
      border-radius: 32px;
      border: 1px solid #1f2937;
      padding: 20px 20px 26px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      display: flex; flex-direction: column; gap: 18px;
    }

    header {
      display: flex; justify-content: space-between; align-items: center;
      gap: 16px; padding: 10px 14px 6px;
      border-radius: 26px;
      background: radial-gradient(circle at left top, #22c55e20, #020617 55%);
      border: 1px solid #1f2937;
      flex-wrap: wrap;
    }

    .brand-group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand { display: flex; align-items: center; gap: 14px; }

    .badge-logo {
      width: 42px; height: 42px;
      border-radius: 18px;
      border: 1px solid #16a34a;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
      display: flex; align-items: center; justify-content: center;
      color: #ecfdf5; font-weight: 800; font-size: 18px;
      box-shadow: 0 10px 25px rgba(34,197,94,.55);
    }

    .brand-text h1 {
      font-size: 20px; font-weight: 800;
      letter-spacing: .06em; text-transform: uppercase;
    }

    .brand-text span {
      display:block; font-size:11px; color:var(--muted);
      text-transform:uppercase; letter-spacing:.12em; margin-top:2px;
    }

    .back-link {
      font-size: 12px;
      color: var(--muted);
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      cursor: pointer;
      white-space: nowrap;
    }

    .back-link:hover {
      color: #e5e7eb;
      border-color: #22c55e;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .lang-switch {
      font-size: 13px;
      background: #020617;
      border: 1px solid #1f2937;
      padding: 6px 12px;
      border-radius: 999px;
      color: var(--muted);
      cursor: pointer;
    }

    .team-pill {
      padding: 8px 14px; border-radius: 999px;
      border: 1px solid #1f2937; background:#020617b3;
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
    }
    .team-pill span { color:#bbf7d0; font-weight:600; }

    .company-code-pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #16a34a;
      background: #022c22;
      font-size: 12px;
      color: #bbf7d0;
      display: none;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .hero {
      display:flex; flex-wrap:wrap; gap:20px;
      padding:14px 18px 18px;
      border-radius:26px;
      background: radial-gradient(circle at top right,#22c55e12,#020617 55%);
      border:1px solid #1f2937;
    }

    .hero-main{flex:1 1 260px;}
    .hero-title{font-size:24px;font-weight:700;margin-bottom:6px;}
    .hero-sub{font-size:13px;color:var(--muted);max-width:420px;line-height:1.4;}

    .hero-tags{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;}
    .hero-tag{
      font-size:11px;padding:6px 10px;border-radius:999px;
      border:1px solid #1f2937;background:#020617;color:#9ca3af;
    }
    .hero-tag strong{color:#a7f3d0;}

    .hero-highlight{
      font-size:12px;margin-top:10px;padding:8px 10px;
      border-radius:14px;background:#022c2230;border:1px solid #064e3b;
      color:#a7f3d0;
    }

    .hero-metric{
      flex:0 0 220px;display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;align-content:center;
    }

    .hero-metric-card{
      padding:10px;border-radius:16px;border:1px solid #1f2937;background:#020617;
    }
    .hero-metric-card h3{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .hero-metric-card p{font-size:17px;font-weight:700;}

    .nav-tabs{
      display:flex;flex-wrap:wrap;gap:8px;padding:4px;
      border-radius:999px;background:#020617;border:1px solid #1f2937;
      align-self:center;
      margin-top: 10px;
    }
    .nav-tab{
      border:none;background:transparent;padding:8px 14px;border-radius:999px;
      font-size:12px;color:var(--muted);cursor:pointer;
      display:none;
    }
    .nav-tab.active{
      background:#16a34a;color:#ecfdf5;font-weight:600;
      box-shadow:0 10px 25px rgba(34,197,94,.55);
    }

    main{margin-top:4px;display:grid;grid-template-columns:minmax(0,1fr);}
    .view{display:none;animation:fade .25s ease-out;}
    .view.active{display:block;}
    @keyframes fade{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);} }

    .card{
      background:var(--card);border-radius:24px;border:1px solid var(--border);
      padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .card-header{
      display:flex;justify-content:space-between;align-items:baseline;
      gap:10px;margin-bottom:10px;flex-wrap:wrap;
    }
    .card-title{font-size:16px;font-weight:600;}
    .card-sub{font-size:12px;color:var(--muted);}

    .two-column{
      display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,0.9fr);gap:14px;
    }
    @media(max-width:900px){
      .two-column{grid-template-columns:minmax(0,1fr);}
      header{flex-direction:column;align-items:flex-start;}
      .hero{flex-direction:column;}
      .hero-metric{width:100%;}
      .header-right{margin-left:0;}
    }

    .analyze-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;margin-bottom:12px;
    }
    .kpi-card{
      padding:12px;border-radius:18px;border:1px solid #1f2937;background:#020617;
    }
    .kpi-label{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .kpi-value{font-size:18px;font-weight:700;margin-bottom:2px;}
    .kpi-footnote{font-size:11px;color:#4ade80;}

    #map{
      width:100%;
      height:230px;
      border-radius:18px;
      border:1px solid #1f2937;
      overflow:hidden;
    }

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;background:#020617;
      border:1px solid #1f2937;font-size:11px;color:var(--muted);
    }
    .pill-dot{width:8px;height:8px;border-radius:999px;background:#22c55e;}

    .login-form,.analyze-form,.signup-form{display:grid;gap:10px;margin-top:6px;}
    label{font-size:12px;margin-bottom:2px;color:var(--muted);}
    .field{display:flex;flex-direction:column;gap:4px;}

    input,select{
      padding:9px 10px;border-radius:12px;border:1px solid #374151;
      background:#020617;color:var(--text);font-size:13px;
    }
    input:focus,select:focus{border-color:#22c55e;outline:none;}

    .password-input{
      display:flex;align-items:center;gap:6px;
    }
    .password-input input{flex:1;}
    .password-toggle{
      border:1px solid #374151;
      background:#020617;
      color:#9ca3af;
      border-radius:999px;
      font-size:11px;
      padding:5px 10px;
      cursor:pointer;
    }

    .btn{
      border:none;padding:9px 14px;border-radius:999px;
      font-size:13px;cursor:pointer;font-weight:600;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .btn-primary{
      background:linear-gradient(to right,#16a34a,#22c55e);
      color:#ecfdf5;box-shadow:0 14px 30px rgba(34,197,94,.55);
    }
    .btn-secondary{
      background:#020617;border:1px solid #374151;color:#e5e7eb;
    }

    .truck-list{
      margin-top:8px;border-radius:18px;border:1px solid #1f2937;
      overflow:hidden;background:#020617;
    }
    .truck-row{
      display:grid;grid-template-columns:1.2fr .9fr 1.3fr;
      padding:8px 10px;font-size:12px;border-bottom:1px solid #111827;
      align-items:center;
    }
    .truck-row.header{background:#020617;font-weight:600;color:var(--muted);font-size:11px;}

    .chip{
      padding:3px 8px;border-radius:999px;font-size:11px;
      border:1px solid #1f2937;display:inline-flex;align-items:center;gap:4px;
    }
    .chip.good{border-color:#16a34a;color:#bbf7d0;background:#052e16;}
    .chip.warn{border-color:#f97316;color:#fed7aa;background:#451a03;}
    .chip.bad{border-color:#ef4444;color:#fecaca;background:#450a0a;}

    .opt-summary{font-size:12px;color:var(--muted);margin-top:6px;}
    .opt-summary strong{color:#a7f3d0;}

    .hint{font-size:11px;color:var(--muted);margin-top:4px;}
    .hint-error{color:#fecaca;}

    .stats-form {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #111827;
    }
    .stats-form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      align-items: end;
    }
    .small-field label {
      font-size: 11px;
    }
    .small-field input {
      font-size: 12px;
      padding: 7px 9px;
    }

    .support-footer{
      margin-top:16px;
      display:flex;
      justify-content:flex-start;
    }

    .support-box{
      font-size:12px;
      color:var(--muted);
      padding:10px 14px;
      border-radius:16px;
      border:1px solid #1f2937;
      background:#020617;
      line-height:1.6;
    }

    .support-title{
      font-size:14px;
      color:#22c55e;
      font-weight:600;
      margin-bottom:4px;
      text-align:left;
    }

    .support-row{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .support-icon{
      font-size:13px;
    }

    footer{margin-top:4px;font-size:10px;color:#4b5563;text-align:right;}
    footer span{color:#a7f3d0;}
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- jsPDF (UMD) -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    onload="window.jsPDF = window.jspdf.jsPDF;">
  </script>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand-group">
        <div class="brand">
          <div class="badge-logo">Lx</div>
          <div class="brand-text">
            <h1 id="text_brand">Logixperts</h1>
            <span id="text_subbrand">Smart Load Analyzer</span>
          </div>
        </div>

        <a href="index.html" id="back_link" class="back-link">
          ‚Üê Back to role selection
        </a>
      </div>

      <div class="header-right">
        <div class="company-code-pill" id="company_code_badge">
          <span id="company_code_label">Company code:</span>
          <span id="company_code_value"></span>
        </div>

        <div class="team-pill">
          <span id="team_label">Team:</span>&nbsp;<span>Logixperts</span> | <span id="team_event">Naqlthon 4</span>
        </div>

        <button class="lang-switch" id="langSwitcher" type="button" onclick="toggleLanguage()">AR</button>
      </div>
    </header>

    <!-- HERO -->
    <section class="hero">
      <div class="hero-main">
        <p class="hero-title" id="hero_title">
          Reduce Empty Trips. Boost Load Factor. Go Greener.
        </p>

        <p class="hero-sub" id="hero_sub">
          Smart Load Analyzer helps freight companies analyze and optimize loads to reduce cost and emissions.
        </p>

        <div class="hero-tags">
          <div class="hero-tag">
            <strong>15‚Äì25%</strong>&nbsp;<span id="tag_fuel">fuel reduction (simulated)</span>
          </div>
          <div class="hero-tag">
            <strong>AI</strong>&nbsp;<span id="tag_ai">load & route suggestions</span>
          </div>
        </div>

        <div class="hero-highlight" id="hero_highlight">
          This demo scenario shows how merging a new shipment with a low-load return trip improves load factor.
        </div>
      </div>

      <div class="hero-metric">
        <div class="hero-metric-card">
          <h3 id="hero_avg_before_title">Avg load (baseline)</h3>
          <p id="hero-load-before">‚Äì</p>
        </div>

        <div class="hero-metric-card">
          <h3 id="hero_cost_title">Op. cost / day</h3>
          <p id="hero-cost-before">‚Äì</p>
        </div>

        <div class="hero-metric-card">
          <h3 id="hero_co2_title">CO‚ÇÇ / day</h3>
          <p id="hero-co2-before">‚Äì</p>
        </div>
      </div>
    </section>

    <!-- NAV TABS -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-view="login-view" id="tab_login">Login / Sign up</button>
      <button class="nav-tab" data-view="dashboard-view" id="tab_dashboard">Dashboard</button>
      <button class="nav-tab" data-view="analyze-view" id="tab_analyze">Analyze Load</button>
      <button class="nav-tab" data-view="optimization-view" id="tab_opt">Optimization Result</button>
    </nav>

    <main>
      <!-- LOGIN -->
      <section id="login-view" class="view active">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="login_title">Company Login</div>
                <div class="card-sub" id="login_sub">
                  Access your Smart Load Analyzer workspace.
                </div>
              </div>
            </div>

            <form class="login-form" onsubmit="event.preventDefault(); demoLogin();">
              <div class="field">
                <label id="label_email">Company email</label>
                <input id="company" type="text" placeholder="demo@logixperts.sa" required />
              </div>

              <div class="field">
                <label id="label_password">Password</label>
                <div class="password-input">
                  <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                  <button
                    type="button"
                    class="password-toggle"
                    onclick="togglePassword('password', this)"
                  >
                    Show
                  </button>
                </div>
              </div>

              <button class="btn btn-primary" type="submit" id="login_btn">
                Login
              </button>

              <p class="hint" id="login_hint">
                Demo credentials: <strong>demo@logixperts.sa</strong> / <strong>Naqlthon4!</strong>
              </p>
              <p id="login-error" class="hint hint-error"></p>
            </form>
          </div>

          <!-- SIGNUP -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="signup_title">Create Company Account</div>
                <div class="card-sub" id="signup_sub">
                  Create your company account to access the system.
                </div>
              </div>
            </div>

            <form class="signup-form" onsubmit="event.preventDefault(); signUp();">
              <div class="field">
                <label id="signup_label_name">Company name</label>
                <input id="signup-name" type="text" placeholder="e.g. Green Freight Co." required />
              </div>

              <div class="field">
                <label id="signup_label_email">Company email</label>
                <input id="signup-email" type="email" placeholder="you@company.sa" required />
              </div>

              <div class="field">
                <label id="signup_label_pass">Password</label>
                <div class="password-input">
                  <input id="signup-password" type="password" placeholder="Choose a strong password" required />
                  <button
                    type="button"
                    class="password-toggle"
                    onclick="togglePassword('signup-password', this)"
                  >
                    Show
                  </button>
                </div>
              </div>

              <div class="field">
                <label id="signup_label_fleet">Fleet size (trucks)</label>
                <input id="signup-fleet" type="number" min="1" step="1" value="20" />
              </div>

              <div class="field">
                <label id="signup_label_plan">Subscription plan</label>
                <select id="signup-plan">
                  <option value="monthly">Starter ‚Äì 299 SAR / month</option>
                  <option value="6months">Growth ‚Äì 1,499 SAR / 6 months</option>
                  <option value="yearly">Enterprise ‚Äì 2,499 SAR / year</option>
                </select>
              </div>

              <button class="btn btn-secondary" id="signup_btn" type="submit">
                Sign up
              </button>
              <p id="signup-message" class="hint"></p>
            </form>
          </div>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section id="dashboard-view" class="view">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="dash_title">Fleet Overview Dashboard</div>
                <div class="card-sub" id="dash_sub">
                  4 demo trucks on main corridors.
                </div>
              </div>
              <span class="pill"><span class="pill-dot"></span> Demo scenario</span>
            </div>

            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-label" id="kpi_trucks_label">Trucks in scenario</div>
                <div class="kpi-value">4</div>
                <div class="kpi-footnote">Riyadh ‚Üî Jeddah / Dammam</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_baseline_label">Avg load (baseline)</div>
                <div class="kpi-value" id="kpi-load-before">‚Äì</div>
                <div class="kpi-footnote" id="kpi_baseline_note">Before optimization</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_after_label">Avg load (after)</div>
                <div class="kpi-value" id="kpi-load-after">‚Äì</div>
                <div class="kpi-footnote" id="kpi_after_note">After last run</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_cost_before_label">Op. cost / day</div>
                <div class="kpi-value" id="kpi-cost-before">‚Äì</div>
                <div class="kpi-footnote" id="kpi_cost_before_note">Simulated SAR</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_cost_after_label">Op. cost / day (after)</div>
                <div class="kpi-value" id="kpi-cost-after">‚Äì</div>
                <div class="kpi-footnote" id="kpi-cost-savings">‚Äì</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_co2_before_label">CO‚ÇÇ / day</div>
                <div class="kpi-value" id="kpi-co2-before">‚Äì</div>
                <div class="kpi-footnote" id="kpi_co2_before_note">kg CO‚ÇÇ</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_co2_after_label">CO‚ÇÇ / day (after)</div>
                <div class="kpi-value" id="kpi-co2-after">‚Äì</div>
                <div class="kpi-footnote" id="kpi-co2-savings">‚Äì</div>
              </div>
            </div>

            <!-- Company metrics form -->
            <div class="stats-form">
              <div class="stats-form-row">
                <div class="field small-field">
                  <label id="stats_label_load">Company avg load (%)</label>
                  <input id="stats-load" type="number" min="0" max="100" step="1" />
                </div>
                <div class="field small-field">
                  <label id="stats_label_cost">Company op. cost / day (SAR)</label>
                  <input id="stats-cost" type="number" min="0" step="1" />
                </div>
                <div class="field small-field">
                  <label id="stats_label_co2">Company CO‚ÇÇ / day (kg)</label>
                  <input id="stats-co2" type="number" min="0" step="1" />
                </div>
                <div class="field small-field">
                  <label>&nbsp;</label>
                  <button class="btn btn-secondary" type="button" id="stats-save-btn">
                    Save metrics
                  </button>
                </div>
              </div>
              <p class="hint" id="stats_hint"></p>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="map_title">Truck Positions & Routes</div>
                <div class="card-sub" id="map_sub">
                  Best routes + load factor markers.
                </div>
              </div>
            </div>
            <div id="map"></div>
          </div>
        </div>
      </section>

      <!-- ANALYZE -->
      <section id="analyze-view" class="view">
        <div class="analyze-grid">
          <!-- MANUAL -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="analyze_title">
                  Analyze New Shipment (Manual)
                </div>
                <div class="card-sub" id="analyze_sub">
                  Enter shipment details manually.
                </div>
              </div>
            </div>

            <form class="analyze-form" onsubmit="event.preventDefault(); runOptimization();">
              <div class="field">
                <label id="label_weight">Weight (tons)</label>
                <input id="weight" type="number" min="0" step="0.1" value="8" />
              </div>

              <div class="field">
                <label id="label_volume">Volume (m¬≥)</label>
                <input id="volume" type="number" min="0" step="1" value="28" />
              </div>

              <div class="field">
                <label id="label_destination">Destination city</label>
                <input id="destination" type="text" value="Riyadh" />
              </div>

              <div class="field">
                <label id="label_delivery">Delivery window</label>
                <input id="deliveryTime" type="text" value="Within 24 hours" />
              </div>

              <div class="field">
                <label id="label_priority">Priority</label>
                <select id="priority">
                  <option value="normal">Normal</option>
                  <option value="high">High priority</option>
                  <option value="low">Low / backhaul</option>
                </select>
              </div>

              <button class="btn btn-primary" id="btn_manual_analyze" type="submit">
                Run Manual Optimization
              </button>
            </form>
          </div>

          <!-- CSV UPLOAD -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="csv_title">Upload Your Trips CSV</div>
                <div class="card-sub" id="csv_sub">
                  Upload trip history to improve optimization accuracy.
                </div>
              </div>
            </div>

            <form class="signup-form" onsubmit="event.preventDefault(); analyzeCSV();">
              <div class="field">
                <label id="csv_label">Choose CSV file</label>
                <input id="csv_file" type="file" accept=".csv" />
              </div>

              <button class="btn btn-secondary" id="btn_csv">
                Analyze CSV
              </button>

              <p id="csv_message" class="hint"></p>
            </form>
          </div>

          <!-- PDF AI REPORT -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="pdf_title">PDF AI Report</div>
                <div class="card-sub" id="pdf_sub">
                  Generate a printable KPI report for your company based on the current demo optimization.
                </div>
              </div>
            </div>

            <p class="hint" id="pdf_hint">
              This is a demo PDF report for Naqlthon showing KPIs, per-truck loads and recommendations for small carriers.
            </p>

            <button
              class="btn btn-secondary"
              type="button"
              id="pdf_btn"
              onclick="generatePdfReport()"
            >
              Generate PDF Report
            </button>

            <p id="pdf_message" class="hint"></p>
          </div>
        </div>
      </section>

      <!-- OPTIMIZATION -->
      <section id="optimization-view" class="view">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="opt_title">Optimization Result</div>
                <div class="card-sub" id="opt_sub">Recommended load distribution.</div>
              </div>
            </div>

            <div class="truck-list" id="truck-list">
              <div class="truck-row header">
                <div id="opt_col_truck">Truck & Route</div>
                <div id="opt_col_load">Load Factor</div>
                <div id="opt_col_ai">AI Suggestion</div>
              </div>
            </div>

            <p class="opt-summary" id="opt-summary">
              Run manual or CSV analysis to see results.
            </p>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="chart_title">KPIs Before vs After</div>
                <div class="card-sub" id="chart_sub">Avg Load, Cost, CO‚ÇÇ comparison</div>
              </div>
            </div>
            <canvas id="optChart"></canvas>
          </div>
        </div>
      </section>
    </main>

    <!-- SUPPORT -->
    <div class="support-footer">
      <div class="support-box">
        <div class="support-title" id="support_title">Customer Support</div>
        <div class="support-row">
          <span class="support-icon">üìû</span>
          <span id="support_phone_label">Phone:</span>&nbsp;<span>+966 55 555 5555</span>
        </div>
        <div class="support-row">
          <span class="support-icon">üìß</span>
          <span id="support_email_label">Email:</span>&nbsp;<span>support@logixperts.com</span>
        </div>
        <div class="support-row">
          <span class="support-icon">üì†</span>
          <span id="support_fax_label">Fax:</span>&nbsp;<span>011-1234567</span>
        </div>
      </div>
    </div>

    <footer>
      Logixperts ¬∑ Smart Load Analyzer ¬∑ Naqlthon 4
    </footer>
  </div>

  <!-- ================= FIREBASE + LOGIC ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      addDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjbvQo7NrGZiFbFbdY3a7UtDjlv0SwU3w",
      authDomain: "smart-load-analyzer-56cb2.firebaseapp.com",
      projectId: "smart-load-analyzer-56cb2",
      storageBucket: "smart-load-analyzer-56cb2.firebasestorage.app",
      messagingSenderId: "253721588070",
      appId: "1:253721588070:web:c24bc2fbc27c2fba9e18a7",
      measurementId: "G-60RF97SGWN"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ========== LANG ==========
    let currentLang = "en";

    const translations = {
      en: {
        text_brand: "Logixperts",
        text_subbrand: "Smart Load Analyzer",
        back_link: "‚Üê Back to role selection",
        company_code_label: "Company code:",
        team_label: "Team:",
        team_event: "Naqlthon 4",

        hero_title: "Reduce Empty Trips. Boost Load Factor. Go Greener.",
        hero_sub: "Smart Load Analyzer helps freight companies analyze and optimize loads to reduce cost and emissions.",
        tag_fuel: "fuel reduction (simulated)",
        tag_ai: "load & route suggestions",
        hero_highlight: "This demo scenario shows how merging a new shipment with a low-load return trip improves load factor.",
        hero_avg_before_title: "Avg load (baseline)",
        hero_cost_title: "Op. cost / day",
        hero_co2_title: "CO‚ÇÇ / day",

        tab_login: "Login / Sign up",
        tab_dashboard: "Dashboard",
        tab_analyze: "Analyze Load",
        tab_opt: "Optimization Result",

        login_title: "Company Login",
        login_sub: "Access your Smart Load Analyzer workspace.",
        label_email: "Company email",
        label_password: "Password",
        login_btn: "Login",
        login_hint: "Demo credentials: demo@logixperts.sa / Naqlthon4!",

        signup_title: "Create Company Account",
        signup_sub: "Create your company account to access the system.",
        signup_label_name: "Company name",
        signup_label_email: "Company email",
        signup_label_pass: "Password",
        signup_label_fleet: "Fleet size (trucks)",
        signup_label_plan: "Subscription plan",
        signup_btn: "Sign up",

        dash_title: "Fleet Overview Dashboard",
        dash_sub: "4 demo trucks on main corridors.",
        kpi_trucks_label: "Trucks in scenario",
        kpi_baseline_label: "Avg load (baseline)",
        kpi_baseline_note: "Before optimization",
        kpi_after_label: "Avg load (after)",
        kpi_after_note: "After last run",
        kpi_cost_before_label: "Op. cost / day",
        kpi_cost_before_note: "Simulated SAR",
        kpi_cost_after_label: "Op. cost / day (after)",
        kpi_co2_before_label: "CO‚ÇÇ / day",
        kpi_co2_before_note: "kg CO‚ÇÇ",
        kpi_co2_after_label: "CO‚ÇÇ / day (after)",

        stats_label_load: "Company avg load (%)",
        stats_label_cost: "Company op. cost / day (SAR)",
        stats_label_co2: "Company CO‚ÇÇ / day (kg)",

        map_title: "Truck Positions & Routes",
        map_sub: "Best routes + load factor markers.",

        analyze_title: "Analyze New Shipment (Manual)",
        analyze_sub: "Enter shipment details manually.",
        label_weight: "Weight (tons)",
        label_volume: "Volume (m¬≥)",
        label_destination: "Destination city",
        label_delivery: "Delivery window",
        label_priority: "Priority",
        btn_manual_analyze: "Run Manual Optimization",

        csv_title: "Upload Your Trips CSV",
        csv_sub: "Upload trip history to improve optimization accuracy.",
        csv_label: "Choose CSV file",
        btn_csv: "Analyze CSV",

        pdf_title: "PDF AI Report",
        pdf_sub: "Generate a printable KPI report for your company based on the current demo optimization.",
        pdf_hint: "This is a demo PDF report for Naqlthon showing KPIs, per-truck loads and recommendations for small carriers.",
        pdf_btn: "Generate PDF Report",

        opt_title: "Optimization Result",
        opt_sub: "Recommended load distribution.",
        opt_col_truck: "Truck & Route",
        opt_col_load: "Load Factor",
        opt_col_ai: "AI Suggestion",

        chart_title: "KPIs Before vs After",
        chart_sub: "Avg Load, Cost, CO‚ÇÇ comparison",

        support_title: "Customer Support",
        support_phone_label: "Phone:",
        support_email_label: "Email:",
        support_fax_label: "Fax:"
      },
      ar: {
        text_brand: "ŸÑŸàÔ≠¨ŸäŸÉÿ≥ÿ®ÿ±ÿ™ÿ≥",
        text_subbrand: "ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∞ŸÉŸä",
        back_link: "‚Üê ÿ±ÿ¨Ÿàÿπ ŸÑÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿØŸàÿ±",
        company_code_label: "ŸÉŸàÿØ ÿßŸÑÿ¥ÿ±ŸÉÿ©:",
        team_label: "ÿßŸÑŸÅÿ±ŸäŸÇ:",
        team_event: "ŸÜŸÇŸÑÿ´ŸàŸÜ 4",

        hero_title: "ŸÇŸÑŸÑ ÿßŸÑÿ±ÿ≠ŸÑÿßÿ™ ÿßŸÑŸÅÿßÿ±ÿ∫ÿ©. ÿßÿ±ŸÅÿπ ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ. ŸàŸÉŸÜ ÿ£ŸÉÿ´ÿ± ÿßÿ≥ÿ™ÿØÿßŸÖÿ©.",
        hero_sub: "ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∞ŸÉŸä Ÿäÿ≥ÿßÿπÿØ ÿ¥ÿ±ŸÉÿßÿ™ ÿßŸÑŸÜŸÇŸÑ ÿπŸÑŸâ ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±ÿ≠ŸÑÿßÿ™ Ÿàÿ™ÿ≠ÿ≥ŸäŸÜ ÿßÿ≥ÿ™ÿ∫ŸÑÿßŸÑ ÿßŸÑÿ≠ŸÖŸàŸÑÿ© ŸÑÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ŸàÿßŸÑÿßŸÜÿ®ÿπÿßÿ´ÿßÿ™.",
        tag_fuel: "ÿ™ÿÆŸÅŸäÿ∂ ÿßÿ≥ÿ™ŸáŸÑÿßŸÉ ÿßŸÑŸàŸÇŸàÿØ (ŸÖÿ≠ÿßŸÉÿßÿ©)",
        tag_ai: "ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ™ÿ≠ŸÖŸäŸÑ ŸàŸÖÿ≥ÿßÿ±ÿßÿ™ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
        hero_highlight: "Ÿáÿ∞ÿß ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ŸäŸàÿ∂ÿ≠ ŸÉŸäŸÅ ŸäŸÖŸÉŸÜ ŸÑÿØŸÖÿ¨ ÿ¥ÿ≠ŸÜÿ© ÿ¨ÿØŸäÿØÿ© ŸÖÿπ ÿ±ÿ≠ŸÑÿ© ÿπŸàÿØÿ© ŸÖŸÜÿÆŸÅÿ∂ÿ© ÿßŸÑÿ≠ŸÖŸàŸÑÿ© ÿ£ŸÜ Ÿäÿ≠ÿ≥ŸÜ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ.",
        hero_avg_before_title: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ (ÿßŸÑÿ£ÿ≥ÿßÿ≥)",
        hero_cost_title: "ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ / ÿßŸÑŸäŸàŸÖ",
        hero_co2_title: "ÿßŸÜÿ®ÿπÿßÿ´ÿßÿ™ CO‚ÇÇ / ÿßŸÑŸäŸàŸÖ",

        tab_login: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ / ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
        tab_dashboard: "ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿ§ÿ¥ÿ±ÿßÿ™",
        tab_analyze: "ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ",
        tab_opt: "ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜ",

        login_title: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©",
        login_sub: "ÿßÿØÿÆŸÑ ÿ•ŸÑŸâ ŸÖÿ≥ÿßÿ≠ÿ© ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∞ŸÉŸä.",
        label_email: "ÿ•ŸäŸÖŸäŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©",
        label_password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
        login_btn: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
        login_hint: "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿ±ÿ∂: demo@logixperts.sa / Naqlthon4!",

        signup_title: "ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¥ÿ±ŸÉÿ©",
        signup_sub: "ÿ£ŸÜÿ¥ÿ¶ ÿ≠ÿ≥ÿßÿ® ÿ¥ÿ±ŸÉÿ™ŸÉ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÜÿ∏ÿßŸÖ.",
        signup_label_name: "ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ©",
        signup_label_email: "ÿ•ŸäŸÖŸäŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©",
        signup_label_pass: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
        signup_label_fleet: "ÿπÿØÿØ ÿßŸÑÿ¥ÿßÿ≠ŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ£ÿ≥ÿ∑ŸàŸÑ",
        signup_label_plan: "ÿÆÿ∑ÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ",
        signup_btn: "ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",

        dash_title: "ŸÑŸàÿ≠ÿ© ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ∑ŸàŸÑ",
        dash_sub: "4 ÿ¥ÿßÿ≠ŸÜÿßÿ™ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿßÿ±ÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©.",
        kpi_trucks_label: "ÿßŸÑÿ¥ÿßÿ≠ŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ŸäŸÜÿßÿ±ŸäŸà",
        kpi_baseline_label: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ (ÿßŸÑÿ£ÿ≥ÿßÿ≥)",
        kpi_baseline_note: "ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜ",
        kpi_after_label: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ (ÿ®ÿπÿØ)",
        kpi_after_note: "ÿ®ÿπÿØ ÿ¢ÿÆÿ± ÿ™ÿ¥ÿ∫ŸäŸÑ",
        kpi_cost_before_label: "ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ / ÿßŸÑŸäŸàŸÖ",
        kpi_cost_before_note: "ÿ±ŸäÿßŸÑ (ŸÖÿ≠ÿßŸÉÿßÿ©)",
        kpi_cost_after_label: "ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ / ÿßŸÑŸäŸàŸÖ (ÿ®ÿπÿØ)",
        kpi_co2_before_label: "ÿßŸÜÿ®ÿπÿßÿ´ÿßÿ™ CO‚ÇÇ / ÿßŸÑŸäŸàŸÖ",
        kpi_co2_before_note: "ŸÉÿ¨ŸÖ CO‚ÇÇ",
        kpi_co2_after_label: "ÿßŸÜÿ®ÿπÿßÿ´ÿßÿ™ CO‚ÇÇ / ÿßŸÑŸäŸàŸÖ (ÿ®ÿπÿØ)",

        stats_label_load: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ŸÅŸä ÿßŸÑÿ¥ÿ±ŸÉÿ© (%)",
        stats_label_cost: "ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸäŸàŸÖŸäÿ© (ÿ±ŸäÿßŸÑ)",
        stats_label_co2: "ÿßŸÜÿ®ÿπÿßÿ´ÿßÿ™ CO‚ÇÇ ÿßŸÑŸäŸàŸÖŸäÿ© (ŸÉÿ¨ŸÖ)",

        map_title: "ŸÖŸàÿßŸÇÿπ ŸàŸÖÿ≥ÿßÿ±ÿßÿ™ ÿßŸÑÿ¥ÿßÿ≠ŸÜÿßÿ™",
        map_sub: "ÿ£ŸÅÿ∂ŸÑ ÿßŸÑŸÖÿ≥ÿßÿ±ÿßÿ™ + ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ŸÜÿ≥ÿ® ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ.",

        analyze_title: "ÿ™ÿ≠ŸÑŸäŸÑ ÿ¥ÿ≠ŸÜÿ© ÿ¨ÿØŸäÿØÿ© (ŸäÿØŸàŸä)",
        analyze_sub: "ÿ£ÿØÿÆŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿ≠ŸÜÿ© ŸäÿØŸàŸäŸãÿß.",
        label_weight: "ÿßŸÑŸàÿ≤ŸÜ (ÿ∑ŸÜ)",
        label_volume: "ÿßŸÑÿ≠ÿ¨ŸÖ (ŸÖ¬≥)",
        label_destination: "ŸÖÿØŸäŸÜÿ© ÿßŸÑŸàÿ¨Ÿáÿ©",
        label_delivery: "ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ",
        label_priority: "ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©",
        btn_manual_analyze: "ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑŸäÿØŸàŸä",

        csv_title: "ÿ±ŸÅÿπ ŸÖŸÑŸÅ CSV ŸÑŸÑÿ±ÿ≠ŸÑÿßÿ™",
        csv_sub: "ÿßÿ±ŸÅÿπ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ±ÿ≠ŸÑÿßÿ™ ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ÿØŸÇÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ.",
        csv_label: "ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ CSV",
        btn_csv: "ÿ™ÿ≠ŸÑŸäŸÑ ŸÖŸÑŸÅ CSV",

        pdf_title: "ÿ™ŸÇÿ±Ÿäÿ± PDF ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
        pdf_sub: "ÿ•ŸÜÿ¥ÿßÿ° ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ∑ÿ®ÿßÿπÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ¢ÿÆÿ± ÿπŸÖŸÑŸäÿ© ÿ™ÿ≠ÿ≥ŸäŸÜ.",
        pdf_hint: "Ÿáÿ∞ÿß ÿ™ŸÇÿ±Ÿäÿ± ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ŸÑŸÜŸÇŸÑÿ´ŸàŸÜ ŸäŸàÿ∂ÿ≠ ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ°ÿå ŸÜÿ≥ÿ® ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ŸÑŸÉŸÑ ÿ¥ÿßÿ≠ŸÜÿ© Ÿàÿ™ŸàÿµŸäÿßÿ™ ŸÑŸÑÿ¥ÿ±ŸÉÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ©.",
        pdf_btn: "ÿ•ŸÜÿ¥ÿßÿ° ÿ™ŸÇÿ±Ÿäÿ± PDF",

        opt_title: "ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜ",
        opt_sub: "ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ≠ŸÖŸàŸÑÿ© ÿßŸÑŸÖŸàÿµŸâ ÿ®Ÿá.",
        opt_col_truck: "ÿßŸÑÿ¥ÿßÿ≠ŸÜÿ© ŸàÿßŸÑŸÖÿ≥ÿßÿ±",
        opt_col_load: "ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ",
        opt_col_ai: "ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",

        chart_title: "ÿßŸÑŸÖÿ§ÿ¥ÿ±ÿßÿ™ ŸÇÿ®ŸÑ Ÿàÿ®ÿπÿØ",
        chart_sub: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑÿå ÿßŸÑÿ™ŸÉŸÑŸÅÿ©ÿå ŸàÿßŸÜÿ®ÿπÿßÿ´ÿßÿ™ CO‚ÇÇ",

        support_title: "ÿØÿπŸÖ ÿßŸÑÿπŸÖŸÑÿßÿ°",
        support_phone_label: "ÿßŸÑŸáÿßÿ™ŸÅ:",
        support_email_label: "ÿßŸÑÿ•ŸäŸÖŸäŸÑ:",
        support_fax_label: "ŸÅÿßŸÉÿ≥:"
      }
    };

    function applyLanguage() {
      const t = translations[currentLang] || translations.en;
      for (const key in t) {
        const el = document.getElementById(key);
        if (el) el.textContent = t[key];
      }

      const langBtn = document.getElementById("langSwitcher");
      if (langBtn) langBtn.textContent = currentLang === "en" ? "AR" : "EN";

      document.documentElement.lang = currentLang === "ar" ? "ar" : "en";
      document.documentElement.dir  = currentLang === "ar" ? "rtl" : "ltr";
    }

    function toggleLanguage() {
      currentLang = currentLang === "en" ? "ar" : "en";
      applyLanguage();
    }

    // ========== SCENARIO & GLOBAL STATE ==========
    const CAPACITY_TONS = 20;
    const BASE_TRIP_COST = 1000;
    const EMISSION_FACTOR = 2.7;

    const trucksScenario = [
      { id: "Truck #1", origin: "Riyadh", dest: "Jeddah",  currentLoad: 0.75, coords: [24.7136, 46.6753] },
      { id: "Truck #2", origin: "Jeddah", dest: "Riyadh",  currentLoad: 0.40, coords: [21.4858, 39.1925] },
      { id: "Truck #3", origin: "Riyadh", dest: "Dammam", currentLoad: 0.65, coords: [24.7136, 46.6753] },
      { id: "Truck #4", origin: "Dammam", dest: "Riyadh", currentLoad: 0.50, coords: [26.4207, 50.0888] },
    ];

    let baselineAvgLoad =
      trucksScenario.reduce((sum, t) => sum + t.currentLoad, 0) / trucksScenario.length;
    let baselineCost = trucksScenario.length * BASE_TRIP_COST;
    let baselineCO2  = baselineCost * EMISSION_FACTOR;

    let isLoggedIn = false;
    let currentCompanyId = null;
    let currentCompanyData = null;
    let companyStats = null;

    // ÿ¢ÿÆÿ± ŸÜÿ™Ÿäÿ¨ÿ© ÿ™ÿ≠ÿ≥ŸäŸÜ (ÿπÿ¥ÿßŸÜ ÿ¨ÿØŸàŸÑ ÿßŸÑÿ¥ÿßÿ≠ŸÜÿßÿ™ + PDF + ÿßŸÑÿ±ÿ≥ŸÖ)
    let lastOptimizationLoads = null;
    let lastAfterAvgLoad = null;
    let lastCostAfter = null;
    let lastCO2After = null;

    let optChart = null;
    let mapInstance = null;

    // ========== UI HELPERS ==========
    function setActiveView(viewId) {
      const views = document.querySelectorAll(".view");
      views.forEach(v => v.classList.remove("active"));
      const target = document.getElementById(viewId);
      if (target) target.classList.add("active");

      const tabs = document.querySelectorAll(".nav-tab");
      tabs.forEach(tab => {
        if (tab.dataset.view === viewId) tab.classList.add("active");
        else tab.classList.remove("active");
      });

      // ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÉŸÑ ŸÖÿß ŸÜÿØÿÆŸÑ ÿπŸÑŸâ ÿßŸÑÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ
      if (viewId === "dashboard-view" && mapInstance) {
        setTimeout(() => mapInstance.invalidateSize(), 200);
      }
    }

    function togglePassword(inputId, btn) {
      const input = document.getElementById(inputId);
      if (!input) return;
      if (input.type === "password") {
        input.type = "text";
        btn.textContent = currentLang === "ar" ? "ÿ•ÿÆŸÅÿßÿ°" : "Hide";
      } else {
        input.type = "password";
        btn.textContent = currentLang === "ar" ? "ÿ•ÿ∏Ÿáÿßÿ±" : "Show";
      }
    }

    function updateHeroAndKpisFromStats() {
      const heroLoad = document.getElementById("hero-load-before");
      const heroCost = document.getElementById("hero-cost-before");
      const heroCO2  = document.getElementById("hero-co2-before");

      const kpiLoadBefore = document.getElementById("kpi-load-before");
      const kpiCostBefore = document.getElementById("kpi-cost-before");
      const kpiCO2Before  = document.getElementById("kpi-co2-before");

      const baseLoadPct = (baselineAvgLoad * 100).toFixed(0);

      if (heroLoad) heroLoad.textContent = baseLoadPct + "%";
      if (heroCost) heroCost.textContent = "~" + baselineCost.toFixed(0) + " SAR";
      if (heroCO2)  heroCO2.textContent  = "~" + baselineCO2.toFixed(0) + " kg";

      if (kpiLoadBefore) kpiLoadBefore.textContent = baseLoadPct + "%";
      if (kpiCostBefore) kpiCostBefore.textContent = "~" + baselineCost.toFixed(0) + " SAR";
      if (kpiCO2Before)  kpiCO2Before.textContent  = "~" + baselineCO2.toFixed(0) + " kg";
    }

    // ========== FIREBASE: AUTH & COMPANY ==========
    async function loadCompanyData(uid) {
      const ref = doc(db, "companies", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        currentCompanyData = snap.data();
        if (currentCompanyData.stats) {
          companyStats = currentCompanyData.stats;
          const { loadPct, costPerDay, co2PerDay } = companyStats;

          if (loadPct && !isNaN(loadPct)) baselineAvgLoad = loadPct / 100;
          if (costPerDay && !isNaN(costPerDay)) baselineCost = costPerDay;
          if (co2PerDay && !isNaN(co2PerDay)) baselineCO2 = co2PerDay;
        }
      } else {
        currentCompanyData = { name: "Logixperts", email: "demo@logixperts.sa" };
      }

      updateHeroAndKpisFromStats();

      const badge = document.getElementById("company_code_badge");
      const codeValue = document.getElementById("company_code_value");
      if (badge && codeValue) {
        badge.style.display = "inline-flex";
        codeValue.textContent = uid.slice(-6).toUpperCase();
      }
    }

    function enableTabsAfterLogin() {
      document.getElementById("tab_dashboard").style.display = "inline-flex";
      document.getElementById("tab_analyze").style.display   = "inline-flex";
      document.getElementById("tab_opt").style.display       = "inline-flex";
    }

    async function handleAuthSuccess(user) {
      isLoggedIn = true;
      currentCompanyId = user.uid;

      const loginError = document.getElementById("login-error");
      if (loginError) loginError.textContent = "";

      await loadCompanyData(user.uid);
      enableTabsAfterLogin();
      setActiveView("dashboard-view");
    }

    async function demoLogin() {
      const email = document.getElementById("company").value.trim();
      const pass  = document.getElementById("password").value.trim();
      const error = document.getElementById("login-error");

      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await handleAuthSuccess(cred.user);
      } catch (e) {
        console.error(e);
        if (error) {
          error.textContent =
            currentLang === "ar"
              ? "ÿ™ÿπÿ∞ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ•ŸäŸÖŸäŸÑ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±."
              : "Login failed. Please check your email and password.";
        }
      }
    }

    async function signUp() {
      const name  = document.getElementById("signup-name").value.trim();
      const email = document.getElementById("signup-email").value.trim();
      const pass  = document.getElementById("signup-password").value.trim();
      const fleet = parseInt(document.getElementById("signup-fleet").value || "0", 10);
      const plan  = document.getElementById("signup-plan").value;
      const msg   = document.getElementById("signup-message");

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const uid = cred.user.uid;

        const ref = doc(db, "companies", uid);
        await setDoc(ref, {
          name,
          email,
          fleetSize: fleet || 0,
          plan,
          createdAt: serverTimestamp()
        });

        currentCompanyData = { name, email, fleetSize: fleet, plan };
        await handleAuthSuccess(cred.user);

        if (msg) {
          msg.textContent =
            currentLang === "ar"
              ? "ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠ Ÿàÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ."
              : "Account created and logged in successfully.";
        }
      } catch (e) {
        console.error(e);
        if (msg) {
          msg.textContent =
            currentLang === "ar"
              ? "ÿ™ÿπÿ∞ÿ± ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ•ŸäŸÖŸäŸÑ ŸàŸÇŸàÿ© ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±."
              : "Could not create account. Please check email and password strength.";
        }
      }
    }

    async function saveCompanyStats() {
      if (!isLoggedIn || !currentCompanyId) return;

      const loadInput = document.getElementById("stats-load");
      const costInput = document.getElementById("stats-cost");
      const co2Input  = document.getElementById("stats-co2");
      const hint      = document.getElementById("stats_hint");

      const loadPct   = parseFloat(loadInput.value || "0");
      const costPerDay = parseFloat(costInput.value || "0");
      const co2PerDay  = parseFloat(co2Input.value || "0");

      if (isNaN(loadPct) || isNaN(costPerDay) || isNaN(co2PerDay) ||
          loadPct < 0 || loadPct > 100) {
        if (hint) {
          hint.textContent =
            currentLang === "ar"
              ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÇŸäŸÖ ÿµÿ≠Ÿäÿ≠ÿ© (ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäŸÜ 0 Ÿà 100)."
              : "Please enter valid values (load between 0 and 100).";
        }
        return;
      }

      companyStats = { loadPct, costPerDay, co2PerDay };

      baselineAvgLoad = loadPct / 100;
      baselineCost = costPerDay;
      baselineCO2  = co2PerDay;

      updateHeroAndKpisFromStats();

      const ref = doc(db, "companies", currentCompanyId);
      await setDoc(ref, { stats: companyStats }, { merge: true });

      if (hint) {
        hint.textContent =
          currentLang === "ar"
            ? "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿ®ŸÜÿ¨ÿßÿ≠."
            : "Company metrics saved successfully.";
      }

      if (lastAfterAvgLoad != null) {
        updateCharts(lastAfterAvgLoad, lastCostAfter ?? baselineCost, lastCO2After ?? baselineCO2);
      }
    }

    async function saveOptimizationResult(companyId, data) {
      try {
        const ref = collection(db, "companies", companyId, "optimizations");
        await addDoc(ref, {
          ...data,
          createdAt: serverTimestamp()
        });
      } catch (e) {
        console.error("Error saving optimization result:", e);
      }
    }

    // ========== CHARTS ==========
    function initChart(afterAvgLoad, costAfter, co2After) {
      const canvas = document.getElementById("optChart");
      if (!canvas) return;
      const ctxOpt  = canvas.getContext("2d");

      const beforeLoadPct = baselineAvgLoad * 100;
      const afterLoadPct  = afterAvgLoad * 100;

      optChart = new Chart(ctxOpt, {
        type: "bar",
        data: {
          labels: ["Avg Load (%)", "Cost / day", "CO‚ÇÇ / day"],
          datasets: [
            {
              label: "Before",
              data: [beforeLoadPct, baselineCost, baselineCO2]
            },
            {
              label: "After",
              data: [afterLoadPct, costAfter, co2After]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "top",
              labels: {
                color: "#e5e7eb",
                font: { size: 11 }
              }
            }
          },
          scales: {
            x: {
              ticks: { color: "#9ca3af" },
              grid: { display: false }
            },
            y: {
              ticks: { color: "#9ca3af" },
              grid: { color: "#1f2937" }
            }
          }
        }
      });
    }

    function updateCharts(afterAvgLoad, costAfter, co2After) {
      if (!optChart) {
        initChart(afterAvgLoad, costAfter, co2After);
        return;
      }

      const beforeLoadPct = baselineAvgLoad * 100;
      const afterLoadPct  = afterAvgLoad * 100;

      optChart.data.datasets[0].data = [beforeLoadPct, baselineCost, baselineCO2];
      optChart.data.datasets[1].data = [afterLoadPct, costAfter, co2After];
      optChart.update();
    }

    // ========== MAP ==========
    function initMap() {
      if (mapInstance || !window.L) return;
      const center = [23.8859, 45.0792];
      mapInstance = L.map("map").setView(center, 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18
      }).addTo(mapInstance);

      const cityCoords = {
        Riyadh: [24.7136, 46.6753],
        Jeddah: [21.4858, 39.1925],
        Dammam: [26.4207, 50.0888]
      };

      const markerStyle = { radius: 7 };

      function addCityMarker(name, coord, color) {
        L.circleMarker(coord, { ...markerStyle, color, fillColor: color, fillOpacity: 0.8 })
          .addTo(mapInstance)
          .bindTooltip(name, { permanent: false });
      }

      addCityMarker("Riyadh",  cityCoords.Riyadh,  "#22c55e");
      addCityMarker("Jeddah",  cityCoords.Jeddah,  "#fbbf24");
      addCityMarker("Dammam",  cityCoords.Dammam,  "#3b82f6");

      const riyadh = cityCoords.Riyadh;
      const jeddah = cityCoords.Jeddah;
      const dammam = cityCoords.Dammam;

      L.polyline([riyadh, jeddah], { weight: 2 }).addTo(mapInstance);
      L.polyline([riyadh, dammam], { weight: 2 }).addTo(mapInstance);

      // ÿ•ÿµŸÑÿßÿ≠ ÿ≠ÿ¨ŸÖ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿ®ÿπÿØ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°
      setTimeout(() => {
        if (mapInstance) mapInstance.invalidateSize();
      }, 200);
    }

    // ========== OPTIMIZATION TABLE ==========
    function clearTruckRows() {
      const list = document.getElementById("truck-list");
      if (!list) return;
      const rows = Array.from(list.querySelectorAll(".truck-row"));
      rows.forEach(row => {
        if (!row.classList.contains("header")) list.removeChild(row);
      });
    }

    function addTruckRow(truck, loadText, chipText, chipClass) {
      const list = document.getElementById("truck-list");
      if (!list) return;

      const row = document.createElement("div");
      row.className = "truck-row";

      const col1 = document.createElement("div");
      col1.textContent = `${truck.id} ${truck.origin} ‚Üí ${truck.dest}`;

      const col2 = document.createElement("div");
      col2.textContent = loadText;

      const col3 = document.createElement("div");
      const chip = document.createElement("span");
      chip.className = "chip " + chipClass;
      chip.textContent = chipText;
      col3.appendChild(chip);

      row.appendChild(col1);
      row.appendChild(col2);
      row.appendChild(col3);

      list.appendChild(row);
    }

    function populateOptimizationTableInitial() {
      clearTruckRows();
      trucksScenario.forEach(tr => {
        const loadPct = (tr.currentLoad * 100).toFixed(0) + "%";
        const chipText =
          tr.currentLoad < 0.6
            ? (currentLang === "ar" ? "ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜÿÆŸÅÿ∂ (ŸÅÿ±ÿµÿ© ÿØŸÖÿ¨)" : "Low load (merge opportunity)")
            : (currentLang === "ar" ? "ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸäÿØ" : "Healthy load");
        const chipClass = tr.currentLoad < 0.6 ? "warn" : "good";
        addTruckRow(tr, loadPct, chipText, chipClass);
      });
    }

    function populateOptimizationTable(trucks, suggestionById) {
      clearTruckRows();
      trucks.forEach(tr => {
        const loads = suggestionById[tr.id];
        const loadPct = ((loads?.newLoad ?? tr.currentLoad) * 100).toFixed(0) + "%";

        let chipText;
        let chipClass;

        if (loads && loads.action) {
          chipText = loads.action;
          chipClass = "good";
        } else {
          chipText =
            currentLang === "ar"
              ? "ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ± ŸÅŸä ÿßŸÑÿÆÿ∑ÿ©"
              : "Keep current plan";
          chipClass = "warn";
        }

        addTruckRow(tr, loadPct, chipText, chipClass);
      });
    }

    // ========== RUN OPTIMIZATION ==========
    async function runOptimization() {
      if (!isLoggedIn) {
        const msg = document.getElementById("opt-summary");
        if (msg) {
          msg.textContent =
            currentLang === "ar"
              ? "Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ÿ´ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜ."
              : "Please log in first, then run optimization.";
        }
        setActiveView("login-view");
        return;
      }

      const weight = parseFloat(document.getElementById("weight").value || "0");
      const volume = parseFloat(document.getElementById("volume").value || "0");
      let destinationInput = (document.getElementById("destination").value || "").toLowerCase();
      const priority = document.getElementById("priority").value;

      const trucks = trucksScenario.map(t => ({ ...t }));

      let destKey = destinationInput.trim();
      if (!destKey) destKey = "riyadh";

      let inbound = trucks.filter(t => t.dest.toLowerCase().includes(destKey));
      if (inbound.length === 0) {
        inbound = trucks.filter(t => t.dest.toLowerCase() === "riyadh");
      }

      let target = inbound[0];
      inbound.forEach(t => {
        if (priority === "high") {
          const diffT = Math.abs(t.currentLoad - 0.6);
          const diffCurrent = Math.abs(target.currentLoad - 0.6);
          if (diffT < diffCurrent) target = t;
        } else {
          if (t.currentLoad < target.currentLoad) target = t;
        }
      });

      const existingTons = target.currentLoad * CAPACITY_TONS;
      const addedTons = isNaN(weight) ? 0 : weight;
      const newTotalTons = existingTons + addedTons;
      const newLoadFactor = Math.min(1, newTotalTons / CAPACITY_TONS);
      target.newLoad = newLoadFactor;

      trucks.forEach(t => {
        if (t.id !== target.id) t.newLoad = t.currentLoad;
      });

      const afterAvgLoad =
        trucks.reduce((sum, t) => sum + t.newLoad, 0) / trucks.length;

      const costAfter = baselineCost * (baselineAvgLoad / afterAvgLoad);
      const co2After = baselineCO2 * (costAfter / baselineCost);

      lastAfterAvgLoad = afterAvgLoad;
      lastCostAfter = costAfter;
      lastCO2After = co2After;

      const loadAfterPct = (afterAvgLoad * 100).toFixed(0) + "%";
      document.getElementById("kpi-load-after").textContent = loadAfterPct;

      document.getElementById("kpi-cost-after").textContent = "~" + costAfter.toFixed(0) + " SAR";
      const costSavePct = ((baselineCost - costAfter) / baselineCost) * 100;
      document.getElementById("kpi-cost-savings").textContent =
        costSavePct > 0
          ? `-${costSavePct.toFixed(1)}% vs baseline`
          : (currentLang === "ar" ? "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ŸàŸÅŸäÿ±" : "No savings");

      document.getElementById("kpi-co2-after").textContent = "~" + co2After.toFixed(0) + " kg";
      const co2SavePct = ((baselineCO2 - co2After) / baselineCO2) * 100;
      document.getElementById("kpi-co2-savings").textContent =
        co2SavePct > 0
          ? `-${co2SavePct.toFixed(1)}% vs baseline`
          : (currentLang === "ar" ? "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ŸàŸÅŸäÿ±" : "No savings");

      updateCharts(afterAvgLoad, costAfter, co2After);

      const suggestionById = {};
      suggestionById[target.id] = {
        truck: target,
        newLoad: newLoadFactor,
        action: currentLang === "ar"
          ? "ÿØŸÖÿ¨ ÿßŸÑÿ¥ÿ≠ŸÜÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÖÿπ ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿπŸàÿØÿ©"
          : "Merge new shipment with return trip",
      };
      populateOptimizationTable(trucks, suggestionById);

      const summary = document.getElementById("opt-summary");
      if (currentLang === "ar") {
        summary.innerHTML =
          `ÿ™ŸÖ ÿ•ÿ≥ŸÜÿßÿØ ÿ¥ÿ≠ŸÜÿ© Ÿàÿ≤ŸÜ <strong>${weight || 0} ÿ∑ŸÜ</strong> ` +
          `Ÿàÿ≠ÿ¨ŸÖ <strong>${volume || 0} ŸÖ¬≥</strong> ÿ•ŸÑŸâ ` +
          `<strong>${target.id} (${target.origin} ‚Üí ${target.dest})</strong>ÿå ` +
          `ŸÖŸÖÿß Ÿäÿ±ŸÅÿπ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ≠ŸÖŸàŸÑÿ© ŸÖŸÜ <strong>${(baselineAvgLoad * 100).toFixed(0)}%</strong> ` +
          `ÿ•ŸÑŸâ <strong>${(afterAvgLoad * 100).toFixed(0)}%</strong>ÿå ` +
          `ŸÖÿπ ÿ™ŸÇŸÑŸäŸÑ ÿ™ŸÇÿ±Ÿäÿ®Ÿä ŸÅŸä ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿ®ŸÜÿ≥ÿ®ÿ© <strong>${Math.abs(costSavePct).toFixed(1)}%</strong> ` +
          `ŸàÿßŸÜÿ®ÿπÿßÿ´ÿßÿ™ CO‚ÇÇ ÿ®ŸÜÿ≥ÿ®ÿ© <strong>${Math.abs(co2SavePct).toFixed(1)}%</strong>.`;
      } else {
        summary.innerHTML =
          `The new shipment of <strong>${weight || 0} tons</strong> / ` +
          `<strong>${volume || 0} m¬≥</strong> is assigned to ` +
          `<strong>${target.id} (${target.origin} ‚Üí ${target.dest})</strong>, ` +
          `raising average fleet load from <strong>${(baselineAvgLoad * 100).toFixed(0)}%</strong> ` +
          `to <strong>${(afterAvgLoad * 100).toFixed(0)}%</strong>, ` +
          `with an estimated reduction of <strong>${Math.abs(costSavePct).toFixed(1)}%</strong> ` +
          `in operating cost and <strong>${Math.abs(co2SavePct).toFixed(1)}%</strong> in CO‚ÇÇ emissions.`;
      }

      // ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÇŸäŸÖ ŸÑŸÉŸÑ ÿ¥ÿßÿ≠ŸÜÿ© ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸáÿß ŸÅŸä ÿ™ŸÇÿ±Ÿäÿ± PDF
      lastOptimizationLoads = {};
      trucks.forEach(t => {
        lastOptimizationLoads[t.id] = {
          before: t.currentLoad,
          after: t.newLoad
        };
      });

      if (currentCompanyId) {
        await saveOptimizationResult(currentCompanyId, {
          shipmentWeight: weight || 0,
          shipmentVolume: volume || 0,
          destination: destinationInput || "",
          priority,
          assignedTruckId: target.id,
          assignedRoute: `${target.origin} ‚Üí ${target.dest}`,
          baselineAvgLoad,
          afterAvgLoad,
          baselineCost,
          costAfter,
          baselineCO2,
          co2After
        });
      }

      setActiveView("optimization-view");
    }

    // ========== CSV (ÿ®ÿ≥Ÿäÿ∑ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä) ==========
    function analyzeCSV() {
      const fileInput = document.getElementById("csv_file");
      const msg = document.getElementById("csv_message");
      if (!fileInput.files || fileInput.files.length === 0) {
        if (msg) {
          msg.textContent =
            currentLang === "ar"
              ? "Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ CSV ÿ£ŸàŸÑÿßŸã."
              : "Please select a CSV file first.";
        }
        return;
      }

      if (msg) {
        msg.textContent =
          currentLang === "ar"
            ? "ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠ (ÿ™ÿ≠ŸÑŸäŸÑ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ŸÑŸÑÿπÿ±ÿ∂ ŸÅŸÇÿ∑)."
            : "CSV file uploaded successfully (demo analysis only).";
      }
    }

    // ========== PDF REPORT ==========
    function generatePdfReport() {
      const msg = document.getElementById("pdf_message");

      if (!isLoggedIn) {
        msg.textContent = currentLang === "ar"
          ? "Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ™ŸÇÿ±Ÿäÿ±."
          : "Please log in first to generate a report.";
        return;
      }

      try {
        const jsPDFConstructor = window.jsPDF;
        if (!jsPDFConstructor) {
          msg.textContent = currentLang === "ar"
            ? "ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÉÿ™ÿ®ÿ© ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÄ PDF (jsPDF)."
            : "Could not load the PDF library (jsPDF).";
          return;
        }

        const docPDF = new jsPDFConstructor();

        // HEADER
        docPDF.setFont("helvetica", "bold");
        docPDF.setFontSize(18);
        docPDF.text("Logixperts - Smart Load Analyzer", 10, 15);

        docPDF.setFontSize(11);
        docPDF.setFont("helvetica", "normal");
        docPDF.text("Naqlthon 4 - Smart Load Optimization Demo", 10, 22);

        const companyName  = (currentCompanyData && currentCompanyData.name)  || "Logixperts";
        const companyEmail = (currentCompanyData && currentCompanyData.email) || "demo@logixperts.sa";
        const fleetSize    = (currentCompanyData && currentCompanyData.fleetSize) || 25;
        const companyCode  = currentCompanyId || "LOGI693";

        const now = new Date();
        const generatedAt = now.toLocaleString();

        docPDF.setFont("helvetica", "bold");
        docPDF.text("Company:", 10, 32);
        docPDF.text("Contact:", 110, 32);

        docPDF.setFont("helvetica", "normal");
        docPDF.text(companyName, 35, 32);
        docPDF.text("Smart Load Analyzer / Logixperts", 135, 32);

        docPDF.setFont("helvetica", "bold");
        docPDF.text("Email:", 10, 38);
        docPDF.setFont("helvetica", "normal");
        docPDF.text(companyEmail, 35, 38);

        docPDF.setFont("helvetica", "bold");
        docPDF.text("Fleet size:", 10, 44);
        docPDF.setFont("helvetica", "normal");
        docPDF.text(String(fleetSize), 35, 44);

        docPDF.setFont("helvetica", "bold");
        docPDF.text("Company code:", 10, 50);
        docPDF.setFont("helvetica", "normal");
        docPDF.text(companyCode, 40, 50);

        docPDF.setFont("helvetica", "bold");
        docPDF.text("Phone:", 110, 38);
        docPDF.setFont("helvetica", "normal");
        docPDF.text("+966 55 555 5555", 135, 38);

        docPDF.setFont("helvetica", "bold");
        docPDF.text("Email:", 110, 44);
        docPDF.setFont("helvetica", "normal");
        docPDF.text("support@logixperts.com", 135, 44);

        docPDF.setFontSize(9);
        docPDF.setFont("helvetica", "normal");
        docPDF.text("Generated at: " + generatedAt, 10, 58);

        // SECTION 1: KPIs SUMMARY
        let y = 70;

        docPDF.setFontSize(13);
        docPDF.setFont("helvetica", "bold");
        docPDF.text("1. KPIs Summary (Before vs After Optimization)", 10, y);
        y += 8;

        docPDF.setFontSize(10);
        docPDF.setFont("helvetica", "bold");
        docPDF.text("Metric", 10, y);
        docPDF.text("Before", 80, y);
        docPDF.text("After", 120, y);
        docPDF.text("Savings", 160, y);
        docPDF.line(10, y + 2, 200, y + 2);
        y += 7;

        docPDF.setFont("helvetica", "normal");

        const avgBeforePct = (baselineAvgLoad * 100).toFixed(0);
        const avgAfterPct = (lastAfterAvgLoad != null
          ? (lastAfterAvgLoad * 100).toFixed(0)
          : avgBeforePct);

        const loadDeltaPP = (parseFloat(avgAfterPct) - parseFloat(avgBeforePct));

        const costBefore = baselineCost;
        const costAfter  = lastCostAfter != null ? lastCostAfter : costBefore;
        const costSavingsPct =
          costAfter < costBefore
            ? ((costBefore - costAfter) / costBefore) * 100
            : 0;

        const co2Before = baselineCO2;
        const co2After  = lastCO2After != null ? lastCO2After : co2Before;
        const co2SavingsPct =
          co2After < co2Before
            ? ((co2Before - co2After) / co2Before) * 100
            : 0;

        // Row 1: Average load
        docPDF.text("Average load factor (%)", 10, y);
        docPDF.text(avgBeforePct + "%", 80, y);
        docPDF.text(avgAfterPct + "%", 120, y);
        docPDF.text(loadDeltaPP.toFixed(1) + " pp", 160, y);
        y += 6;

        // Row 2: Operating cost per day
        docPDF.text("Operating cost per day", 10, y);
        docPDF.text("~" + costBefore.toFixed(0) + " SAR", 80, y);
        docPDF.text("~" + costAfter.toFixed(0) + " SAR", 120, y);
        docPDF.text(costSavingsPct.toFixed(1) + "%", 160, y);
        y += 6;

        // Row 3: CO2 per day
        docPDF.text("CO2 emissions per day", 10, y);
        docPDF.text("~" + co2Before.toFixed(0) + " kg", 80, y);
        docPDF.text("~" + co2After.toFixed(0) + " kg", 120, y);
        docPDF.text(co2SavingsPct.toFixed(1) + "%", 160, y);
        y += 10;

        // SECTION 2: PER-TRUCK LOAD FACTORS
        docPDF.setFontSize(13);
        docPDF.setFont("helvetica", "bold");
        docPDF.text("2. Per-Truck Load Factors", 10, y);
        y += 7;

        docPDF.setFontSize(10);
        docPDF.setFont("helvetica", "bold");
        docPDF.text("Truck / Route", 10, y);
        docPDF.text("Load Before", 80, y);
        docPDF.text("Load After", 140, y);
        docPDF.line(10, y + 2, 200, y + 2);
        y += 7;

        docPDF.setFont("helvetica", "normal");

        trucksScenario.forEach(tr => {
          const opt = lastOptimizationLoads && lastOptimizationLoads[tr.id];
          const beforeLoad = opt ? opt.before : tr.currentLoad;
          const afterLoad  = opt ? opt.after  : tr.currentLoad;

          const beforePct = (beforeLoad * 100).toFixed(0) + "%";
          const afterPct  = (afterLoad  * 100).toFixed(0) + "%";

          const label = `${tr.id} ${tr.origin}‚Üí${tr.dest}`;
          docPDF.text(label, 10, y);
          docPDF.text(beforePct, 80, y);
          docPDF.text(afterPct, 140, y);
          y += 6;
        });

        y += 8;

        // SECTION 3: RECOMMENDATIONS
        docPDF.setFontSize(13);
        docPDF.setFont("helvetica", "bold");
        docPDF.text("3. Recommendations for Small and Medium Carriers", 10, y);
        y += 7;

        docPDF.setFontSize(10);
        docPDF.setFont("helvetica", "normal");

        const recommendations = [
          "Start by focusing on return trips with low load factor (below 60%). Use them to bundle new shipments.",
          "Track your average fleet load every week. Aim to move it gradually from the current level towards 80%+.",
          "Use the system to simulate what-if scenarios before accepting new shipments, to avoid empty or half-empty runs.",
          "Prioritize routes where fuel and toll costs are high ‚Äì these gain the most from better load consolidation.",
          "Share simple monthly PDF reports like this with management and customers to demonstrate cost and CO2 savings."
        ];

        recommendations.forEach(line => {
          if (y > 270) {
            docPDF.addPage();
            y = 20;
          }
          docPDF.text("- " + line, 10, y);
          y += 5;
        });

        y += 6;
        docPDF.setFontSize(8);
        docPDF.text(
          "Note: This PDF is generated from a Naqlthon demo scenario. In a production version, an AI engine would use real trip data and KPIs.",
          10,
          y
        );

        docPDF.save("SmartLoad_Report_demo.pdf");

        msg.textContent = currentLang === "ar"
          ? "ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° Ÿàÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÇÿ±Ÿäÿ± PDF ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠."
          : "Demo PDF report generated and downloaded successfully.";
      } catch (e) {
        console.error(e);
        msg.textContent = currentLang === "ar"
          ? "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ ÿßŸÑŸÄ PDF."
          : "An error occurred while generating the PDF file.";
      }
    }

    // ========== INIT ==========
    window.addEventListener("load", () => {
      document.getElementById("tab_login").style.display = "inline-flex";
      document.getElementById("tab_dashboard").style.display = "none";
      document.getElementById("tab_analyze").style.display = "none";
      document.getElementById("tab_opt").style.display = "none";

      const statsSaveBtn = document.getElementById("stats-save-btn");
      if (statsSaveBtn) {
        statsSaveBtn.addEventListener("click", saveCompanyStats);
      }

      const tabs = document.querySelectorAll(".nav-tab");
      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          const view = tab.dataset.view;
          if (view !== "login-view" && !isLoggedIn) {
            setActiveView("login-view");
            const err = document.getElementById("login-error");
            if (err) {
              err.textContent =
                currentLang === "ar"
                  ? "Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ."
                  : "Please log in to access the dashboard.";
            }
            return;
          }
          setActiveView(view);
        });
      });

      applyLanguage();
      updateHeroAndKpisFromStats();
      populateOptimizationTableInitial();
      initMap();
    });

    // expose for HTML
    window.toggleLanguage = toggleLanguage;
    window.togglePassword = togglePassword;
    window.demoLogin = demoLogin;
    window.signUp = signUp;
    window.runOptimization = runOptimization;
    window.analyzeCSV = analyzeCSV;
    window.generatePdfReport = generatePdfReport;
  </script>
</body>
</html>
