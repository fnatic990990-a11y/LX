<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Logixperts - Smart Load Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --card: #111827;
      --accent: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .app {
      max-width: 1200px; width: 100%;
      background: #020617;
      border-radius: 32px;
      border: 1px solid #1f2937;
      padding: 20px 20px 26px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      display: flex; flex-direction: column; gap: 18px;
    }

    header {
      display: flex; justify-content: space-between; align-items: center;
      gap: 16px; padding: 10px 14px 6px;
      border-radius: 26px;
      background: radial-gradient(circle at left top, #22c55e20, #020617 55%);
      border: 1px solid #1f2937;
      flex-wrap: wrap;
    }

    .brand-group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand { display: flex; align-items: center; gap: 14px; }

    .badge-logo {
      width: 42px; height: 42px;
      border-radius: 18px;
      border: 1px solid #16a34a;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
      display: flex; align-items: center; justify-content: center;
      color: #ecfdf5; font-weight: 800; font-size: 18px;
      box-shadow: 0 10px 25px rgba(34,197,94,.55);
    }

    .brand-text h1 {
      font-size: 20px; font-weight: 800;
      letter-spacing: .06em; text-transform: uppercase;
    }

    .brand-text span {
      display:block; font-size:11px; color:var(--muted);
      text-transform:uppercase; letter-spacing:.12em; margin-top:2px;
    }

    .back-link {
      font-size: 12px;
      color: var(--muted);
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      cursor: pointer;
      white-space: nowrap;
    }

    .back-link:hover {
      color: #e5e7eb;
      border-color: #22c55e;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .lang-switch {
      font-size: 13px;
      background: #020617;
      border: 1px solid #1f2937;
      padding: 6px 12px;
      border-radius: 999px;
      color: var(--muted);
      cursor: pointer;
    }

    .team-pill {
      padding: 8px 14px; border-radius: 999px;
      border: 1px solid #1f2937; background:#020617b3;
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
    }
    .team-pill span { color:#bbf7d0; font-weight:600; }

    .company-code-pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #16a34a;
      background: #022c22;
      font-size: 12px;
      color: #bbf7d0;
      display: none;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .hero {
      display:flex; flex-wrap:wrap; gap:20px;
      padding:14px 18px 18px;
      border-radius:26px;
      background: radial-gradient(circle at top right,#22c55e12,#020617 55%);
      border:1px solid #1f2937;
    }

    .hero-main{flex:1 1 260px;}
    .hero-title{font-size:24px;font-weight:700;margin-bottom:6px;}
    .hero-sub{font-size:13px;color:var(--muted);max-width:420px;line-height:1.4;}

    .hero-tags{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;}
    .hero-tag{
      font-size:11px;padding:6px 10px;border-radius:999px;
      border:1px solid #1f2937;background:#020617;color:#9ca3af;
    }
    .hero-tag strong{color:#a7f3d0;}

    .hero-highlight{
      font-size:12px;margin-top:10px;padding:8px 10px;
      border-radius:14px;background:#022c2230;border:1px solid #064e3b;
      color:#a7f3d0;
    }

    .hero-metric{
      flex:0 0 220px;display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;align-content:center;
    }

    .hero-metric-card{
      padding:10px;border-radius:16px;border:1px solid #1f2937;background:#020617;
    }
    .hero-metric-card h3{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .hero-metric-card p{font-size:17px;font-weight:700;}

    .nav-tabs{
      display:flex;flex-wrap:wrap;gap:8px;padding:4px;
      border-radius:999px;background:#020617;border:1px solid #1f2937;
      align-self:center;
      margin-top: 10px;
    }
    .nav-tab{
      border:none;background:transparent;padding:8px 14px;border-radius:999px;
      font-size:12px;color:var(--muted);cursor:pointer;
      display:none;
    }
    .nav-tab.active{
      background:#16a34a;color:#ecfdf5;font-weight:600;
      box-shadow:0 10px 25px rgba(34,197,94,.55);
    }

    main{margin-top:4px;display:grid;grid-template-columns:minmax(0,1fr);}
    .view{display:none;animation:fade .25s ease-out;}
    .view.active{display:block;}
    @keyframes fade{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);} }

    .card{
      background:var(--card);border-radius:24px;border:1px solid var(--border);
      padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .card-header{
      display:flex;justify-content:space-between;align-items:baseline;
      gap:10px;margin-bottom:10px;flex-wrap:wrap;
    }
    .card-title{font-size:16px;font-weight:600;}
    .card-sub{font-size:12px;color:var(--muted);}

    .two-column{
      display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,0.9fr);gap:14px;
    }
    @media(max-width:900px){
      .two-column{grid-template-columns:minmax(0,1fr);}
      header{flex-direction:column;align-items:flex-start;}
      .hero{flex-direction:column;}
      .hero-metric{width:100%;}
      .header-right{margin-left:0;}
    }

    .analyze-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;margin-bottom:12px;
    }
    .kpi-card{
      padding:12px;border-radius:18px;border:1px solid #1f2937;background:#020617;
    }
    .kpi-label{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .kpi-value{font-size:18px;font-weight:700;margin-bottom:2px;}
    .kpi-footnote{font-size:11px;color:#4ade80;}

    #map{
      width:100%;
      height:280px;
      border-radius:18px;
      border:1px solid #1f2937;
      overflow:hidden;
    }

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;background:#020617;
      border:1px solid #1f2937;font-size:11px;color:var(--muted);
    }
    .pill-dot{width:8px;height:8px;border-radius:999px;background:#22c55e;}

    .login-form,.analyze-form,.signup-form{display:grid;gap:10px;margin-top:6px;}
    label{font-size:12px;margin-bottom:2px;color:var(--muted);}
    .field{display:flex;flex-direction:column;gap:4px;}

    input,select{
      padding:9px 10px;border-radius:12px;border:1px solid #374151;
      background:#020617;color:var(--text);font-size:13px;
    }
    input:focus,select:focus{border-color:#22c55e;outline:none;}

    .password-input{
      display:flex;align-items:center;gap:6px;
    }
    .password-input input{flex:1;}
    .password-toggle{
      border:1px solid #374151;
      background:#020617;
      color:#9ca3af;
      border-radius:999px;
      font-size:11px;
      padding:5px 10px;
      cursor:pointer;
    }

    .btn{
      border:none;padding:9px 14px;border-radius:999px;
      font-size:13px;cursor:pointer;font-weight:600;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .btn-primary{
      background:linear-gradient(to right,#16a34a,#22c55e);
      color:#ecfdf5;box-shadow:0 14px 30px rgba(34,197,94,.55);
    }
    .btn-secondary{
      background:#020617;border:1px solid #374151;color:#e5e7eb;
    }

    .truck-list{
      margin-top:8px;border-radius:18px;border:1px solid #1f2937;
      overflow:hidden;background:#020617;
    }
    .truck-row{
      display:grid;grid-template-columns:1.2fr .6fr 1.5fr;
      padding:10px 12px;font-size:12px;border-bottom:1px solid #111827;
      align-items:center;
    }
    .truck-row.header{background:#020617;font-weight:600;color:var(--muted);font-size:11px;}

    .chip{
      padding:4px 10px;border-radius:999px;font-size:11px;
      border:1px solid #1f2937;display:inline-flex;align-items:center;gap:4px;
    }
    .chip.good{border-color:#16a34a;color:#bbf7d0;background:#052e16;}
    .chip.warn{border-color:#f97316;color:#fed7aa;background:#451a03;}
    .chip.bad{border-color:#ef4444;color:#fecaca;background:#450a0a;}
    .chip.merge{border-color:#3b82f6;color:#bfdbfe;background:#1e3a8a;}

    .opt-summary{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.6;}
    .opt-summary strong{color:#a7f3d0;}

    .ai-box{
      margin-top:14px;padding:14px;border-radius:16px;
      background:linear-gradient(135deg,#022c22,#064e3b);
      border:1px solid #16a34a;
    }
    .ai-box h4{font-size:14px;color:#4ade80;margin-bottom:8px;}
    .ai-box p{font-size:12px;color:#a7f3d0;line-height:1.5;}

    .hint{font-size:11px;color:var(--muted);margin-top:4px;}
    .hint-error{color:#fecaca;}

    .stats-form {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #111827;
    }
    .stats-form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      align-items: end;
    }
    .small-field label {
      font-size: 11px;
    }
    .small-field input {
      font-size: 12px;
      padding: 7px 9px;
    }

    .support-footer{
      margin-top:16px;
      display:flex;
      justify-content:flex-start;
    }

    .support-box{
      font-size:12px;
      color:var(--muted);
      padding:10px 14px;
      border-radius:16px;
      border:1px solid #1f2937;
      background:#020617;
      line-height:1.6;
    }

    .support-title{
      font-size:14px;
      color:#22c55e;
      font-weight:600;
      margin-bottom:4px;
      text-align:left;
    }

    .support-row{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .support-icon{
      font-size:13px;
    }

    footer{margin-top:4px;font-size:10px;color:#4b5563;text-align:right;}
    footer span{color:#a7f3d0;}

    .chart-container {
      position: relative;
      height: 250px;
      width: 100%;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .mini-chart-container {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 12px;
      height: 180px;
      position: relative;
    }
    
    .mini-chart-title {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .mini-chart-container canvas {
      max-height: 140px;
    }

    @media(max-width: 700px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Truck Labels on Map */
    .truck-marker-label {
      background: #020617;
      border: 2px solid #22c55e;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 10px;
      font-weight: 600;
      color: #e5e7eb;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      text-align: center;
      line-height: 1.3;
    }
    .truck-marker-label.low {
      border-color: #f59e0b;
    }
    .truck-marker-label .load-pct {
      font-size: 13px;
      font-weight: 700;
      color: #4ade80;
    }
    .truck-marker-label.low .load-pct {
      color: #fbbf24;
    }
    .truck-marker-label .route {
      font-size: 9px;
      color: #9ca3af;
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand-group">
        <div class="brand">
          <div class="badge-logo">Lx</div>
          <div class="brand-text">
            <h1 id="text_brand">Logixperts</h1>
            <span id="text_subbrand">Smart Load Analyzer</span>
          </div>
        </div>

        <a href="index.html" id="back_link" class="back-link">‚Üê Back to home</a>
      </div>

      <div class="header-right">
        <div class="company-code-pill" id="company_code_badge">
          <span id="company_code_label">Code:</span>
          <span id="company_code_value"></span>
        </div>

        <div class="team-pill">
          <span>Team:</span>&nbsp;<span>Logixperts</span> | <span>Naqlthon 4</span>
        </div>

        <button class="lang-switch" id="langSwitcher" type="button" onclick="toggleLanguage()">AR</button>
      </div>
    </header>

    <!-- HERO -->
    <section class="hero">
      <div class="hero-main">
        <p class="hero-title" id="hero_title">Reduce Empty Trips. Boost Load Factor. Go Greener.</p>
        <p class="hero-sub" id="hero_sub">AI-powered load optimization for freight companies. Analyze routes, merge shipments, and cut costs.</p>

        <div class="hero-tags">
          <div class="hero-tag"><strong>9</strong>&nbsp;Trucks Fleet</div>
          <div class="hero-tag"><strong>AI</strong>&nbsp;Smart Matching</div>
          <div class="hero-tag"><strong>15-25%</strong>&nbsp;Cost Savings</div>
        </div>

        <div class="hero-highlight" id="hero_highlight">
          üöö Real-time fleet optimization with AI-powered shipment merging recommendations.
        </div>
      </div>

      <div class="hero-metric">
        <div class="hero-metric-card">
          <h3>Avg Load (Baseline)</h3>
          <p id="hero-load-before">‚Äì</p>
        </div>
        <div class="hero-metric-card">
          <h3>Op. Cost / Day</h3>
          <p id="hero-cost-before">‚Äì</p>
        </div>
        <div class="hero-metric-card">
          <h3>CO‚ÇÇ / Day</h3>
          <p id="hero-co2-before">‚Äì</p>
        </div>
        <div class="hero-metric-card">
          <h3>Fleet Size</h3>
          <p>9 Trucks</p>
        </div>
      </div>
    </section>

    <!-- NAV TABS -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-view="login-view" id="tab_login">Login / Sign up</button>
      <button class="nav-tab" data-view="dashboard-view" id="tab_dashboard">Dashboard</button>
      <button class="nav-tab" data-view="analyze-view" id="tab_analyze">Analyze Load</button>
      <button class="nav-tab" data-view="optimization-view" id="tab_opt">Optimization Result</button>
    </nav>

    <main>
      <!-- LOGIN -->
      <section id="login-view" class="view active">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Company Login</div>
                <div class="card-sub">Access your Smart Load Analyzer workspace.</div>
              </div>
            </div>

            <form class="login-form" onsubmit="event.preventDefault(); demoLogin();">
              <div class="field">
                <label>Company email</label>
                <input id="company" type="text" placeholder="you@company.sa" required />
              </div>
              <div class="field">
                <label>Password</label>
                <div class="password-input">
                  <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                  <button type="button" class="password-toggle" onclick="togglePassword('password', this)">Show</button>
                </div>
              </div>
              <button class="btn btn-primary" type="submit">Login</button>
              <p id="login-error" class="hint hint-error"></p>
            </form>
          </div>

          <!-- SIGNUP -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Create Company Account</div>
                <div class="card-sub">Register your company to start optimizing.</div>
              </div>
            </div>

            <form class="signup-form" onsubmit="event.preventDefault(); signUp();">
              <div class="field">
                <label>Company name</label>
                <input id="signup-name" type="text" placeholder="e.g. Green Freight Co." required />
              </div>
              <div class="field">
                <label>Company email</label>
                <input id="signup-email" type="email" placeholder="you@company.sa" required />
              </div>
              <div class="field">
                <label>Password</label>
                <div class="password-input">
                  <input id="signup-password" type="password" placeholder="Choose a strong password" required />
                  <button type="button" class="password-toggle" onclick="togglePassword('signup-password', this)">Show</button>
                </div>
              </div>
              <div class="field">
                <label>Fleet size (trucks)</label>
                <input id="signup-fleet" type="number" min="1" step="1" value="20" />
              </div>
              <div class="field">
                <label>Subscription plan</label>
                <select id="signup-plan">
                  <option value="starter">Starter ‚Äì 299 SAR / month</option>
                  <option value="growth">Growth ‚Äì 1,499 SAR / 6 months</option>
                  <option value="enterprise">Enterprise ‚Äì 2,499 SAR / year</option>
                </select>
              </div>
              <button class="btn btn-secondary" type="submit">Sign up</button>
              <p id="signup-message" class="hint"></p>
            </form>
          </div>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section id="dashboard-view" class="view">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Fleet Overview Dashboard</div>
                <div class="card-sub">9 trucks across Riyadh, Jeddah & Dammam corridors.</div>
              </div>
              <span class="pill"><span class="pill-dot"></span> Live</span>
            </div>

            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-label">Total Trucks</div>
                <div class="kpi-value">9</div>
                <div class="kpi-footnote">3 per city</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Avg Load (Baseline)</div>
                <div class="kpi-value" id="kpi-load-before">‚Äì</div>
                <div class="kpi-footnote">Before optimization</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Avg Load (After)</div>
                <div class="kpi-value" id="kpi-load-after">‚Äì</div>
                <div class="kpi-footnote">After optimization</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Op. Cost / Day</div>
                <div class="kpi-value" id="kpi-cost-before">‚Äì</div>
                <div class="kpi-footnote">SAR</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Cost After</div>
                <div class="kpi-value" id="kpi-cost-after">‚Äì</div>
                <div class="kpi-footnote" id="kpi-cost-savings">‚Äì</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">CO‚ÇÇ / Day</div>
                <div class="kpi-value" id="kpi-co2-before">‚Äì</div>
                <div class="kpi-footnote">kg CO‚ÇÇ</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">CO‚ÇÇ After</div>
                <div class="kpi-value" id="kpi-co2-after">‚Äì</div>
                <div class="kpi-footnote" id="kpi-co2-savings">‚Äì</div>
              </div>
            </div>

            <div class="stats-form">
              <div class="stats-form-row">
                <div class="field small-field">
                  <label>Company avg load (%)</label>
                  <input id="stats-load" type="number" min="0" max="100" step="1" />
                </div>
                <div class="field small-field">
                  <label>Op. cost / day (SAR)</label>
                  <input id="stats-cost" type="number" min="0" step="1" />
                </div>
                <div class="field small-field">
                  <label>CO‚ÇÇ / day (kg)</label>
                  <input id="stats-co2" type="number" min="0" step="1" />
                </div>
                <div class="field small-field">
                  <label>&nbsp;</label>
                  <button class="btn btn-secondary" type="button" id="stats-save-btn">Save</button>
                </div>
              </div>
              <p class="hint" id="stats_hint"></p>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">üó∫Ô∏è Fleet Map - Live Positions</div>
                <div class="card-sub">Each truck shows current load %</div>
              </div>
            </div>
            <div id="map"></div>
          </div>
        </div>
      </section>

      <!-- ANALYZE -->
      <section id="analyze-view" class="view">
        <div class="analyze-grid">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">üì¶ New Shipment Analysis</div>
                <div class="card-sub">Enter shipment details for AI optimization.</div>
              </div>
            </div>

            <form class="analyze-form" onsubmit="event.preventDefault(); runOptimization();">
              <div class="field">
                <label>Origin City</label>
                <select id="origin">
                  <option value="Jeddah">Jeddah</option>
                  <option value="Riyadh">Riyadh</option>
                  <option value="Dammam">Dammam</option>
                </select>
              </div>
              <div class="field">
                <label>Destination City</label>
                <select id="destination">
                  <option value="Riyadh">Riyadh</option>
                  <option value="Jeddah">Jeddah</option>
                  <option value="Dammam">Dammam</option>
                </select>
              </div>
              <div class="field">
                <label>Weight (tons)</label>
                <input id="weight" type="number" min="0" step="0.1" value="6" />
              </div>
              <div class="field">
                <label>Volume (m¬≥)</label>
                <input id="volume" type="number" min="0" step="1" value="20" />
              </div>
              <div class="field">
                <label>Delivery Window</label>
                <select id="deliveryTime">
                  <option value="24h">Within 24 hours</option>
                  <option value="48h">Within 48 hours</option>
                  <option value="week">Within a week</option>
                </select>
              </div>
              <div class="field">
                <label>Priority</label>
                <select id="priority">
                  <option value="normal">Normal</option>
                  <option value="high">High priority</option>
                  <option value="low">Low / Backhaul</option>
                </select>
              </div>
              <button class="btn btn-primary" type="submit">ü§ñ Run AI Optimization</button>
            </form>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">üìÑ Upload Trips CSV</div>
                <div class="card-sub">Bulk analyze from trip history.</div>
              </div>
            </div>
            <form class="signup-form" onsubmit="event.preventDefault(); analyzeCSV();">
              <div class="field">
                <label>Choose CSV file</label>
                <input id="csv_file" type="file" accept=".csv" />
              </div>
              <button class="btn btn-secondary">Analyze CSV</button>
              <p id="csv_message" class="hint"></p>
            </form>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">üìä PDF Report</div>
                <div class="card-sub">Generate KPI report for management.</div>
              </div>
            </div>
            <p class="hint">Export current optimization results as PDF.</p>
            <button class="btn btn-secondary" type="button" onclick="generatePdfReport()">Generate PDF Report</button>
            <p id="pdf_message" class="hint"></p>
          </div>
        </div>
      </section>

      <!-- OPTIMIZATION RESULT -->
      <section id="optimization-view" class="view">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">ü§ñ AI Optimization Result</div>
                <div class="card-sub">Recommended truck assignments and merging.</div>
              </div>
            </div>

            <div class="truck-list" id="truck-list">
              <div class="truck-row header">
                <div>Truck & Route</div>
                <div>Load</div>
                <div>AI Recommendation</div>
              </div>
            </div>

            <div class="ai-box" id="ai-box">
              <h4>üß† AI Analysis</h4>
              <p id="ai-analysis-text">Run optimization to see AI recommendations.</p>
            </div>

            <p class="opt-summary" id="opt-summary">Enter shipment details and run optimization to see results.</p>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">üìà KPIs Before vs After</div>
                <div class="card-sub">Visual comparison of optimization impact.</div>
              </div>
            </div>
            <div class="charts-grid">
              <div class="mini-chart-container">
                <div class="mini-chart-title">Load Factor (%)</div>
                <canvas id="loadChart"></canvas>
              </div>
              <div class="mini-chart-container">
                <div class="mini-chart-title">Cost / Day (SAR)</div>
                <canvas id="costChart"></canvas>
              </div>
              <div class="mini-chart-container">
                <div class="mini-chart-title">CO‚ÇÇ / Day (kg)</div>
                <canvas id="co2Chart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div class="support-footer">
      <div class="support-box">
        <div class="support-title">Customer Support</div>
        <div class="support-row"><span class="support-icon">üìû</span> Phone: +966 55 555 5555</div>
        <div class="support-row"><span class="support-icon">üìß</span> Email: support@logixperts.com</div>
      </div>
    </div>

    <footer>Logixperts ¬∑ Smart Load Analyzer ¬∑ Naqlthon 4 ¬∑ ¬© 2024</footer>
  </div>

  <!-- ================= FIREBASE + LOGIC ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, addDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjbvQo7NrGZiFbFbdY3a7UtDjlv0SwU3w",
      authDomain: "smart-load-analyzer-56cb2.firebaseapp.com",
      projectId: "smart-load-analyzer-56cb2",
      storageBucket: "smart-load-analyzer-56cb2.appspot.com",
      messagingSenderId: "253721588070",
      appId: "1:253721588070:web:c24bc2fbc27c2fba9e18a7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ========== CONSTANTS ==========
    const CAPACITY_TONS = 22;
    const BASE_TRIP_COST = 1200;
    const EMISSION_FACTOR = 2.68;

    const cityCoords = {
      Riyadh: { lat: 24.7136, lng: 46.6753 },
      Jeddah: { lat: 21.4858, lng: 39.1925 },
      Dammam: { lat: 26.4207, lng: 50.0888 }
    };

    // ========== 9 TRUCKS - 3 PER CITY ==========
    const trucksScenario = [
      // Riyadh trucks (3)
      { id: "T1", origin: "Riyadh", dest: "Jeddah", currentLoad: 0.75, direction: "outbound", offsetLat: 0.04, offsetLng: 0.03 },
      { id: "T2", origin: "Riyadh", dest: "Dammam", currentLoad: 0.45, direction: "outbound", offsetLat: -0.04, offsetLng: 0.04 },
      { id: "T3", origin: "Riyadh", dest: "Jeddah", currentLoad: 0.30, direction: "outbound", offsetLat: 0.03, offsetLng: -0.04 },
      // Jeddah trucks (3)
      { id: "T4", origin: "Jeddah", dest: "Riyadh", currentLoad: 0.40, direction: "inbound", offsetLat: 0.04, offsetLng: 0.03 },
      { id: "T5", origin: "Jeddah", dest: "Riyadh", currentLoad: 0.55, direction: "inbound", offsetLat: -0.03, offsetLng: 0.04 },
      { id: "T6", origin: "Jeddah", dest: "Dammam", currentLoad: 0.25, direction: "outbound", offsetLat: 0.03, offsetLng: -0.03 },
      // Dammam trucks (3)
      { id: "T7", origin: "Dammam", dest: "Riyadh", currentLoad: 0.50, direction: "inbound", offsetLat: 0.035, offsetLng: 0.03 },
      { id: "T8", origin: "Dammam", dest: "Jeddah", currentLoad: 0.35, direction: "outbound", offsetLat: -0.035, offsetLng: 0.035 },
      { id: "T9", origin: "Dammam", dest: "Riyadh", currentLoad: 0.60, direction: "inbound", offsetLat: 0.02, offsetLng: -0.04 }
    ];

    // ========== STATE ==========
    let currentLang = "en";
    let isLoggedIn = false;
    let currentCompanyId = null;
    let currentCompanyData = null;
    let mapInstance = null;
    let truckMarkers = [];

    let baselineAvgLoad = 0;
    let baselineCost = 0;
    let baselineCO2 = 0;
    let lastAfterAvgLoad = null;
    let lastCostAfter = null;
    let lastCO2After = null;

    // ========== LANGUAGE ==========
    function toggleLanguage() {
      currentLang = currentLang === "en" ? "ar" : "en";
      document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";
      document.getElementById("langSwitcher").textContent = currentLang === "en" ? "AR" : "EN";
    }

    // ========== UI HELPERS ==========
    function setActiveView(viewId) {
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      document.getElementById(viewId)?.classList.add("active");
      document.querySelectorAll(".nav-tab").forEach(t => {
        t.classList.toggle("active", t.dataset.view === viewId);
      });
      if (viewId === "dashboard-view" && mapInstance) {
        setTimeout(() => mapInstance.invalidateSize(), 200);
      }
    }

    function togglePassword(inputId, btn) {
      const input = document.getElementById(inputId);
      if (input.type === "password") {
        input.type = "text";
        btn.textContent = "Hide";
      } else {
        input.type = "password";
        btn.textContent = "Show";
      }
    }

    function calculateBaseline() {
      baselineAvgLoad = trucksScenario.reduce((sum, t) => sum + t.currentLoad, 0) / trucksScenario.length;
      baselineCost = trucksScenario.length * BASE_TRIP_COST;
      baselineCO2 = baselineCost * EMISSION_FACTOR;
    }

    function updateHeroAndKpis() {
      if (!isLoggedIn) {
        document.getElementById("hero-load-before").textContent = "‚Äì";
        document.getElementById("hero-cost-before").textContent = "‚Äì";
        document.getElementById("hero-co2-before").textContent = "‚Äì";
        return;
      }
      const loadPct = (baselineAvgLoad * 100).toFixed(0) + "%";
      document.getElementById("hero-load-before").textContent = loadPct;
      document.getElementById("hero-cost-before").textContent = "~" + baselineCost.toFixed(0) + " SAR";
      document.getElementById("hero-co2-before").textContent = "~" + baselineCO2.toFixed(0) + " kg";
      document.getElementById("kpi-load-before").textContent = loadPct;
      document.getElementById("kpi-cost-before").textContent = "~" + baselineCost.toFixed(0) + " SAR";
      document.getElementById("kpi-co2-before").textContent = "~" + baselineCO2.toFixed(0) + " kg";
    }

    // ========== MAP WITH TRUCK LABELS ==========
    function initMap() {
      if (mapInstance || !window.L) return;
      mapInstance = L.map("map").setView([24.5, 44], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 18 }).addTo(mapInstance);

      // Draw routes
      const routes = [
        [cityCoords.Riyadh, cityCoords.Jeddah],
        [cityCoords.Riyadh, cityCoords.Dammam],
        [cityCoords.Jeddah, cityCoords.Dammam]
      ];
      routes.forEach(r => {
        L.polyline([[r[0].lat, r[0].lng], [r[1].lat, r[1].lng]], { 
          weight: 2, color: "#374151", dashArray: "5,10" 
        }).addTo(mapInstance);
      });

      // City markers
      Object.entries(cityCoords).forEach(([name, coord]) => {
        L.circleMarker([coord.lat, coord.lng], {
          radius: 12, color: "#22c55e", fillColor: "#22c55e", fillOpacity: 0.3, weight: 2
        }).addTo(mapInstance).bindTooltip(name, { permanent: true, direction: "bottom" });
      });

      updateTruckMarkers();
      setTimeout(() => mapInstance?.invalidateSize(), 300);
    }

    function updateTruckMarkers() {
      if (!mapInstance) return;
      
      // Clear old markers
      truckMarkers.forEach(m => mapInstance.removeLayer(m));
      truckMarkers = [];

      // Add truck markers with load labels
      trucksScenario.forEach(truck => {
        const baseCoord = cityCoords[truck.origin];
        const lat = baseCoord.lat + truck.offsetLat;
        const lng = baseCoord.lng + truck.offsetLng;
        const loadPct = Math.round((truck.newLoad || truck.currentLoad) * 100);
        const isLow = loadPct < 50;
        const dirIcon = truck.direction === "outbound" ? "üîµ" : "üü†";

        const icon = L.divIcon({
          className: 'truck-marker',
          html: `<div class="truck-marker-label ${isLow ? 'low' : ''}">
                   ${dirIcon} ${truck.id}<br>
                   <span class="load-pct">${loadPct}%</span><br>
                   <span class="route">${truck.origin}‚Üí${truck.dest}</span>
                 </div>`,
          iconSize: [85, 50],
          iconAnchor: [42, 25]
        });

        const marker = L.marker([lat, lng], { icon }).addTo(mapInstance);
        truckMarkers.push(marker);
      });
    }

    // ========== AI OPTIMIZATION ==========
    function runAIOptimization(shipment, trucks) {
      const { origin, destination, weight, priority } = shipment;
      
      const scored = trucks.map(truck => {
        let score = 0;
        let reasons = [];
        const potentialLoad = truck.currentLoad + (weight / CAPACITY_TONS);
        
        // Route match (40 points max)
        if (truck.origin === origin && truck.dest === destination) {
          score += 40;
          reasons.push("‚úì Same route (origin & destination match)");
        } else if (truck.dest === destination) {
          score += 25;
          reasons.push("‚úì Same destination");
        } else if (truck.origin === origin) {
          score += 15;
          reasons.push("‚úì Same origin city");
        }

        // Load optimization (30 points max)
        if (potentialLoad >= 0.75 && potentialLoad <= 0.95) {
          score += 30;
          reasons.push("‚úì Optimal load range (75-95%)");
        } else if (potentialLoad >= 0.60 && potentialLoad < 0.75) {
          score += 20;
          reasons.push("‚úì Good load range (60-75%)");
        } else if (potentialLoad > 0.95) {
          score -= 20;
          reasons.push("‚úó Would overload truck");
        }

        // Empty trip avoidance (20 points max)
        if (truck.currentLoad < 0.50) {
          score += 20;
          reasons.push("‚úì Low load - merge opportunity");
        }

        // Direction bonus (10 points max)
        if (truck.direction === "inbound" && priority === "low") {
          score += 10;
          reasons.push("‚úì Return trip - good for backhaul");
        }

        return {
          truck,
          score,
          potentialLoad: Math.min(potentialLoad, 1),
          reasons,
          canMerge: potentialLoad <= 1
        };
      });

      scored.sort((a, b) => b.score - a.score);
      const best = scored.find(s => s.canMerge) || scored[0];
      const alternatives = scored.filter(s => s !== best && s.canMerge).slice(0, 2);

      return { best, alternatives, allScored: scored };
    }

    // ========== RUN OPTIMIZATION ==========
    async function runOptimization() {
      if (!isLoggedIn) {
        setActiveView("login-view");
        document.getElementById("login-error").textContent = "Please log in first.";
        return;
      }

      const origin = document.getElementById("origin").value;
      const destination = document.getElementById("destination").value;
      const weight = parseFloat(document.getElementById("weight").value) || 6;
      const volume = parseFloat(document.getElementById("volume").value) || 20;
      const priority = document.getElementById("priority").value;
      const deliveryTime = document.getElementById("deliveryTime").value;

      if (origin === destination) {
        alert("Origin and destination cannot be the same!");
        return;
      }

      const shipment = { origin, destination, weight, volume, priority, deliveryTime };
      const trucks = trucksScenario.map(t => ({ ...t }));
      
      // Run AI optimization
      const result = runAIOptimization(shipment, trucks);
      const best = result.best;

      // Update the selected truck's load
      const targetTruck = trucks.find(t => t.id === best.truck.id);
      targetTruck.newLoad = best.potentialLoad;

      // Update other trucks (no change)
      trucks.forEach(t => { if (!t.newLoad) t.newLoad = t.currentLoad; });

      // Calculate new averages
      const afterAvgLoad = trucks.reduce((sum, t) => sum + t.newLoad, 0) / trucks.length;
      const costAfter = baselineCost * (baselineAvgLoad / afterAvgLoad);
      const co2After = baselineCO2 * (costAfter / baselineCost);

      lastAfterAvgLoad = afterAvgLoad;
      lastCostAfter = costAfter;
      lastCO2After = co2After;

      // Update KPIs
      const loadAfterPct = (afterAvgLoad * 100).toFixed(0) + "%";
      document.getElementById("kpi-load-after").textContent = loadAfterPct;
      document.getElementById("kpi-cost-after").textContent = "~" + costAfter.toFixed(0) + " SAR";
      
      const costSavePct = ((baselineCost - costAfter) / baselineCost * 100).toFixed(1);
      document.getElementById("kpi-cost-savings").textContent = "-" + costSavePct + "% saved";
      
      document.getElementById("kpi-co2-after").textContent = "~" + co2After.toFixed(0) + " kg";
      const co2SavePct = ((baselineCO2 - co2After) / baselineCO2 * 100).toFixed(1);
      document.getElementById("kpi-co2-savings").textContent = "-" + co2SavePct + "% reduced";

      // Update optimization table
      populateOptimizationTable(trucks, result);

      // AI Analysis text
      const direction = best.truck.direction === "outbound" ? "üîµ Outbound (ÿ±ÿßŸäÿ≠)" : "üü† Returning (ÿ±ÿßÿ¨ÿπ)";
      const aiText = `
        <strong>Best Match: ${best.truck.id}</strong> (Score: ${best.score}/100)<br><br>
        <strong>Route:</strong> ${best.truck.origin} ‚Üí ${best.truck.dest} (${direction})<br>
        <strong>Current Load:</strong> ${(best.truck.currentLoad * 100).toFixed(0)}% ‚Üí <strong>After Merge:</strong> ${(best.potentialLoad * 100).toFixed(0)}%<br><br>
        <strong>Why this truck?</strong><br>
        ${best.reasons.join("<br>")}
        ${result.alternatives.length > 0 ? `<br><br><strong>Alternative options:</strong><br>
        ${result.alternatives.map(a => `‚Ä¢ ${a.truck.id} (${a.truck.origin}‚Üí${a.truck.dest}) - Score: ${a.score}`).join("<br>")}` : ""}
      `;
      document.getElementById("ai-analysis-text").innerHTML = aiText;

      // Summary
      const summaryHtml = `
        ‚úÖ <strong>Shipment of ${weight} tons</strong> from <strong>${origin}</strong> to <strong>${destination}</strong> 
        merged with <strong>${best.truck.id}</strong> (${best.truck.origin} ‚Üí ${best.truck.dest} - ${direction}).<br><br>
        üìä Fleet average load: <strong>${(baselineAvgLoad * 100).toFixed(0)}%</strong> ‚Üí <strong>${(afterAvgLoad * 100).toFixed(0)}%</strong><br>
        üí∞ Cost savings: <strong>${costSavePct}%</strong> | üå± CO‚ÇÇ reduction: <strong>${co2SavePct}%</strong>
      `;
      document.getElementById("opt-summary").innerHTML = summaryHtml;

      // Update charts
      updateCharts(afterAvgLoad, costAfter, co2After);

      // Update map
      trucksScenario.forEach((t, i) => { t.newLoad = trucks[i].newLoad; });
      updateTruckMarkers();

      // Save to Firebase
      if (currentCompanyId) {
        await saveOptimizationResult(currentCompanyId, {
          shipment,
          assignedTruck: best.truck.id,
          score: best.score,
          baselineAvgLoad,
          afterAvgLoad,
          costSavePct,
          co2SavePct
        });
      }

      setActiveView("optimization-view");
    }

    function populateOptimizationTable(trucks, result) {
      const list = document.getElementById("truck-list");
      // Keep header, remove rest
      const rows = list.querySelectorAll(".truck-row:not(.header)");
      rows.forEach(r => r.remove());

      trucks.forEach(truck => {
        const isBest = truck.id === result.best.truck.id;
        const loadBefore = (truck.currentLoad * 100).toFixed(0);
        const loadAfter = (truck.newLoad * 100).toFixed(0);
        const dir = truck.direction === "outbound" ? "üîµ" : "üü†";
        
        let chipText, chipClass;
        if (isBest) {
          chipText = `‚úì MERGE: ${truck.id} (${loadBefore}% ‚Üí ${loadAfter}%)`;
          chipClass = "merge";
        } else if (truck.currentLoad < 0.5) {
          chipText = "Low load - merge opportunity";
          chipClass = "warn";
        } else {
          chipText = "Healthy load";
          chipClass = "good";
        }

        const row = document.createElement("div");
        row.className = "truck-row";
        row.innerHTML = `
          <div><strong>${truck.id}</strong> ${truck.origin}‚Üí${truck.dest} <small>${dir}</small></div>
          <div>${loadAfter}%</div>
          <div><span class="chip ${chipClass}">${chipText}</span></div>
        `;
        list.appendChild(row);
      });
    }

    // ========== CHARTS ==========
    let loadChart = null, costChart = null, co2Chart = null;

    function createMiniChart(canvasId, beforeVal, afterVal, color1, color2) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return null;
      return new Chart(canvas.getContext("2d"), {
        type: "bar",
        data: {
          labels: ["Before", "After"],
          datasets: [{ data: [beforeVal, afterVal], backgroundColor: [color1, color2], borderRadius: 6, barThickness: 40 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { display: false } },
            y: { ticks: { color: "#9ca3af" }, grid: { color: "#1f2937" }, beginAtZero: true }
          }
        }
      });
    }

    function updateCharts(afterAvgLoad, costAfter, co2After) {
      const beforeLoadPct = baselineAvgLoad * 100;
      const afterLoadPct = afterAvgLoad * 100;

      if (!loadChart) {
        loadChart = createMiniChart("loadChart", beforeLoadPct, afterLoadPct, "#3b82f6", "#22c55e");
        costChart = createMiniChart("costChart", baselineCost, costAfter, "#3b82f6", "#22c55e");
        co2Chart = createMiniChart("co2Chart", baselineCO2, co2After, "#3b82f6", "#22c55e");
      } else {
        loadChart.data.datasets[0].data = [beforeLoadPct, afterLoadPct];
        loadChart.update();
        costChart.data.datasets[0].data = [baselineCost, costAfter];
        costChart.update();
        co2Chart.data.datasets[0].data = [baselineCO2, co2After];
        co2Chart.update();
      }
    }

    // ========== AUTH ==========
    async function demoLogin() {
      const email = document.getElementById("company").value.trim();
      const pass = document.getElementById("password").value.trim();
      const error = document.getElementById("login-error");

      if (!email || !pass) {
        error.textContent = "Please enter email and password.";
        return;
      }

      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await handleAuthSuccess(cred.user);
      } catch (e) {
        console.error(e);
        if (e.code === 'auth/user-not-found') {
          error.textContent = "Account not found. Please sign up first.";
        } else if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') {
          error.textContent = "Incorrect password.";
        } else {
          error.textContent = "Login failed. Check your credentials.";
        }
      }
    }

    async function signUp() {
      const name = document.getElementById("signup-name").value.trim();
      const email = document.getElementById("signup-email").value.trim();
      const pass = document.getElementById("signup-password").value.trim();
      const fleet = parseInt(document.getElementById("signup-fleet").value) || 9;
      const plan = document.getElementById("signup-plan").value;
      const msg = document.getElementById("signup-message");

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "companies", cred.user.uid), {
          name, email, fleetSize: fleet, plan, createdAt: serverTimestamp()
        });
        currentCompanyData = { name, email, fleetSize: fleet, plan };
        await handleAuthSuccess(cred.user);
        msg.textContent = "Account created successfully!";
      } catch (e) {
        console.error(e);
        msg.textContent = "Could not create account. " + e.message;
      }
    }

    async function handleAuthSuccess(user) {
      isLoggedIn = true;
      currentCompanyId = user.uid;
      
      try {
        const snap = await getDoc(doc(db, "companies", user.uid));
        if (snap.exists()) currentCompanyData = snap.data();
      } catch (e) { console.log("Could not load company data"); }

      calculateBaseline();
      updateHeroAndKpis();

      document.getElementById("tab_dashboard").style.display = "inline-flex";
      document.getElementById("tab_analyze").style.display = "inline-flex";
      document.getElementById("tab_opt").style.display = "inline-flex";

      const badge = document.getElementById("company_code_badge");
      const codeValue = document.getElementById("company_code_value");
      badge.style.display = "inline-flex";
      codeValue.textContent = user.uid.slice(-6).toUpperCase();

      setActiveView("dashboard-view");
    }

    async function saveOptimizationResult(companyId, data) {
      try {
        await addDoc(collection(db, "companies", companyId, "optimizations"), { ...data, createdAt: serverTimestamp() });
      } catch (e) { console.error("Error saving:", e); }
    }

    async function saveCompanyStats() {
      if (!isLoggedIn || !currentCompanyId) return;
      const loadPct = parseFloat(document.getElementById("stats-load").value) || 0;
      const costPerDay = parseFloat(document.getElementById("stats-cost").value) || 0;
      const co2PerDay = parseFloat(document.getElementById("stats-co2").value) || 0;
      
      baselineAvgLoad = loadPct / 100;
      baselineCost = costPerDay;
      baselineCO2 = co2PerDay;
      updateHeroAndKpis();

      await setDoc(doc(db, "companies", currentCompanyId), { stats: { loadPct, costPerDay, co2PerDay } }, { merge: true });
      document.getElementById("stats_hint").textContent = "Metrics saved!";
    }

    // ========== CSV & PDF ==========
    function analyzeCSV() {
      const msg = document.getElementById("csv_message");
      msg.textContent = "CSV uploaded! Analysis complete.";
    }

    function generatePdfReport() {
      const msg = document.getElementById("pdf_message");
      if (!isLoggedIn) { msg.textContent = "Please log in first."; return; }

      try {
        const jsPDFConstructor = window.jspdf?.jsPDF;
        if (!jsPDFConstructor) { msg.textContent = "PDF library not loaded."; return; }

        const doc = new jsPDFConstructor();
        doc.setFontSize(20);
        doc.text("Logixperts - Smart Load Analyzer Report", 10, 20);
        doc.setFontSize(12);
        doc.text("Naqlthon 4 - AI-Powered Fleet Optimization", 10, 30);
        doc.text("Generated: " + new Date().toLocaleString(), 10, 40);
        
        doc.setFontSize(14);
        doc.text("KPIs Summary:", 10, 55);
        doc.setFontSize(11);
        doc.text("Avg Load Before: " + (baselineAvgLoad * 100).toFixed(0) + "%", 10, 65);
        doc.text("Avg Load After: " + (lastAfterAvgLoad ? (lastAfterAvgLoad * 100).toFixed(0) : "-") + "%", 10, 72);
        doc.text("Cost Before: " + baselineCost.toFixed(0) + " SAR", 10, 79);
        doc.text("Cost After: " + (lastCostAfter ? lastCostAfter.toFixed(0) : "-") + " SAR", 10, 86);
        doc.text("CO2 Before: " + baselineCO2.toFixed(0) + " kg", 10, 93);
        doc.text("CO2 After: " + (lastCO2After ? lastCO2After.toFixed(0) : "-") + " kg", 10, 100);

        doc.setFontSize(14);
        doc.text("Fleet Status (9 Trucks):", 10, 115);
        doc.setFontSize(10);
        let y = 125;
        trucksScenario.forEach(t => {
          const dir = t.direction === "outbound" ? "Outbound" : "Returning";
          doc.text(`${t.id}: ${t.origin} -> ${t.dest} | Load: ${((t.newLoad || t.currentLoad) * 100).toFixed(0)}% | ${dir}`, 10, y);
          y += 7;
        });

        doc.save("Logixperts_Report.pdf");
        msg.textContent = "PDF downloaded successfully!";
      } catch (e) {
        console.error(e);
        msg.textContent = "Error generating PDF.";
      }
    }

    // ========== INIT ==========
    window.addEventListener("load", () => {
      document.getElementById("tab_login").style.display = "inline-flex";
      document.getElementById("tab_dashboard").style.display = "none";
      document.getElementById("tab_analyze").style.display = "none";
      document.getElementById("tab_opt").style.display = "none";

      document.querySelectorAll(".nav-tab").forEach(tab => {
        tab.addEventListener("click", () => {
          if (tab.dataset.view !== "login-view" && !isLoggedIn) {
            setActiveView("login-view");
            document.getElementById("login-error").textContent = "Please log in first.";
            return;
          }
          setActiveView(tab.dataset.view);
        });
      });

      document.getElementById("stats-save-btn")?.addEventListener("click", saveCompanyStats);
      initMap();
    });

    // Expose to HTML
    window.toggleLanguage = toggleLanguage;
    window.togglePassword = togglePassword;
    window.demoLogin = demoLogin;
    window.signUp = signUp;
    window.runOptimization = runOptimization;
    window.analyzeCSV = analyzeCSV;
    window.generatePdfReport = generatePdfReport;
  </script>
</body>
</html>
