<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Logixperts - Smart Load Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --card: #111827;
      --accent: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .app {
      max-width: 1200px; width: 100%;
      background: #020617;
      border-radius: 32px;
      border: 1px solid #1f2937;
      padding: 20px 20px 26px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      display: flex; flex-direction: column; gap: 18px;
    }

    header {
      display: flex; justify-content: space-between; align-items: center;
      gap: 16px; padding: 10px 14px 6px;
      border-radius: 26px;
      background: radial-gradient(circle at left top, #22c55e20, #020617 55%);
      border: 1px solid #1f2937;
      flex-wrap: wrap;
    }

    .brand-group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand { display: flex; align-items: center; gap: 14px; }

    .badge-logo {
      width: 42px; height: 42px;
      border-radius: 18px;
      border: 1px solid #16a34a;
      background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
      display: flex; align-items: center; justify-content: center;
      color: #ecfdf5; font-weight: 800; font-size: 18px;
      box-shadow: 0 10px 25px rgba(34,197,94,.55);
    }

    .brand-text h1 {
      font-size: 20px; font-weight: 800;
      letter-spacing: .06em; text-transform: uppercase;
    }

    .brand-text span {
      display:block; font-size:11px; color:var(--muted);
      text-transform:uppercase; letter-spacing:.12em; margin-top:2px;
    }

    .back-link {
      font-size: 12px;
      color: var(--muted);
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      cursor: pointer;
      white-space: nowrap;
    }

    .back-link:hover {
      color: #e5e7eb;
      border-color: #22c55e;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .lang-switch {
      font-size: 13px;
      background: #020617;
      border: 1px solid #1f2937;
      padding: 6px 12px;
      border-radius: 999px;
      color: var(--muted);
      cursor: pointer;
    }

    .team-pill {
      padding: 8px 14px; border-radius: 999px;
      border: 1px solid #1f2937; background:#020617b3;
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
    }
    .team-pill span { color:#bbf7d0; font-weight:600; }

    .company-code-pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #16a34a;
      background: #022c22;
      font-size: 12px;
      color: #bbf7d0;
      display: none;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .hero {
      display:flex; flex-wrap:wrap; gap:20px;
      padding:14px 18px 18px;
      border-radius:26px;
      background: radial-gradient(circle at top right,#22c55e12,#020617 55%);
      border:1px solid #1f2937;
    }

    .hero-main{flex:1 1 260px;}
    .hero-title{font-size:24px;font-weight:700;margin-bottom:6px;}
    .hero-sub{font-size:13px;color:var(--muted);max-width:420px;line-height:1.4;}

    .hero-tags{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;}
    .hero-tag{
      font-size:11px;padding:6px 10px;border-radius:999px;
      border:1px solid #1f2937;background:#020617;color:#9ca3af;
    }
    .hero-tag strong{color:#a7f3d0;}

    .hero-highlight{
      font-size:12px;margin-top:10px;padding:8px 10px;
      border-radius:14px;background:#022c2230;border:1px solid #064e3b;
      color:#a7f3d0;
    }

    .hero-metric{
      flex:0 0 220px;display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;align-content:center;
    }

    .hero-metric-card{
      padding:10px;border-radius:16px;border:1px solid #1f2937;background:#020617;
    }
    .hero-metric-card h3{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .hero-metric-card p{font-size:17px;font-weight:700;}

    .nav-tabs{
      display:flex;flex-wrap:wrap;gap:8px;padding:4px;
      border-radius:999px;background:#020617;border:1px solid #1f2937;
      align-self:center;
      margin-top: 10px;
    }
    .nav-tab{
      border:none;background:transparent;padding:8px 14px;border-radius:999px;
      font-size:12px;color:var(--muted);cursor:pointer;
      display:none;
    }
    .nav-tab.active{
      background:#16a34a;color:#ecfdf5;font-weight:600;
      box-shadow:0 10px 25px rgba(34,197,94,.55);
    }

    main{margin-top:4px;display:grid;grid-template-columns:minmax(0,1fr);}
    .view{display:none;animation:fade .25s ease-out;}
    .view.active{display:block;}
    @keyframes fade{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);} }

    .card{
      background:var(--card);border-radius:24px;border:1px solid var(--border);
      padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .card-header{
      display:flex;justify-content:space-between;align-items:baseline;
      gap:10px;margin-bottom:10px;flex-wrap:wrap;
    }
    .card-title{font-size:16px;font-weight:600;}
    .card-sub{font-size:12px;color:var(--muted);}

    .two-column{
      display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,0.9fr);gap:14px;
    }
    @media(max-width:900px){
      .two-column{grid-template-columns:minmax(0,1fr);}
      header{flex-direction:column;align-items:flex-start;}
      .hero{flex-direction:column;}
      .hero-metric{width:100%;}
      .header-right{margin-left:0;}
    }

    .analyze-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;margin-bottom:12px;
    }
    .kpi-card{
      padding:12px;border-radius:18px;border:1px solid #1f2937;background:#020617;
    }
    .kpi-label{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .kpi-value{font-size:18px;font-weight:700;margin-bottom:2px;}
    .kpi-footnote{font-size:11px;color:#4ade80;}

    #dashboardChart,#optChart{
      width:100% !important;
      height:220px !important;
      max-height:220px !important;
      display:block;
    }

    #map, #ai-routing-map{
      width:100%;
      height:230px;
      border-radius:18px;
      border:1px solid #1f2937;
      overflow:hidden;
    }

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;background:#020617;
      border:1px solid #1f2937;font-size:11px;color:var(--muted);
    }
    .pill-dot{width:8px;height:8px;border-radius:999px;background:#22c55e;}

    .login-form,.analyze-form,.signup-form{display:grid;gap:10px;margin-top:6px;}
    label{font-size:12px;margin-bottom:2px;color:var(--muted);}
    .field{display:flex;flex-direction:column;gap:4px;}

    input,select{
      padding:9px 10px;border-radius:12px;border:1px solid #374151;
      background:#020617;color:var(--text);font-size:13px;
    }
    input:focus,select:focus{border-color:#22c55e;outline:none;}

    .password-input{
      display:flex;align-items:center;gap:6px;
    }
    .password-input input{flex:1;}
    .password-toggle{
      border:1px solid #374151;
      background:#020617;
      color:#9ca3af;
      border-radius:999px;
      font-size:11px;
      padding:5px 10px;
      cursor:pointer;
    }

    .btn{
      border:none;padding:9px 14px;border-radius:999px;
      font-size:13px;cursor:pointer;font-weight:600;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .btn-primary{
      background:linear-gradient(to right,#16a34a,#22c55e);
      color:#ecfdf5;box-shadow:0 14px 30px rgba(34,197,94,.55);
    }
    .btn-secondary{
      background:#020617;border:1px solid #374151;color:#e5e7eb;
    }

    .truck-list{
      margin-top:8px;border-radius:18px;border:1px solid #1f2937;
      overflow:hidden;background:#020617;
    }
    .truck-row{
      display:grid;grid-template-columns:1.2fr .9fr 1.3fr;
      padding:8px 10px;font-size:12px;border-bottom:1px solid #111827;
      align-items:center;
    }
    .truck-row.header{background:#020617;font-weight:600;color:var(--muted);font-size:11px;}

    .chip{
      padding:3px 8px;border-radius:999px;font-size:11px;
      border:1px solid #1f2937;display:inline-flex;align-items:center;gap:4px;
    }
    .chip.good{border-color:#16a34a;color:#bbf7d0;background:#052e16;}
    .chip.warn{border-color:#f97316;color:#fed7aa;background:#451a03;}
    .chip.bad{border-color:#ef4444;color:#fecaca;background:#450a0a;}

    .opt-summary{font-size:12px;color:var(--muted);margin-top:6px;}
    .opt-summary strong{color:#a7f3d0;}

    .hint{font-size:11px;color:var(--muted);margin-top:4px;}
    .hint-error{color:#fecaca;}

    .stats-form {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #111827;
    }
    .stats-form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      align-items: end;
    }
    .small-field label {
      font-size: 11px;
    }
    .small-field input {
      font-size: 12px;
      padding: 7px 9px;
    }

    .support-footer{
      margin-top:16px;
      display:flex;
      justify-content:flex-start;
    }

    .support-box{
      font-size:12px;
      color:var(--muted);
      padding:10px 14px;
      border-radius:16px;
      border:1px solid #1f2937;
      background:#020617;
      line-height:1.6;
    }

    .support-title{
      font-size:14px;
      color:#22c55e;
      font-weight:600;
      margin-bottom:4px;
      text-align:left;
    }

    .support-row{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .support-icon{
      font-size:13px;
    }

    footer{margin-top:4px;font-size:10px;color:#4b5563;text-align:right;}
    footer span{color:#a7f3d0;}
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- jsPDF -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    crossorigin="anonymous"
    onload="window.jsPDF = window.jspdf.jsPDF;"
  ></script>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand-group">
        <div class="brand">
          <div class="badge-logo">Lx</div>
          <div class="brand-text">
            <h1 id="text_brand">Logixperts</h1>
            <span id="text_subbrand">Smart Load Analyzer</span>
          </div>
        </div>

        <a href="index.html" id="back_link" class="back-link">
          â† Back to role selection
        </a>
      </div>

      <div class="header-right">
        <div class="company-code-pill" id="company_code_badge">
          <span id="company_code_label">Company code:</span>
          <span id="company_code_value"></span>
        </div>

        <div class="team-pill">
          <span id="team_label">Team:</span>&nbsp;<span>Logixperts</span> | <span id="team_event">Naqlthon 4</span>
        </div>

        <button class="lang-switch" id="langSwitcher" type="button">AR</button>
      </div>
    </header>

    <!-- HERO -->
    <section class="hero">
      <div class="hero-main">
        <p class="hero-title" id="hero_title">
          Reduce Empty Trips. Boost Load Factor. Go Greener.
        </p>

        <p class="hero-sub" id="hero_sub">
          Smart Load Analyzer helps freight companies analyze and optimize loads to reduce cost and emissions.
        </p>

        <div class="hero-tags">
          <div class="hero-tag">
            <strong>15â€“25%</strong>&nbsp;<span id="tag_fuel">fuel reduction (simulated)</span>
          </div>
          <div class="hero-tag">
            <strong>AI</strong>&nbsp;<span id="tag_ai">load & route suggestions</span>
          </div>
        </div>

        <div class="hero-highlight" id="hero_highlight">
          This demo scenario shows how merging a new shipment with a low-load return trip improves load factor.
        </div>
      </div>

      <div class="hero-metric">
        <div class="hero-metric-card">
          <h3 id="hero_avg_before_title">Avg load (baseline)</h3>
          <p id="hero-load-before">â€“</p>
        </div>

        <div class="hero-metric-card">
          <h3 id="hero_cost_title">Op. cost / day</h3>
          <p id="hero-cost-before">â€“</p>
        </div>

        <div class="hero-metric-card">
          <h3 id="hero_co2_title">COâ‚‚ / day</h3>
          <p id="hero-co2-before">â€“</p>
        </div>
      </div>
    </section>

    <!-- NAV TABS -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-view="login-view" id="tab_login">Login / Sign up</button>
      <button class="nav-tab" data-view="dashboard-view" id="tab_dashboard">Dashboard</button>
      <button class="nav-tab" data-view="analyze-view" id="tab_analyze">Analyze Load</button>
      <button class="nav-tab" data-view="optimization-view" id="tab_opt">Optimization Result</button>
      <button class="nav-tab" data-view="routing-view" id="tab_routing">AI Routing</button>
    </nav>

    <main>
      <!-- LOGIN -->
      <section id="login-view" class="view active">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="login_title">Company Login</div>
                <div class="card-sub" id="login_sub">
                  Access your Smart Load Analyzer workspace.
                </div>
              </div>
            </div>

            <form class="login-form" id="login_form">
              <div class="field">
                <label id="label_email">Company email</label>
                <input id="company" type="email" placeholder="demo@logixperts.sa" required />
              </div>

              <div class="field">
                <label id="label_password">Password</label>
                <div class="password-input">
                  <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
                  <button
                    type="button"
                    class="password-toggle"
                    id="password_toggle_login"
                  >
                    Show
                  </button>
                </div>
              </div>

              <button class="btn btn-primary" type="submit" id="login_btn">
                Login
              </button>

              <p class="hint" id="login_hint">
                Demo credentials: <strong>demo@logixperts.sa</strong> / <strong>Naqlthon4!</strong>
              </p>
              <p id="login-error" class="hint hint-error"></p>
            </form>
          </div>

          <!-- SIGNUP -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="signup_title">Create Company Account</div>
                <div class="card-sub" id="signup_sub">
                  Create your company account to access the system.
                </div>
              </div>
            </div>

            <form class="signup-form" id="signup_form">
              <div class="field">
                <label id="signup_label_name">Company name</label>
                <input id="signup-name" type="text" placeholder="e.g. Green Freight Co." required />
              </div>

              <div class="field">
                <label id="signup_label_email">Company email</label>
                <input id="signup-email" type="email" placeholder="you@company.sa" required />
              </div>

              <div class="field">
                <label id="signup_label_pass">Password</label>
                <div class="password-input">
                  <input id="signup-password" type="password" placeholder="Choose a strong password" required />
                  <button
                    type="button"
                    class="password-toggle"
                    id="password_toggle_signup"
                  >
                    Show
                  </button>
                </div>
              </div>

              <div class="field">
                <label id="signup_label_fleet">Fleet size (trucks)</label>
                <input id="signup-fleet" type="number" min="1" step="1" value="20" />
              </div>

              <div class="field">
                <label id="signup_label_plan">Subscription plan</label>
                <select id="signup-plan">
                  <option value="monthly">Starter â€“ 299 SAR / month</option>
                  <option value="6months">Growth â€“ 1,499 SAR / 6 months</option>
                  <option value="yearly">Enterprise â€“ 2,499 SAR / year</option>
                </select>
              </div>

              <button class="btn btn-secondary" id="signup_btn" type="submit">
                Sign up
              </button>
              <p id="signup-message" class="hint"></p>
            </form>
          </div>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section id="dashboard-view" class="view">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="dash_title">Fleet Overview Dashboard</div>
                <div class="card-sub" id="dash_sub">
                  4 demo trucks on main corridors.
                </div>
              </div>
              <span class="pill"><span class="pill-dot"></span> Demo scenario</span>
            </div>

            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="kpi-label" id="kpi_trucks_label">Trucks in scenario</div>
                <div class="kpi-value">4</div>
                <div class="kpi-footnote">Riyadh â†” Jeddah / Dammam</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_baseline_label">Avg load (baseline)</div>
                <div class="kpi-value" id="kpi-load-before">â€“</div>
                <div class="kpi-footnote" id="kpi_baseline_note">Before optimization</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_after_label">Avg load (after)</div>
                <div class="kpi-value" id="kpi-load-after">â€“</div>
                <div class="kpi-footnote" id="kpi_after_note">After last run</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_cost_before_label">Op. cost / day</div>
                <div class="kpi-value" id="kpi-cost-before">â€“</div>
                <div class="kpi-footnote" id="kpi_cost_before_note">Simulated SAR</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_cost_after_label">Op. cost / day (after)</div>
                <div class="kpi-value" id="kpi-cost-after">â€“</div>
                <div class="kpi-footnote" id="kpi-cost-savings">â€“</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_co2_before_label">COâ‚‚ / day</div>
                <div class="kpi-value" id="kpi-co2-before">â€“</div>
                <div class="kpi-footnote" id="kpi_co2_before_note">kg COâ‚‚</div>
              </div>

              <div class="kpi-card">
                <div class="kpi-label" id="kpi_co2_after_label">COâ‚‚ / day (after)</div>
                <div class="kpi-value" id="kpi-co2-after">â€“</div>
                <div class="kpi-footnote" id="kpi-co2-savings">â€“</div>
              </div>
            </div>

            <!-- Company metrics form -->
            <div class="stats-form">
              <div class="stats-form-row">
                <div class="field small-field">
                  <label id="stats_label_load">Company avg load (%)</label>
                  <input id="stats-load" type="number" min="0" max="100" step="1" />
                </div>
                <div class="field small-field">
                  <label id="stats_label_cost">Company op. cost / day (SAR)</label>
                  <input id="stats-cost" type="number" min="0" step="1" />
                </div>
                <div class="field small-field">
                  <label id="stats_label_co2">Company COâ‚‚ / day (kg)</label>
                  <input id="stats-co2" type="number" min="0" step="1" />
                </div>
                <div class="field small-field">
                  <label>&nbsp;</label>
                  <button class="btn btn-secondary" type="button" id="stats-save-btn">
                    Save metrics
                  </button>
                </div>
              </div>
              <p class="hint" id="stats_hint"></p>
            </div>

            <canvas id="dashboardChart"></canvas>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="map_title">Truck Positions & Routes</div>
                <div class="card-sub" id="map_sub">
                  Best routes + load factor markers.
                </div>
              </div>
            </div>
            <div id="map"></div>
          </div>
        </div>
      </section>

      <!-- ANALYZE -->
      <section id="analyze-view" class="view">
        <div class="analyze-grid">
          <!-- MANUAL -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="analyze_title">
                  Analyze New Shipment (Manual)
                </div>
                <div class="card-sub" id="analyze_sub">
                  Enter shipment details manually.
                </div>
              </div>
            </div>

            <form class="analyze-form" id="manual_analyze_form">
              <div class="field">
                <label id="label_weight">Weight (tons)</label>
                <input id="weight" type="number" min="0" step="0.1" value="8" />
              </div>

              <div class="field">
                <label id="label_volume">Volume (mÂ³)</label>
                <input id="volume" type="number" min="0" step="1" value="28" />
              </div>

              <div class="field">
                <label id="label_destination">Destination city</label>
                <input id="destination" type="text" value="Riyadh" />
              </div>

              <div class="field">
                <label id="label_delivery">Delivery window</label>
                <input id="deliveryTime" type="text" value="Within 24 hours" />
              </div>

              <div class="field">
                <label id="label_priority">Priority</label>
                <select id="priority">
                  <option value="normal">Normal</option>
                  <option value="high">High priority</option>
                  <option value="low">Low / backhaul</option>
                </select>
              </div>

              <button class="btn btn-primary" id="btn_manual_analyze" type="submit">
                Run Manual Optimization
              </button>
            </form>
          </div>

          <!-- CSV UPLOAD -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="csv_title">Upload Your Trips CSV</div>
                <div class="card-sub" id="csv_sub">
                  Upload trip history to improve optimization accuracy.
                </div>
              </div>
            </div>

            <form class="signup-form" id="csv_form">
              <div class="field">
                <label id="csv_label">Choose CSV file</label>
                <input id="csv_file" type="file" accept=".csv" />
              </div>

              <button class="btn btn-secondary" id="btn_csv" type="submit">
                Analyze CSV
              </button>

              <p id="csv_message" class="hint"></p>
            </form>
          </div>

          <!-- PDF AI REPORT -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="pdf_title">PDF AI Report</div>
                <div class="card-sub" id="pdf_sub">
                  Generate a printable KPI report for your company based on the current demo optimization.
                </div>
              </div>
            </div>

            <p class="hint" id="pdf_hint">
              This is a demo PDF report for Naqlthon showing KPIs, per-truck loads and recommendations for small carriers.
            </p>

            <button
              class="btn btn-secondary"
              type="button"
              id="pdf_btn"
            >
              Generate PDF Report
            </button>

            <p id="pdf_message" class="hint"></p>
          </div>
        </div>
      </section>

      <!-- OPTIMIZATION -->
      <section id="optimization-view" class="view">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="opt_title">Optimization Result</div>
                <div class="card-sub" id="opt_sub">Recommended load distribution.</div>
              </div>
            </div>

            <div class="truck-list" id="truck-list">
              <div class="truck-row header">
                <div id="opt_col_truck">Truck & Route</div>
                <div id="opt_col_load">Load Factor</div>
                <div id="opt_col_ai">AI Suggestion</div>
              </div>
            </div>

            <p class="opt-summary" id="opt-summary">
              Run manual or CSV analysis to see results.
            </p>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="chart_title">Before vs After Optimization</div>
                <div class="card-sub" id="chart_sub">Average load improvement</div>
              </div>
            </div>
            <canvas id="optChart"></canvas>
          </div>
        </div>
      </section>

      <!-- AI ROUTING -->
      <section id="routing-view" class="view">
        <div class="two-column">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="routing_title">AI Routing Assistant</div>
                <div class="card-sub" id="routing_sub">
                  Choose origin, destination and objective to see a suggested route scenario.
                </div>
              </div>
            </div>

            <form class="analyze-form" id="routing_form">
              <div class="field">
                <label id="routing_label_origin">Origin city</label>
                <select id="routing-origin">
                  <option value="riyadh">Riyadh</option>
                  <option value="jeddah">Jeddah</option>
                  <option value="dammam">Dammam</option>
                </select>
              </div>

              <div class="field">
                <label id="routing_label_dest">Destination city</label>
                <select id="routing-dest">
                  <option value="jeddah">Jeddah</option>
                  <option value="riyadh">Riyadh</option>
                  <option value="dammam">Dammam</option>
                </select>
              </div>

              <div class="field">
                <label id="routing_label_objective">Objective</label>
                <select id="routing-objective">
                  <option value="cost">Minimize operating cost</option>
                  <option value="load">Maximize load factor</option>
                  <option value="co2">Minimize COâ‚‚ emissions</option>
                </select>
              </div>

              <div class="field">
                <label id="routing_label_backhaul">Backhaul / round trip?</label>
                <select id="routing-backhaul">
                  <option value="yes">Yes â€“ prefer round trip</option>
                  <option value="no">No â€“ one-way only</option>
                </select>
              </div>

              <button class="btn btn-primary" id="routing_btn" type="submit">
                Run AI Routing
              </button>
            </form>

            <p class="hint" id="routing_hint">
              This is a demo AI-routing helper. In a production version, it would use real trip history + constraints.
            </p>
            <p class="hint" id="routing_message"></p>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title" id="routing_map_title">Routing Map</div>
                <div class="card-sub" id="routing_map_sub">
                  Suggested path and main hubs.
                </div>
              </div>
            </div>
            <div id="ai-routing-map"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- SUPPORT -->
    <div class="support-footer">
      <div class="support-box">
        <div class="support-title" id="support_title">Customer Support</div>
        <div class="support-row">
          <span class="support-icon">ğŸ“</span>
          <span id="support_phone_label">Phone:</span>&nbsp;<span>+966 55 555 5555</span>
        </div>
        <div class="support-row">
          <span class="support-icon">ğŸ“§</span>
          <span id="support_email_label">Email:</span>&nbsp;<span>support@logixperts.com</span>
        </div>
        <div class="support-row">
          <span class="support-icon">ğŸ“ </span>
          <span id="support_fax_label">Fax:</span>&nbsp;<span>011-1234567</span>
        </div>
      </div>
    </div>

    <footer>
      Logixperts Â· Smart Load Analyzer Â· Naqlthon 4
    </footer>
  </div>

  <!-- ===== Firebase + Logic ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      addDoc,
      getDoc,
      collection,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjbvQo7NrGZiFbFbdY3a7UtDjlv0SwU3w",
      authDomain: "smart-load-analyzer-56cb2.firebaseapp.com",
      projectId: "smart-load-analyzer-56cb2",
      storageBucket: "smart-load-analyzer-56cb2.firebasestorage.app",
      messagingSenderId: "253721588070",
      appId: "1:253721588070:web:c24bc2fbc27c2fba9e18a7",
      measurementId: "G-60RF97SGWN"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== STATE =====
    let currentLang = "en";
    let isLoggedIn = false;
    let currentCompanyId = null;
    let currentCompanyData = null;
    let companyStats = null;

    const CAPACITY_TONS = 20;
    const BASE_TRIP_COST = 1000;
    const EMISSION_FACTOR = 2.7;

    const trucksScenario = [
      { id: "Truck #1", origin: "Riyadh", dest: "Jeddah",  currentLoad: 0.75, coords: [24.7136, 46.6753] },
      { id: "Truck #2", origin: "Jeddah", dest: "Riyadh",  currentLoad: 0.40, coords: [21.4858, 39.1925] },
      { id: "Truck #3", origin: "Riyadh", dest: "Dammam", currentLoad: 0.65, coords: [24.7136, 46.6753] },
      { id: "Truck #4", origin: "Dammam", dest: "Riyadh", currentLoad: 0.50, coords: [26.4207, 50.0888] },
    ];

    const cityCoords = {
      riyadh:  [24.7136, 46.6753],
      jeddah:  [21.4858, 39.1925],
      dammam:  [26.4207, 50.0888],
    };

    let baselineAvgLoad =
      trucksScenario.reduce((sum, t) => sum + t.currentLoad, 0) / trucksScenario.length;
    let baselineCost = trucksScenario.length * BASE_TRIP_COST;
    let baselineCO2  = baselineCost * EMISSION_FACTOR;

    // last optimization for PDF
    let lastOptimizationLoads = null;  // { "Truck #1": {before, after}, ... }
    let lastAfterAvgLoad = null;
    let lastCostAfter = null;
    let lastCo2After = null;

    let dashboardChart = null;
    let optChart = null;
    let mapInstance = null;
    let aiRoutingMap = null;
    let aiRoutingLayer = null;

    // ===== LANGUAGE HANDLING (Ø¨Ø³ÙŠØ· ÙˆÙˆØ§Ø¶Ø­) =====
    function applyLanguage() {
      const html = document.documentElement;

      if (currentLang === "ar") {
        html.lang = "ar";
        html.dir  = "rtl";

        document.getElementById("langSwitcher").textContent = "EN";

        document.getElementById("text_brand").textContent = "Logixperts";
        document.getElementById("text_subbrand").textContent = "Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ";
        document.getElementById("back_link").textContent = "â† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±";

        document.getElementById("hero_title").textContent =
          "Ù‚Ù„Ù‘Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©ØŒ ÙˆØ§Ø±ÙØ¹ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ ÙˆØ®ÙÙ‘Ø¶ Ø§Ù„Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª.";
        document.getElementById("hero_sub").textContent =
          "ÙŠØ³Ø§Ø¹Ø¯Ùƒ Smart Load Analyzer Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ ÙˆØªØ­Ø³ÙŠÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª.";
        document.getElementById("tag_fuel").textContent = "ØªØ®ÙÙŠØ¶ ÙˆÙ‚ÙˆØ¯ (Ù…Ø­Ø§ÙƒØ§Ø©)";
        document.getElementById("tag_ai").textContent = "Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø³Ø§Ø±Ø§Øª Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ";
        document.getElementById("hero_highlight").textContent =
          "Ù‡Ø°Ø§ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ØªØ¬Ø±ÙŠØ¨ÙŠ ÙŠÙˆØ¶Ù‘Ø­ ÙƒÙŠÙ ÙŠØ±ÙØ¹ Ø¯Ù…Ø¬ Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø±Ø­Ù„Ø© Ø¹ÙˆØ¯Ø© Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ù…ÙˆÙ„Ø©.";

        document.getElementById("hero_avg_before_title").textContent = "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (Ø§Ù„Ø£Ø³Ø§Ø³)";
        document.getElementById("hero_cost_title").textContent = "ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„ / Ø§Ù„ÙŠÙˆÙ…";
        document.getElementById("hero_co2_title").textContent = "Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª COâ‚‚ / Ø§Ù„ÙŠÙˆÙ…";

        document.getElementById("tab_login").textContent = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨";
        document.getElementById("tab_dashboard").textContent = "Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©";
        document.getElementById("tab_analyze").textContent = "ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
        document.getElementById("tab_opt").textContent = "Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ†";
        document.getElementById("tab_routing").textContent = "ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ";

        document.getElementById("login_title").textContent = "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ø±ÙƒØ©";
        document.getElementById("login_sub").textContent   = "Ø§Ø¯Ø®Ù„ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Smart Load Analyzer.";
        document.getElementById("label_email").textContent = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø´Ø±ÙƒØ©";
        document.getElementById("label_password").textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
        document.getElementById("login_btn").textContent = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        document.getElementById("login_hint").textContent =
          "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠØ©: demo@logixperts.sa / Naqlthon4!";

        document.getElementById("signup_title").textContent = "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø´Ø±ÙƒØ©";
        document.getElementById("signup_sub").textContent = "Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨ Ø´Ø±ÙƒØªÙƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù….";
        document.getElementById("signup_label_name").textContent = "Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©";
        document.getElementById("signup_label_email").textContent = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø´Ø±ÙƒØ©";
        document.getElementById("signup_label_pass").textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
        document.getElementById("signup_label_fleet").textContent = "Ø­Ø¬Ù… Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ (Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª)";
        document.getElementById("signup_label_plan").textContent = "Ø§Ù„Ø¨Ø§Ù‚Ø©";
        document.getElementById("signup_btn").textContent = "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨";

        document.getElementById("dash_title").textContent = "Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„";
        document.getElementById("dash_sub").textContent   = "4 Ø´Ø§Ø­Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¹Ù„Ù‰ Ø£Ù‡Ù… Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª.";
        document.getElementById("kpi_trucks_label").textContent = "Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ";
        document.getElementById("kpi_baseline_label").textContent = "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (Ø§Ù„Ø£Ø³Ø§Ø³)";
        document.getElementById("kpi_baseline_note").textContent = "Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø³ÙŠÙ†";
        document.getElementById("kpi_after_label").textContent = "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (Ø¨Ø¹Ø¯)";
        document.getElementById("kpi_after_note").textContent = "Ø¨Ø¹Ø¯ Ø¢Ø®Ø± ØªØ´ØºÙŠÙ„";
        document.getElementById("kpi_cost_before_label").textContent = "ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„ / Ø§Ù„ÙŠÙˆÙ…";
        document.getElementById("kpi_cost_before_note").textContent = "Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ (Ù…Ø­Ø§ÙƒØ§Ø©)";
        document.getElementById("kpi_cost_after_label").textContent = "ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„ / Ø§Ù„ÙŠÙˆÙ… (Ø¨Ø¹Ø¯)";
        document.getElementById("kpi_co2_before_label").textContent = "COâ‚‚ / Ø§Ù„ÙŠÙˆÙ…";
        document.getElementById("kpi_co2_before_note").textContent = "ÙƒØ¬Ù… COâ‚‚";
        document.getElementById("kpi_co2_after_label").textContent = "COâ‚‚ / Ø§Ù„ÙŠÙˆÙ… (Ø¨Ø¹Ø¯)";

        document.getElementById("stats_label_load").textContent = "Ù…ØªÙˆØ³Ø· Ø­Ù…ÙˆÙ„Ø© Ø§Ù„Ø´Ø±ÙƒØ© (%)";
        document.getElementById("stats_label_cost").textContent = "ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø±ÙŠØ§Ù„)";
        document.getElementById("stats_label_co2").textContent = "Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª COâ‚‚ / Ø§Ù„ÙŠÙˆÙ… (ÙƒØ¬Ù…)";
        document.getElementById("stats-save-btn").textContent   = "Ø­ÙØ¸ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©";

        document.getElementById("map_title").textContent = "Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø´Ø§Ø­Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª";
        document.getElementById("map_sub").textContent   = "Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª + Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„.";

        document.getElementById("analyze_title").textContent = "ØªØ­Ù„ÙŠÙ„ Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø© (ÙŠØ¯ÙˆÙŠ)";
        document.getElementById("analyze_sub").textContent   = "Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§.";
        document.getElementById("label_weight").textContent  = "Ø§Ù„ÙˆØ²Ù† (Ø¨Ø§Ù„Ø·Ù†)";
        document.getElementById("label_volume").textContent  = "Ø§Ù„Ø­Ø¬Ù… (Ù…Â³)";
        document.getElementById("label_destination").textContent = "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØ¬Ù‡Ø©";
        document.getElementById("label_delivery").textContent = "Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…";
        document.getElementById("label_priority").textContent = "Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©";
        document.getElementById("btn_manual_analyze").textContent = "ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙŠØ¯ÙˆÙŠ";

        document.getElementById("csv_title").textContent = "Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø±Ø­Ù„Ø§Øª (CSV)";
        document.getElementById("csv_sub").textContent   = "Ø§Ø±ÙØ¹ Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø¯Ù‚Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„.";
        document.getElementById("csv_label").textContent = "Ø§Ø®ØªØ± Ù…Ù„Ù CSV";
        document.getElementById("btn_csv").textContent   = "ØªØ­Ù„ÙŠÙ„ CSV";

        document.getElementById("pdf_title").textContent = "ØªÙ‚Ø±ÙŠØ± PDF Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ";
        document.getElementById("pdf_sub").textContent   =
          "Ø£Ù†Ø´Ø¦ ØªÙ‚Ø±ÙŠØ± KPIs Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±ÙŠØ¨ÙŠØ©.";
        document.getElementById("pdf_hint").textContent =
          "Ù‡Ø°Ø§ ØªÙ‚Ø±ÙŠØ± ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù†Ø§Ù‚Ù„ ØµØºÙŠØ± ÙÙŠ Ù†Ù‚Ù„ Ø«ÙˆÙ† ÙŠÙˆØ¶Ø­ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ØªÙˆÙÙŠØ± ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª.";
        document.getElementById("pdf_btn").textContent   = "Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF";

        document.getElementById("opt_title").textContent = "Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ø³ÙŠÙ†";
        document.getElementById("opt_sub").textContent   = "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­.";
        document.getElementById("opt_col_truck").textContent = "Ø§Ù„Ø´Ø§Ø­Ù†Ø© ÙˆØ§Ù„Ù…Ø³Ø§Ø±";
        document.getElementById("opt_col_load").textContent  = "Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„";
        document.getElementById("opt_col_ai").textContent    = "Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ";
        document.getElementById("chart_title").textContent   = "Ù‚Ø¨Ù„ / Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø³ÙŠÙ†";
        document.getElementById("chart_sub").textContent     = "ØªØ­Ø³Ù† Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø©";

        document.getElementById("routing_title").textContent = "Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ";
        document.getElementById("routing_sub").textContent =
          "Ø§Ø®ØªØ± Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØ¬Ù‡Ø© ÙˆØ§Ù„Ù‡Ø¯Ù Ù„ØªØ±Ù‰ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù…Ø³Ø§Ø± Ù…Ù‚ØªØ±Ø­.";
        document.getElementById("routing_label_origin").textContent = "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚";
        document.getElementById("routing_label_dest").textContent   = "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„";
        document.getElementById("routing_label_objective").textContent = "Ø§Ù„Ù‡Ø¯Ù";
        document.getElementById("routing_label_backhaul").textContent  = "Ø±Ø­Ù„Ø© Ø°Ù‡Ø§Ø¨ ÙˆØ¹ÙˆØ¯Ø©ØŸ";
        document.getElementById("routing_btn").textContent = "ØªØ´ØºÙŠÙ„ AI Routing";
        document.getElementById("routing_hint").textContent =
          "Ù‡Ø°Ù‡ Ø£Ø¯Ø§Ø© ØªÙˆØ¬ÙŠÙ‡ ØªØ¬Ø±ÙŠØ¨ÙŠØ©. Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø³ØªØ³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ø­Ù„Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆÙ‚ÙŠÙˆØ¯ ØªØ´ØºÙŠÙ„ÙŠØ©.";

        document.getElementById("routing_map_title").textContent = "Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡";
        document.getElementById("routing_map_sub").textContent   = "Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ ÙˆØ£Ù‡Ù… Ø§Ù„Ù…Ø­Ø§ÙˆØ±.";

        document.getElementById("support_title").textContent = "Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡";
        document.getElementById("support_phone_label").textContent = "Ù‡Ø§ØªÙ:";
        document.getElementById("support_email_label").textContent = "Ø§Ù„Ø¨Ø±ÙŠØ¯:";
        document.getElementById("support_fax_label").textContent   = "ÙØ§ÙƒØ³:";
        document.getElementById("company_code_label").textContent  = "ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±ÙƒØ©:";
        document.getElementById("team_label").textContent = "Ø§Ù„ÙØ±ÙŠÙ‚:";
      } else {
        html.lang = "en";
        html.dir  = "ltr";

        document.getElementById("langSwitcher").textContent = "AR";

        document.getElementById("text_brand").textContent = "Logixperts";
        document.getElementById("text_subbrand").textContent = "Smart Load Analyzer";
        document.getElementById("back_link").textContent = "â† Back to role selection";

        document.getElementById("hero_title").textContent =
          "Reduce Empty Trips. Boost Load Factor. Go Greener.";
        document.getElementById("hero_sub").textContent =
          "Smart Load Analyzer helps freight companies analyze and optimize loads to reduce cost and emissions.";
        document.getElementById("tag_fuel").textContent = "fuel reduction (simulated)";
        document.getElementById("tag_ai").textContent   = "load & route suggestions";
        document.getElementById("hero_highlight").textContent =
          "This demo scenario shows how merging a new shipment with a low-load return trip improves load factor.";

        document.getElementById("hero_avg_before_title").textContent = "Avg load (baseline)";
        document.getElementById("hero_cost_title").textContent       = "Op. cost / day";
        document.getElementById("hero_co2_title").textContent        = "COâ‚‚ / day";

        document.getElementById("tab_login").textContent = "Login / Sign up";
        document.getElementById("tab_dashboard").textContent = "Dashboard";
        document.getElementById("tab_analyze").textContent = "Analyze Load";
        document.getElementById("tab_opt").textContent = "Optimization Result";
        document.getElementById("tab_routing").textContent = "AI Routing";

        document.getElementById("login_title").textContent = "Company Login";
        document.getElementById("login_sub").textContent   =
          "Access your Smart Load Analyzer workspace.";
        document.getElementById("label_email").textContent = "Company email";
        document.getElementById("label_password").textContent = "Password";
        document.getElementById("login_btn").textContent = "Login";
        document.getElementById("login_hint").textContent =
          "Demo credentials: demo@logixperts.sa / Naqlthon4!";

        document.getElementById("signup_title").textContent = "Create Company Account";
        document.getElementById("signup_sub").textContent   =
          "Create your company account to access the system.";
        document.getElementById("signup_label_name").textContent  = "Company name";
        document.getElementById("signup_label_email").textContent = "Company email";
        document.getElementById("signup_label_pass").textContent  = "Password";
        document.getElementById("signup_label_fleet").textContent = "Fleet size (trucks)";
        document.getElementById("signup_label_plan").textContent  = "Subscription plan";
        document.getElementById("signup_btn").textContent         = "Sign up";

        document.getElementById("dash_title").textContent = "Fleet Overview Dashboard";
        document.getElementById("dash_sub").textContent   = "4 demo trucks on main corridors.";
        document.getElementById("kpi_trucks_label").textContent = "Trucks in scenario";
        document.getElementById("kpi_baseline_label").textContent = "Avg load (baseline)";
        document.getElementById("kpi_baseline_note").textContent  = "Before optimization";
        document.getElementById("kpi_after_label").textContent    = "Avg load (after)";
        document.getElementById("kpi_after_note").textContent     = "After last run";
        document.getElementById("kpi_cost_before_label").textContent = "Op. cost / day";
        document.getElementById("kpi_cost_before_note").textContent  = "Simulated SAR";
        document.getElementById("kpi_cost_after_label").textContent  = "Op. cost / day (after)";
        document.getElementById("kpi_co2_before_label").textContent  = "COâ‚‚ / day";
        document.getElementById("kpi_co2_before_note").textContent   = "kg COâ‚‚";
        document.getElementById("kpi_co2_after_label").textContent   = "COâ‚‚ / day (after)";

        document.getElementById("stats_label_load").textContent = "Company avg load (%)";
        document.getElementById("stats_label_cost").textContent = "Company op. cost / day (SAR)";
        document.getElementById("stats_label_co2").textContent  = "Company COâ‚‚ / day (kg)";
        document.getElementById("stats-save-btn").textContent   = "Save metrics";

        document.getElementById("map_title").textContent = "Truck Positions & Routes";
        document.getElementById("map_sub").textContent   = "Best routes + load factor markers.";

        document.getElementById("analyze_title").textContent = "Analyze New Shipment (Manual)";
        document.getElementById("analyze_sub").textContent   =
          "Enter shipment details manually.";
        document.getElementById("label_weight").textContent  = "Weight (tons)";
        document.getElementById("label_volume").textContent  = "Volume (mÂ³)";
        document.getElementById("label_destination").textContent = "Destination city";
        document.getElementById("label_delivery").textContent    = "Delivery window";
        document.getElementById("label_priority").textContent    = "Priority";
        document.getElementById("btn_manual_analyze").textContent = "Run Manual Optimization";

        document.getElementById("csv_title").textContent = "Upload Your Trips CSV";
        document.getElementById("csv_sub").textContent   =
          "Upload trip history to improve optimization accuracy.";
        document.getElementById("csv_label").textContent = "Choose CSV file";
        document.getElementById("btn_csv").textContent   = "Analyze CSV";

        document.getElementById("pdf_title").textContent = "PDF AI Report";
        document.getElementById("pdf_sub").textContent   =
          "Generate a printable KPI report for your company based on the current demo optimization.";
        document.getElementById("pdf_hint").textContent =
          "This is a demo PDF report for Naqlthon showing KPIs, per-truck loads and recommendations for small carriers.";
        document.getElementById("pdf_btn").textContent   = "Generate PDF Report";

        document.getElementById("opt_title").textContent = "Optimization Result";
        document.getElementById("opt_sub").textContent   = "Recommended load distribution.";
        document.getElementById("opt_col_truck").textContent = "Truck & Route";
        document.getElementById("opt_col_load").textContent  = "Load Factor";
        document.getElementById("opt_col_ai").textContent    = "AI Suggestion";
        document.getElementById("chart_title").textContent   = "Before vs After Optimization";
        document.getElementById("chart_sub").textContent     = "Average load improvement";

        document.getElementById("routing_title").textContent = "AI Routing Assistant";
        document.getElementById("routing_sub").textContent =
          "Choose origin, destination and objective to see a suggested route scenario.";
        document.getElementById("routing_label_origin").textContent  = "Origin city";
        document.getElementById("routing_label_dest").textContent    = "Destination city";
        document.getElementById("routing_label_objective").textContent = "Objective";
        document.getElementById("routing_label_backhaul").textContent  = "Backhaul / round trip?";
        document.getElementById("routing_btn").textContent = "Run AI Routing";
        document.getElementById("routing_hint").textContent =
          "This is a demo AI-routing helper. In a production version, it would use real trip history + constraints.";

        document.getElementById("routing_map_title").textContent = "Routing Map";
        document.getElementById("routing_map_sub").textContent   = "Suggested path and main hubs.";

        document.getElementById("support_title").textContent = "Customer Support";
        document.getElementById("support_phone_label").textContent = "Phone:";
        document.getElementById("support_email_label").textContent = "Email:";
        document.getElementById("support_fax_label").textContent   = "Fax:";
        document.getElementById("company_code_label").textContent  = "Company code:";
        document.getElementById("team_label").textContent          = "Team:";
      }
    }

    function toggleLanguage() {
      currentLang = currentLang === "en" ? "ar" : "en";
      applyLanguage();
    }

    function togglePassword(inputId, btn) {
      const el = document.getElementById(inputId);
      if (!el) return;
      if (el.type === "password") {
        el.type = "text";
        btn.textContent = currentLang === "ar" ? "Ø¥Ø®ÙØ§Ø¡" : "Hide";
      } else {
        el.type = "password";
        btn.textContent = currentLang === "ar" ? "Ø¥Ø¸Ù‡Ø§Ø±" : "Show";
      }
    }

    // ===== NAV & VIEWS =====
    function setActiveView(viewId) {
      const views = document.querySelectorAll(".view");
      views.forEach(v => v.classList.remove("active"));
      const active = document.getElementById(viewId);
      if (active) active.classList.add("active");

      const tabs = document.querySelectorAll(".nav-tab");
      tabs.forEach(t => {
        t.classList.toggle("active", t.dataset.view === viewId);
      });

      if (viewId === "dashboard-view") {
        initMap();
      } else if (viewId === "routing-view") {
        initRoutingMap();
      }
    }

    function guardAndSetView(viewId) {
      if (viewId !== "login-view" && !isLoggedIn) {
        const msg = currentLang === "ar"
          ? "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©."
          : "Please log in first to access this section.";
        alert(msg);
        return;
      }
      setActiveView(viewId);
    }

    // ===== FIREBASE HELPERS =====
    async function signUp(e) {
      if (e) e.preventDefault();
      const name  = document.getElementById("signup-name").value.trim();
      const email = document.getElementById("signup-email").value.trim();
      const pass  = document.getElementById("signup-password").value;
      const fleet = parseInt(document.getElementById("signup-fleet").value || "0", 10);
      const plan  = document.getElementById("signup-plan").value;
      const msgEl = document.getElementById("signup-message");
      msgEl.textContent = "";

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const uid  = cred.user.uid;
        const companyCode = uid.slice(0, 6).toUpperCase();

        await setDoc(doc(db, "companies", uid), {
          name,
          email,
          fleetSize: isNaN(fleet) ? null : fleet,
          plan,
          companyCode,
          createdAt: serverTimestamp()
        });

        currentCompanyId   = uid;
        currentCompanyData = { name, email, fleetSize: fleet, plan, companyCode };
        isLoggedIn = true;

        showCompanyCode(companyCode);
        showAppTabsAfterLogin();
        await initCompanyStats(uid);

        msgEl.textContent = currentLang === "ar"
          ? "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­. ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ."
          : "Account created successfully. You are now logged in.";

        setActiveView("dashboard-view");
      } catch (err) {
        console.error(err);
        msgEl.textContent = currentLang === "ar"
          ? "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨."
          : "Failed to sign up. Please check your data.";
      }
    }

    async function demoLogin(e) {
      if (e) e.preventDefault();
      const email = (document.getElementById("company").value || "").trim();
      const pass  = document.getElementById("password").value;
      const errEl = document.getElementById("login-error");
      errEl.textContent = "";

      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        const user = cred.user;
        currentCompanyId = user.uid;
        isLoggedIn = true;

        const ref = doc(db, "companies", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          currentCompanyData = snap.data();
        } else {
          const companyCode = user.uid.slice(0, 6).toUpperCase();
          currentCompanyData = { name: "Demo Company", email, companyCode };
          await setDoc(ref, {
            name: "Demo Company",
            email,
            companyCode,
            createdAt: serverTimestamp()
          });
        }

        showCompanyCode(currentCompanyData.companyCode || currentCompanyId.slice(0,6).toUpperCase());
        showAppTabsAfterLogin();
        await initCompanyStats(currentCompanyId);

        setActiveView("dashboard-view");
      } catch (err) {
        console.error(err);
        errEl.textContent = currentLang === "ar"
          ? "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©."
          : "Invalid login credentials.";
      }
    }

    function showCompanyCode(code) {
      const badge = document.getElementById("company_code_badge");
      const val   = document.getElementById("company_code_value");
      if (badge && val) {
        val.textContent = code;
        badge.style.display = "inline-flex";
      }
    }

    function showAppTabsAfterLogin() {
      document.getElementById("tab_dashboard").style.display = "inline-flex";
      document.getElementById("tab_analyze").style.display   = "inline-flex";
      document.getElementById("tab_opt").style.display       = "inline-flex";
      document.getElementById("tab_routing").style.display   = "inline-flex";
    }

    async function initCompanyStats(uid) {
      try {
        const ref  = doc(db, "companies", uid, "stats", "main");
        const snap = await getDoc(ref);
        if (snap.exists()) {
          companyStats = snap.data();
        } else {
          companyStats = null;
        }
      } catch (e) {
        console.error(e);
        companyStats = null;
      }

      const loadEl = document.getElementById("stats-load");
      const costEl = document.getElementById("stats-cost");
      const co2El  = document.getElementById("stats-co2");

      if (companyStats && companyStats.avgLoad != null) {
        loadEl.value = companyStats.avgLoad;
        costEl.value = companyStats.opCost;
        co2El.value  = companyStats.co2PerDay;
      } else {
        loadEl.value = "";
        costEl.value = "";
        co2El.value  = "";
      }

      // hero + KPIs baseline from scenario
      updateBaselineKpis();
    }

    async function saveCompanyStats() {
      if (!isLoggedIn || !currentCompanyId) return;
      const load = parseFloat(document.getElementById("stats-load").value || "0");
      const cost = parseFloat(document.getElementById("stats-cost").value || "0");
      const co2  = parseFloat(document.getElementById("stats-co2").value || "0");
      const hint = document.getElementById("stats_hint");

      try {
        await setDoc(doc(db, "companies", currentCompanyId, "stats", "main"), {
          avgLoad: isNaN(load) ? null : load,
          opCost: isNaN(cost) ? null : cost,
          co2PerDay: isNaN(co2) ? null : co2,
          updatedAt: serverTimestamp()
        });

        companyStats = {
          avgLoad: isNaN(load) ? null : load,
          opCost: isNaN(cost) ? null : cost,
          co2PerDay: isNaN(co2) ? null : co2
        };

        hint.textContent = currentLang === "ar"
          ? "ØªÙ… Ø­ÙØ¸ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­."
          : "Company metrics saved.";
        updateBaselineKpis();
      } catch (e) {
        console.error(e);
        hint.textContent = currentLang === "ar"
          ? "ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."
          : "Failed to save metrics.";
      }
    }

    async function saveOptimizationResult(uid, payload) {
      try {
        await addDoc(collection(db, "companies", uid, "optimizations"), {
          ...payload,
          createdAt: serverTimestamp()
        });
      } catch (e) {
        console.error("Failed to save optimization result:", e);
      }
    }

    function updateBaselineKpis() {
      let baseLoad   = baselineAvgLoad;
      let costBefore = baselineCost;
      let co2Before  = baselineCO2;

      if (companyStats && companyStats.avgLoad != null) {
        baseLoad = companyStats.avgLoad / 100;
      }
      if (companyStats && companyStats.opCost != null) {
        costBefore = companyStats.opCost;
      }
      if (companyStats && companyStats.co2PerDay != null) {
        co2Before = companyStats.co2PerDay;
      }

      baselineAvgLoad = baseLoad;
      baselineCost    = costBefore;
      baselineCO2     = co2Before;

      document.getElementById("hero-load-before").textContent =
        (baselineAvgLoad * 100).toFixed(0) + "%";
      document.getElementById("hero-cost-before").textContent =
        "~" + baselineCost.toFixed(0) + " SAR";
      document.getElementById("hero-co2-before").textContent =
        "~" + baselineCO2.toFixed(0) + " kg";

      document.getElementById("kpi-load-before").textContent =
        (baselineAvgLoad * 100).toFixed(0) + "%";
      document.getElementById("kpi-cost-before").textContent =
        "~" + baselineCost.toFixed(0) + " SAR";
      document.getElementById("kpi-co2-before").textContent =
        "~" + baselineCO2.toFixed(0) + " kg";

      if (!dashboardChart) {
        initCharts(baselineAvgLoad, baselineAvgLoad);
      } else {
        dashboardChart.data.datasets[0].data[0] = baselineAvgLoad * 100;
        dashboardChart.update();
      }
    }

    // ===== CHARTS =====
    function initCharts(baseLoad, afterLoad) {
      const dashCtx = document.getElementById("dashboardChart");
      const optCtx  = document.getElementById("optChart");
      if (!dashCtx || !optCtx || !window.Chart) return;

      dashboardChart = new Chart(dashCtx, {
        type: "bar",
        data: {
          labels: ["Baseline", "After"],
          datasets: [{
            label: "Avg Load (%)",
            data: [baseLoad * 100, afterLoad * 100],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });

      optChart = new Chart(optCtx, {
        type: "bar",
        data: {
          labels: ["Before", "After"],
          datasets: [{
            label: "Avg Load (%)",
            data: [baseLoad * 100, afterLoad * 100],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    }

    function updateOptChart(afterLoad) {
      if (!optChart) return;
      optChart.data.datasets[0].data[1] = afterLoad * 100;
      optChart.update();

      if (dashboardChart) {
        dashboardChart.data.datasets[0].data[1] = afterLoad * 100;
        dashboardChart.update();
      }
    }

    // ===== MAPS =====
    function initMap() {
      if (mapInstance || !window.L) return;

      mapInstance = L.map("map").setView([24.7136, 46.6753], 5.8);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: ""
      }).addTo(mapInstance);

      trucksScenario.forEach(tr => {
        const color =
          tr.currentLoad < 0.5 ? "#ef4444" :
          tr.currentLoad < 0.7 ? "#f97316" : "#22c55e";

        const circle = L.circleMarker(tr.coords, {
          radius: 7,
          color,
          fillColor: color,
          fillOpacity: 0.9
        }).addTo(mapInstance);

        circle.bindPopup(
          `<strong>${tr.id}</strong><br>${tr.origin} â†’ ${tr.dest}<br>` +
          `Load: ${(tr.currentLoad * 100).toFixed(0)}%`
        );
      });

      // Simple corridors
      L.polyline([cityCoords.riyadh, cityCoords.jeddah], { weight: 2 }).addTo(mapInstance);
      L.polyline([cityCoords.riyadh, cityCoords.dammam], { weight: 2 }).addTo(mapInstance);
    }

    function initRoutingMap() {
      if (aiRoutingMap || !window.L) return;

      aiRoutingMap = L.map("ai-routing-map").setView([23.5, 44], 5.5);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: ""
      }).addTo(aiRoutingMap);

      // City markers
      Object.entries(cityCoords).forEach(([key, coord]) => {
        const label =
          key === "riyadh" ? "Riyadh" :
          key === "jeddah" ? "Jeddah" : "Dammam";
        L.marker(coord).addTo(aiRoutingMap).bindPopup(label);
      });
    }

    // ===== OPTIMIZATION TABLE =====
    function populateOptimizationTableInitial() {
      const container = document.getElementById("truck-list");
      if (!container) return;

      const existing = container.querySelectorAll(".truck-row:not(.header)");
      existing.forEach(e => e.remove());

      trucksScenario.forEach(tr => {
        const row = document.createElement("div");
        row.className = "truck-row";

        const col1 = document.createElement("div");
        col1.textContent = `${tr.id} ${tr.origin} â†’ ${tr.dest}`;

        const col2 = document.createElement("div");
        col2.textContent = (tr.currentLoad * 100).toFixed(0) + "%";

        const col3 = document.createElement("div");
        col3.textContent =
          currentLang === "ar"
            ? "Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø¨Ø¹Ø¯"
            : "No optimization run yet";

        row.appendChild(col1);
        row.appendChild(col2);
        row.appendChild(col3);
        container.appendChild(row);
      });
    }

    function populateOptimizationTable(trucks, suggestionById) {
      const container = document.getElementById("truck-list");
      if (!container) return;

      const existing = container.querySelectorAll(".truck-row:not(.header)");
      existing.forEach(e => e.remove());

      trucks.forEach(tr => {
        const row = document.createElement("div");
        row.className = "truck-row";

        const col1 = document.createElement("div");
        col1.textContent = `${tr.id} ${tr.origin} â†’ ${tr.dest}`;

        const col2 = document.createElement("div");
        const before = tr.currentLoad;
        const after  = tr.newLoad != null ? tr.newLoad : tr.currentLoad;
        const txt = `${(after * 100).toFixed(0)}%`;
        let chipClass = "chip";
        if (after >= 0.8) chipClass += " good";
        else if (after >= 0.6) chipClass += " warn";
        else chipClass += " bad";
        col2.innerHTML = `<span class="${chipClass}">${txt}</span>`;

        const col3 = document.createElement("div");
        const sug = suggestionById[tr.id];
        if (sug) {
          col3.textContent = sug.action;
        } else {
          col3.textContent =
            currentLang === "ar"
              ? "Ù„Ø§ ØªØºÙŠÙŠØ± Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø­Ù†Ø©."
              : "No change for this truck.";
        }

        row.appendChild(col1);
        row.appendChild(col2);
        row.appendChild(col3);
        container.appendChild(row);
      });
    }

    // ===== RUN OPTIMIZATION (MANUAL) =====
    async function runOptimization(e) {
      if (e) e.preventDefault();
      if (!isLoggedIn) {
        const msg = currentLang === "ar"
          ? "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."
          : "Please log in first.";
        alert(msg);
        return;
      }

      const weight = parseFloat(document.getElementById("weight").value || "0");
      const volume = parseFloat(document.getElementById("volume").value || "0");
      let destinationInput = (document.getElementById("destination").value || "").toLowerCase();
      const priority = document.getElementById("priority").value;

      const trucks = trucksScenario.map(t => ({ ...t }));

      let destKey = destinationInput.trim();
      if (!destKey) destKey = "riyadh";

      let inbound = trucks.filter(t =>
        t.dest.toLowerCase().includes(destKey)
      );
      if (inbound.length === 0) {
        inbound = trucks.filter(t => t.dest.toLowerCase() === "riyadh");
      }

      let target = inbound[0];
      inbound.forEach(t => {
        if (priority === "high") {
          const diffT = Math.abs(t.currentLoad - 0.6);
          const diffCurrent = Math.abs(target.currentLoad - 0.6);
          if (diffT < diffCurrent) target = t;
        } else {
          if (t.currentLoad < target.currentLoad) target = t;
        }
      });

      const existingTons = target.currentLoad * CAPACITY_TONS;
      const addedTons = isNaN(weight) ? 0 : weight;
      const newTotalTons = existingTons + addedTons;
      const newLoadFactor = Math.min(1, newTotalTons / CAPACITY_TONS);
      target.newLoad = newLoadFactor;

      trucks.forEach(t => {
        if (t.id !== target.id) t.newLoad = t.currentLoad;
      });

      const afterAvgLoad =
        trucks.reduce((sum, t) => sum + t.newLoad, 0) / trucks.length;

      const costAfter = baselineCost * (baselineAvgLoad / afterAvgLoad);
      const co2After  = baselineCO2  * (costAfter / baselineCost);

      lastAfterAvgLoad = afterAvgLoad;
      lastCostAfter    = costAfter;
      lastCo2After     = co2After;

      const loadAfterPct = (afterAvgLoad * 100).toFixed(0) + "%";
      document.getElementById("kpi-load-after").textContent = loadAfterPct;

      document.getElementById("kpi-cost-after").textContent =
        "~" + costAfter.toFixed(0) + " SAR";
      const costSavePct = ((baselineCost - costAfter) / baselineCost) * 100;
      document.getElementById("kpi-cost-savings").textContent =
        costSavePct > 0
          ? `-${costSavePct.toFixed(1)}% vs baseline`
          : (currentLang === "ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙÙŠØ±" : "No savings");

      document.getElementById("kpi-co2-after").textContent =
        "~" + co2After.toFixed(0) + " kg";
      const co2SavePct = ((baselineCO2 - co2After) / baselineCO2) * 100;
      document.getElementById("kpi-co2-savings").textContent =
        co2SavePct > 0
          ? `-${co2SavePct.toFixed(1)}% vs baseline`
          : (currentLang === "ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙÙŠØ±" : "No savings");

      if (!dashboardChart || !optChart) {
        initCharts(baselineAvgLoad, afterAvgLoad);
      }
      updateOptChart(afterAvgLoad);

      const suggestionById = {};
      suggestionById[target.id] = {
        truck: target,
        newLoad: newLoadFactor,
        action: currentLang === "ar"
          ? "Ø¯Ù…Ø¬ Ø§Ù„Ø´Ø­Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø±Ø­Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø©"
          : "Merge new shipment with return trip",
      };
      populateOptimizationTable(trucks, suggestionById);

      const summary = document.getElementById("opt-summary");
      if (currentLang === "ar") {
        summary.innerHTML =
          `ØªÙ… Ø¥Ø³Ù†Ø§Ø¯ Ø´Ø­Ù†Ø© ÙˆØ²Ù† <strong>${weight || 0} Ø·Ù†</strong> ` +
          `ÙˆØ­Ø¬Ù… <strong>${volume || 0} Ù…Â³</strong> Ø¥Ù„Ù‰ ` +
          `<strong>${target.id} (${target.origin} â†’ ${target.dest})</strong>ØŒ ` +
          `Ù…Ù…Ø§ ÙŠØ±ÙØ¹ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ù…ÙˆÙ„Ø© Ù…Ù† <strong>${(baselineAvgLoad * 100).toFixed(0)}%</strong> ` +
          `Ø¥Ù„Ù‰ <strong>${(afterAvgLoad * 100).toFixed(0)}%</strong>ØŒ ` +
          `Ù…Ø¹ ØªÙ‚Ù„ÙŠÙ„ ØªÙ‚Ø±ÙŠØ¨ÙŠ ÙÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù†Ø³Ø¨Ø© <strong>${Math.abs(costSavePct).toFixed(1)}%</strong> ` +
          `ÙˆØ§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª COâ‚‚ Ø¨Ù†Ø³Ø¨Ø© <strong>${Math.abs(co2SavePct).toFixed(1)}%</strong>.`;
      } else {
        summary.innerHTML =
          `The new shipment of <strong>${weight || 0} tons</strong> / ` +
          `<strong>${volume || 0} mÂ³</strong> is assigned to ` +
          `<strong>${target.id} (${target.origin} â†’ ${target.dest})</strong>, ` +
          `raising average fleet load from <strong>${(baselineAvgLoad * 100).toFixed(0)}%</strong> ` +
          `to <strong>${(afterAvgLoad * 100).toFixed(0)}%</strong>, ` +
          `with an estimated reduction of <strong>${Math.abs(costSavePct).toFixed(1)}%</strong> ` +
          `in operating cost and <strong>${Math.abs(co2SavePct).toFixed(1)}%</strong> in COâ‚‚ emissions.`;
      }

      // store lastOptimizationLoads for PDF
      lastOptimizationLoads = {};
      trucks.forEach(t => {
        lastOptimizationLoads[t.id] = {
          before: t.currentLoad,
          after: t.newLoad
        };
      });

      if (currentCompanyId) {
        await saveOptimizationResult(currentCompanyId, {
          shipmentWeight: weight || 0,
          shipmentVolume: volume || 0,
          destination: destinationInput || "",
          priority,
          assignedTruckId: target.id,
          assignedRoute: `${target.origin} â†’ ${target.dest}`,
          baselineAvgLoad,
          afterAvgLoad,
          baselineCost,
          costAfter,
          baselineCO2,
          co2After
        });
      }

      setActiveView("optimization-view");
    }

    // ===== CSV PLACEHOLDER =====
    function analyzeCSV(e) {
      if (e) e.preventDefault();
      const msg = document.getElementById("csv_message");
      const fileInput = document.getElementById("csv_file");
      if (!fileInput.files || !fileInput.files.length) {
        msg.textContent = currentLang === "ar"
          ? "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù CSV Ø£ÙˆÙ„Ø§Ù‹."
          : "Please choose a CSV file first.";
        return;
      }

      msg.textContent = currentLang === "ar"
        ? "ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù. ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø³ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„Ù‡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ."
        : "File uploaded. In a real version, AI will analyze it for optimization.";
    }

    // ===== PDF REPORT =====
    function generatePdfReport() {
      const msg = document.getElementById("pdf_message");

      if (!isLoggedIn) {
        msg.textContent = currentLang === "ar"
          ? "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±."
          : "Please log in first to generate a report.";
        return;
      }

      try {
        const jsPDFConstructor = window.jsPDF;
        if (!jsPDFConstructor) {
          msg.textContent = currentLang === "ar"
            ? "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ PDF."
            : "Could not load the PDF library (jsPDF).";
          return;
        }

        const doc = new jsPDFConstructor();

        // HEADER
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.text("Smart Load Analyzer â€“ Demo Report", 10, 16);

        doc.setFontSize(11);
        doc.setFont("helvetica", "normal");
        const companyName = currentCompanyData?.name || "Demo Carrier";
        doc.text(`Company: ${companyName}`, 10, 24);
        doc.text("Prepared by: Logixperts â€“ Naqlthon 4", 10, 30);
        doc.text("Contact: support@logixperts.com | +966 55 555 5555", 10, 36);

        // SECTION 1 â€“ KPIs
        let y = 46;
        doc.setFontSize(13);
        doc.setFont("helvetica", "bold");
        doc.text("1. Key Performance Indicators (KPIs)", 10, y);
        y += 6;

        const avgBeforePct = (baselineAvgLoad * 100).toFixed(1) + "%";
        const avgAfterPct = lastAfterAvgLoad != null
          ? (lastAfterAvgLoad * 100).toFixed(1) + "%"
          : avgBeforePct;

        const costAfter = lastCostAfter != null ? lastCostAfter : baselineCost;
        const co2After  = lastCo2After  != null ? lastCo2After  : baselineCO2;

        const costSavePct = ((baselineCost - costAfter) / baselineCost) * 100;
        const co2SavePct  = ((baselineCO2  - co2After)  / baselineCO2)  * 100;

        doc.setFontSize(11);
        doc.setFont("helvetica", "normal");
        doc.text(`Average load (before): ${avgBeforePct}`, 10, y);    y += 6;
        doc.text(`Average load (after):  ${avgAfterPct}`, 10, y);     y += 6;
        doc.text(`Operating cost / day (before): ~${baselineCost.toFixed(0)} SAR`, 10, y); y += 6;
        doc.text(`Operating cost / day (after):  ~${costAfter.toFixed(0)} SAR`, 10, y);   y += 6;
        doc.text(`COâ‚‚ / day (before): ~${baselineCO2.toFixed(0)} kg`, 10, y);            y += 6;
        doc.text(`COâ‚‚ / day (after):  ~${co2After.toFixed(0)} kg`, 10, y);               y += 6;

        doc.text(
          `Estimated cost savings: ${costSavePct.toFixed(1)}%`,
          10,
          y
        ); y += 6;
        doc.text(
          `Estimated COâ‚‚ reduction: ${co2SavePct.toFixed(1)}%`,
          10,
          y
        ); y += 8;

        // SECTION 2 â€“ PER TRUCK
        doc.setFontSize(13);
        doc.setFont("helvetica", "bold");
        doc.text("2. Per-Truck Load Factors", 10, y);
        y += 6;

        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.text("Truck / Route", 10, y);
        doc.text("Load Before", 80, y);
        doc.text("Load After", 140, y);
        doc.line(10, y + 2, 200, y + 2);
        y += 7;

        doc.setFont("helvetica", "normal");
        trucksScenario.forEach(tr => {
          const opt = lastOptimizationLoads && lastOptimizationLoads[tr.id];
          const beforeLoad = opt ? opt.before : tr.currentLoad;
          const afterLoad  = opt ? opt.after  : tr.currentLoad;

          const beforePct = (beforeLoad * 100).toFixed(0) + "%";
          const afterPct  = (afterLoad  * 100).toFixed(0) + "%";

          const label = `${tr.id} ${tr.origin}â†’${tr.dest}`;
          doc.text(label, 10, y);
          doc.text(beforePct, 80, y);
          doc.text(afterPct, 140, y);
          y += 6;
        });

        y += 6;

        // SECTION 3 â€“ RECOMMENDATIONS
        doc.setFontSize(13);
        doc.setFont("helvetica", "bold");
        doc.text("3. Recommended Actions", 10, y);
        y += 6;

        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        const lines = [
          "- Use return trips with low load (e.g., Jeddah â†’ Riyadh) to merge new shipments whenever possible.",
          "- Prioritize high-load corridors (Riyadhâ€“Jeddahâ€“Dammam) for strategic customers.",
          "- Track daily load factor vs. target and review under-utilized trucks weekly.",
          "- For small carriers, start with simple rules: avoid trips below 40% load if you can consolidate.",
          "- Consider longer-term contracts with anchor customers on the main corridors."
        ];
        lines.forEach(ln => {
          doc.text(ln, 10, y);
          y += 5;
        });

        // FOOTER
        doc.setFontSize(8);
        doc.text(
          "This is a demo report generated by Logixperts â€“ Smart Load Analyzer (Naqlthon 4).",
          10,
          290
        );

        doc.save("SmartLoad_Report_demo.pdf");

        msg.textContent = currentLang === "ar"
          ? "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­."
          : "Demo PDF report generated and downloaded successfully.";
      } catch (e) {
        console.error(e);
        msg.textContent = currentLang === "ar"
          ? "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù€ PDF."
          : "An error occurred while generating the PDF file.";
      }
    }

    // ===== AI ROUTING =====
    function runAiRouting(e) {
      if (e) e.preventDefault();
      if (!isLoggedIn) {
        const msg = currentLang === "ar"
          ? "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."
          : "Please log in first.";
        alert(msg);
        return;
      }

      const originKey = document.getElementById("routing-origin").value;
      const destKey   = document.getElementById("routing-dest").value;
      const objective = document.getElementById("routing-objective").value;
      const backhaul  = document.getElementById("routing-backhaul").value;
      const msgEl     = document.getElementById("routing_message");

      if (!originKey || !destKey || !cityCoords[originKey] || !cityCoords[destKey]) {
        msgEl.textContent = currentLang === "ar"
          ? "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ù† Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆÙˆØ¬Ù‡Ø© ØµØ­ÙŠØ­Ø©."
          : "Please choose valid origin and destination cities.";
        return;
      }

      if (!aiRoutingMap) {
        initRoutingMap();
      }

      if (aiRoutingLayer) {
        aiRoutingMap.removeLayer(aiRoutingLayer);
      }

      const originCoord = cityCoords[originKey];
      const destCoord   = cityCoords[destKey];
      const points = [originCoord, destCoord];

      if (backhaul === "yes") {
        points.push(originCoord);
      }

      aiRoutingLayer = L.polyline(points, {
        weight: 3
      }).addTo(aiRoutingMap);

      aiRoutingMap.fitBounds(aiRoutingLayer.getBounds(), { padding: [20, 20] });

      const originLabel =
        originKey === "riyadh" ? "Riyadh" :
        originKey === "jeddah" ? "Jeddah" : "Dammam";
      const destLabel =
        destKey === "riyadh" ? "Riyadh" :
        destKey === "jeddah" ? "Jeddah" : "Dammam";

      let text;
      if (currentLang === "ar") {
        const objectiveText =
          objective === "cost" ? "ØªÙ‚Ù„ÙŠÙ„ ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„" :
          objective === "load" ? "Ø±ÙØ¹ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„" :
          "ØªÙ‚Ù„ÙŠÙ„ Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†";

        text =
          `ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ø³Ø§Ø± Ù…Ù† ${originLabel} Ø¥Ù„Ù‰ ${destLabel}` +
          (backhaul === "yes" ? " Ù…Ø¹ Ø±Ø­Ù„Ø© Ø¹ÙˆØ¯Ø©." : ".") +
          ` Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù‡Ùˆ ${objectiveText}. ` +
          "ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆØ§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø²Ù…Ù†ÙŠØ© ÙˆØ§Ù„ÙˆØ²Ù† Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©.";
      } else {
        const objectiveText =
          objective === "cost" ? "minimize operating cost" :
          objective === "load" ? "maximize load factor" :
          "minimize COâ‚‚ emissions";

        text =
          `Suggested route from ${originLabel} to ${destLabel}` +
          (backhaul === "yes" ? " with a round trip." : ".") +
          ` Primary objective: ${objectiveText}. ` +
          "In a production version, this would use real trip history, time windows and truck constraints to generate more accurate routes.";
      }

      msgEl.textContent = text;
    }

    // ===== INIT =====
    window.addEventListener("load", () => {
      // Tabs visibility at start
      document.getElementById("tab_login").style.display     = "inline-flex";
      document.getElementById("tab_dashboard").style.display = "none";
      document.getElementById("tab_analyze").style.display   = "none";
      document.getElementById("tab_opt").style.display       = "none";
      document.getElementById("tab_routing").style.display   = "none";

      // Click handlers
      document.querySelectorAll(".nav-tab").forEach(btn => {
        btn.addEventListener("click", () => {
          const viewId = btn.dataset.view;
          guardAndSetView(viewId);
        });
      });

      document.getElementById("langSwitcher").addEventListener("click", toggleLanguage);

      document.getElementById("password_toggle_login").addEventListener("click", () => {
        togglePassword("password", document.getElementById("password_toggle_login"));
      });
      document.getElementById("password_toggle_signup").addEventListener("click", () => {
        togglePassword("signup-password", document.getElementById("password_toggle_signup"));
      });

      document.getElementById("login_form").addEventListener("submit", demoLogin);
      document.getElementById("signup_form").addEventListener("submit", signUp);
      document.getElementById("manual_analyze_form").addEventListener("submit", runOptimization);
      document.getElementById("csv_form").addEventListener("submit", analyzeCSV);
      document.getElementById("pdf_btn").addEventListener("click", generatePdfReport);
      document.getElementById("routing_form").addEventListener("submit", runAiRouting);

      const statsSaveBtn = document.getElementById("stats-save-btn");
      if (statsSaveBtn) {
        statsSaveBtn.addEventListener("click", saveCompanyStats);
      }

      applyLanguage();
      populateOptimizationTableInitial();
      updateBaselineKpis();
    });
  </script>
</body>
</html>
