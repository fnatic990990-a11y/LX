<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Logixperts - Smart Load Analyzer (Admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Tailwind-like simple custom styling (no framework) -->
  <style>
    :root {
      --bg: #020617;
      --card: #0b1220;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%);
      color: var(--text);
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .lang-toggle {
      display: flex;
      gap: 8px;
      background: #020617;
      border-radius: 999px;
      padding: 4px;
      border: 1px solid var(--border);
    }

    .lang-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
    }

    .lang-btn.active {
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
    }

    .tab-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tab-btn span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--muted);
    }

    .tab-btn.active {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .tab-btn.active span.dot {
      background: var(--accent);
    }

    .tab-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .card {
      background: linear-gradient(145deg, #020617, #020617 40%, #020617 100%);
      border-radius: 18px;
      padding: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
      position: relative;
      overflow: hidden;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.08);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.25);
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
    }

    label {
      font-size: 12px;
      color: var(--muted);
    }

    input,
    select {
      background: #020617;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 13px;
      color: var(--text);
      outline: none;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 600;
    }

    .btn-outline {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .btn-danger {
      background: rgba(248, 113, 113, 0.18);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.35);
    }

    .kpi-value {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--muted);
    }

    .kpi-placeholder {
      color: var(--muted);
      font-style: italic;
    }

    #map {
      width: 100%;
      height: 360px;
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    canvas {
      border-radius: 16px;
      background: #020617;
      border: 1px solid var(--border);
    }

    .footer {
      margin-top: 24px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .support-card {
      margin-top: 24px;
    }

    .support-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .support-label {
      color: var(--text);
      font-weight: 500;
      margin-right: 4px;
    }

    @media (max-width: 640px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .tabs {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- HEADER -->
    <header class="header">
      <div class="brand">
        <div class="brand-title">Logixperts · Smart Load Analyzer</div>
        <div class="brand-subtitle" id="companyInfoLabel">
          Admin Portal · Company KPIs · Route Optimization
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <button id="logoutBtn" class="btn btn-danger" style="display:none;">
          Logout
        </button>
      </div>
    </header>

    <!-- TABS -->
    <nav class="tabs">
      <button class="tab-btn active" data-tab="login">
        <span class="dot"></span> Login
      </button>
      <button class="tab-btn disabled" data-tab="dashboard">
        <span class="dot"></span> Dashboard
      </button>
      <button class="tab-btn disabled" data-tab="analyze">
        <span class="dot"></span> Analyze Load
      </button>
      <button class="tab-btn disabled" data-tab="optimization">
        <span class="dot"></span> Optimization
      </button>
    </nav>

    <!-- LOGIN TAB -->
    <section id="tab-login" class="tab-content active">
      <div class="grid grid-2">
        <div class="card">
          <div class="badge">Company Access</div>
          <h2 class="card-title" style="margin-top:10px;margin-bottom:4px;">
            Sign in to your company workspace
          </h2>
          <p class="card-subtitle">
            Use your registered email and password to access your dashboard,
            KPIs, and optimization tools.
          </p>

          <div class="field-group">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" placeholder="company@email.com" />
          </div>
          <div class="field-group">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" placeholder="••••••••" />
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="loginBtn" class="btn btn-primary">
              Login
            </button>
            <button id="registerBtn" class="btn btn-outline">
              Register company
            </button>
          </div>

          <p
            id="authMessage"
            style="margin-top:10px;font-size:12px;color:var(--muted);"
          ></p>
        </div>

        <div class="card">
          <div class="card-title">How access works</div>
          <p class="card-subtitle" style="margin-bottom:10px;">
            Each company has a dedicated space. KPIs, routes, and optimization
            results are isolated per account.
          </p>
          <ul style="font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:6px;">
            <li>· Use a work email to register.</li>
            <li>· After login, you can enter your own KPIs.</li>
            <li>· KPIs and dashboards are hidden until you authenticate.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- DASHBOARD TAB -->
    <section id="tab-dashboard" class="tab-content">
      <div class="grid grid-2">
        <!-- KPIs -->
        <div class="card">
          <div class="badge">Company KPIs</div>
          <h2 class="card-title" style="margin-top:10px;margin-bottom:2px;">
            Fleet performance snapshot
          </h2>
          <p class="card-subtitle">
            These KPIs are specific to your company and hidden until login and
            first setup.
          </p>

          <div class="grid grid-3" style="margin-top:10px;">
            <div>
              <div id="kpiAvgLoad" class="kpi-value kpi-placeholder">
                --
              </div>
              <div class="kpi-label">Average Load (%)</div>
            </div>
            <div>
              <div id="kpiCost" class="kpi-value kpi-placeholder">
                --
              </div>
              <div class="kpi-label">Average Daily Cost</div>
            </div>
            <div>
              <div id="kpiCO2" class="kpi-value kpi-placeholder">
                --
              </div>
              <div class="kpi-label">Average CO₂ Emissions</div>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;" />

          <h3
            style="font-size:13px;font-weight:600;margin-bottom:6px;"
          >
            Enter / update your KPIs
          </h3>
          <p class="card-subtitle" style="margin-bottom:10px;">
            Once saved, these values will appear above and can be used later in
            analysis and reports.
          </p>

          <form id="kpiForm">
            <div class="grid grid-3">
              <div class="field-group">
                <label for="avgLoadInput">Avg Load (%)</label>
                <input
                  id="avgLoadInput"
                  type="number"
                  min="0"
                  max="100"
                  step="0.01"
                  placeholder="e.g. 68.4"
                />
              </div>
              <div class="field-group">
                <label for="costInput">Daily Cost (SAR)</label>
                <input
                  id="costInput"
                  type="number"
                  min="0"
                  step="0.01"
                  placeholder="e.g. 25000"
                />
              </div>
              <div class="field-group">
                <label for="co2Input">CO₂ (kg/day)</label>
                <input
                  id="co2Input"
                  type="number"
                  min="0"
                  step="0.01"
                  placeholder="e.g. 5400"
                />
              </div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;">
              <button type="submit" class="btn btn-primary">
                Save KPIs
              </button>
              <span
                id="kpiStatus"
                style="font-size:12px;color:var(--muted);align-self:center;"
              ></span>
            </div>
          </form>
        </div>

        <!-- MAP -->
        <div class="card">
          <div class="badge">Network map</div>
          <h2 class="card-title" style="margin-top:10px;margin-bottom:4px;">
            Core lanes & coverage
          </h2>
          <p class="card-subtitle">
            High-level visualization of key routes between Riyadh, Jeddah, and
            Dammam. The map is fully responsive and fixed for tab rendering
            issues.
          </p>
          <div id="map"></div>
        </div>
      </div>
    </section>

    <!-- ANALYZE TAB -->
    <section id="tab-analyze" class="tab-content">
      <div class="grid grid-3">
        <!-- Card 1: Analyze new shipment -->
        <div class="card">
          <div class="badge">Manual analysis</div>
          <h2 class="card-title" style="margin-top:10px;margin-bottom:2px;">
            Analyze new shipment
          </h2>
          <p class="card-subtitle">
            Enter a single shipment (origin, destination, weight) and compare
            its impact on your current KPIs.
          </p>

          <div class="field-group">
            <label for="shipOrigin">Origin</label>
            <input id="shipOrigin" type="text" placeholder="e.g. Riyadh DC" />
          </div>
          <div class="field-group">
            <label for="shipDestination">Destination</label>
            <input
              id="shipDestination"
              type="text"
              placeholder="e.g. Jeddah Hub"
            />
          </div>
          <div class="field-group">
            <label for="shipWeight">Weight (tons)</label>
            <input
              id="shipWeight"
              type="number"
              min="0"
              step="0.01"
              placeholder="e.g. 22.5"
            />
          </div>

          <button id="simulateShipmentBtn" class="btn btn-primary" style="margin-top:8px;">
            Run quick simulation
          </button>

          <p
            id="simulateShipmentResult"
            style="margin-top:10px;font-size:12px;color:var(--muted);"
          ></p>
        </div>

        <!-- Card 2: Upload AI Trip Analyzer placeholder -->
        <div class="card">
          <div class="badge">Trip data</div>
          <h2 class="card-title" style="margin-top:10px;margin-bottom:2px;">
            Upload trip file (CSV)
          </h2>
          <p class="card-subtitle">
            Upload a CSV file with your trips (date, truck, origin, destination,
            load, distance) to analyze consolidation opportunities.
          </p>

          <div class="field-group">
            <label for="tripFile">Trip CSV</label>
            <input id="tripFile" type="file" accept=".csv" />
          </div>

          <button id="analyzeCsvBtn" class="btn btn-outline" style="margin-top:8px;">
            Analyze trips (placeholder)
          </button>

          <p
            id="csvStatus"
            style="margin-top:10px;font-size:12px;color:var(--muted);"
          >
            In this version, the button just simulates analysis. You can later
            plug AI / advanced logic without تغيير الواجهة.
          </p>
        </div>

        <!-- Card 3: PDF AI Report placeholder -->
        <div class="card">
          <div class="badge">Reporting</div>
          <h2 class="card-title" style="margin-top:10px;margin-bottom:2px;">
            PDF optimization report
          </h2>
          <p class="card-subtitle">
            Generate a structured PDF summary that you can share with
            management. (Use your existing jsPDF logic هنا بدون ما نغيره).
          </p>

          <button id="downloadPdfBtn" class="btn btn-primary" style="margin-top:8px;">
            Download PDF report
          </button>

          <p
            id="pdfStatus"
            style="margin-top:10px;font-size:12px;color:var(--muted);"
          >
            اربط هذا الزر بدالة الـ PDF اللي عندك حاليًا. الكود هنا ما
            يلمس منطق الـ PDF عشان ما نخرب شيء شغال.
          </p>
        </div>
      </div>

      <!-- NEW CHART (moved from Dashboard to Analyze) -->
      <div class="card" style="margin-top:18px;">
        <div class="badge">Load profile</div>
        <h2 class="card-title" style="margin-top:10px;margin-bottom:4px;">
          Before vs after optimization (sample chart)
        </h2>
        <p class="card-subtitle">
          This chart lives now inside <strong>Analyze Load</strong> tab instead
          of Dashboard. You can later connect it to real optimization data.
        </p>

        <canvas id="analyzeChart" height="130"></canvas>
      </div>
    </section>

    <!-- OPTIMIZATION TAB -->
    <section id="tab-optimization" class="tab-content">
      <div class="card">
        <div class="badge">Optimization scenarios</div>
        <h2 class="card-title" style="margin-top:10px;margin-bottom:4px;">
          Consolidation & routing scenarios
        </h2>
        <p class="card-subtitle">
          Summarize the main optimization scenarios comparing total trips,
          average load, cost and CO₂ impact.
        </p>

        <div style="overflow-x:auto;margin-top:10px;">
          <table
            style="width:100%;border-collapse:collapse;font-size:12px;color:var(--muted);"
          >
            <thead>
              <tr>
                <th style="border-bottom:1px solid var(--border);padding:6px;text-align:left;">
                  Scenario
                </th>
                <th style="border-bottom:1px solid var(--border);padding:6px;text-align:right;">
                  Total trips
                </th>
                <th style="border-bottom:1px solid var(--border);padding:6px;text-align:right;">
                  Avg load (%)
                </th>
                <th style="border-bottom:1px solid var(--border);padding:6px;text-align:right;">
                  Daily cost (SAR)
                </th>
                <th style="border-bottom:1px solid var(--border);padding:6px;text-align:right;">
                  CO₂ (kg/day)
                </th>
              </tr>
            </thead>
            <tbody id="optimizationTableBody">
              <!-- Fill later from your optimization logic -->
              <tr>
                <td style="padding:6px;">Baseline</td>
                <td style="padding:6px;text-align:right;">24</td>
                <td style="padding:6px;text-align:right;">48.0</td>
                <td style="padding:6px;text-align:right;">32,000</td>
                <td style="padding:6px;text-align:right;">5,600</td>
              </tr>
              <tr>
                <td style="padding:6px;">Merged lanes</td>
                <td style="padding:6px;text-align:right;">18</td>
                <td style="padding:6px;text-align:right;">66.2</td>
                <td style="padding:6px;text-align:right;">27,500</td>
                <td style="padding:6px;text-align:right;">4,200</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SUPPORT / CUSTOMER SERVICE -->
    <section class="card support-card">
      <div class="badge">Customer Support</div>
      <h2 class="card-title" style="margin-top:10px;margin-bottom:4px;">
        Need help with your account or routes?
      </h2>
      <p class="card-subtitle" style="margin-bottom:12px;">
        Contact our support team for onboarding, data upload templates, and
        using the optimization tools.
      </p>

      <div class="support-row">
        <div>
          <span class="support-label">Phone:</span>
          +966-XXX-XXX-XXX
        </div>
        <div>
          <span class="support-label">Email:</span>
          support@logixperts.com
        </div>
        <div>
          <span class="support-label">Fax:</span>
          +966-XX-XXXXXXX
        </div>
      </div>
    </section>

    <div class="footer">
      Logixperts · Smart Load Analyzer · Admin Portal
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Chart.js (for Analyze tab chart only) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- MAIN APP LOGIC -->
  <script type="module">
    // ==========================
    //  FIREBASE SETUP
    // ==========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // IMPORTANT:
    // لا تحط YOUR_API_KEY هنا ولا تلزق كود وهمي،
    // بس انسخ إعدادات firebaseConfig اللي عندك في المشروع القديم:
    const firebaseConfig = {
      // حط إعدادات مشروعك هنا:
      // apiKey: "...",
      // authDomain: "...",
      // projectId: "...",
      // ...
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ==========================
    //  DOM ELEMENTS
    // ==========================
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabContents = {
      login: document.getElementById("tab-login"),
      dashboard: document.getElementById("tab-dashboard"),
      analyze: document.getElementById("tab-analyze"),
      optimization: document.getElementById("tab-optimization"),
    };

    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const authMessage = document.getElementById("authMessage");
    const logoutBtn = document.getElementById("logoutBtn");

    const kpiAvgLoad = document.getElementById("kpiAvgLoad");
    const kpiCost = document.getElementById("kpiCost");
    const kpiCO2 = document.getElementById("kpiCO2");
    const kpiForm = document.getElementById("kpiForm");
    const avgLoadInput = document.getElementById("avgLoadInput");
    const costInput = document.getElementById("costInput");
    const co2Input = document.getElementById("co2Input");
    const kpiStatus = document.getElementById("kpiStatus");

    const simulateShipmentBtn = document.getElementById("simulateShipmentBtn");
    const simulateShipmentResult = document.getElementById("simulateShipmentResult");
    const shipOrigin = document.getElementById("shipOrigin");
    const shipDestination = document.getElementById("shipDestination");
    const shipWeight = document.getElementById("shipWeight");

    const analyzeCsvBtn = document.getElementById("analyzeCsvBtn");
    const csvStatus = document.getElementById("csvStatus");
    const downloadPdfBtn = document.getElementById("downloadPdfBtn");
    const pdfStatus = document.getElementById("pdfStatus");

    // ==========================
    //  STATE
    // ==========================
    let currentUser = null;
    let mapInstance = null;
    let analyzeChart = null;

    // ==========================
    //  TAB HANDLING
    // ==========================
    function setActiveTab(tabName) {
      tabButtons.forEach((btn) => {
        const target = btn.getAttribute("data-tab");
        if (target === tabName) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });

      Object.entries(tabContents).forEach(([name, section]) => {
        if (name === tabName) {
          section.classList.add("active");
        } else {
          section.classList.remove("active");
        }
      });

      // Fix Leaflet when dashboard tab becomes visible
      if (tabName === "dashboard") {
        initMapSafely();
      }
    }

    function updateTabLock(isLoggedIn) {
      tabButtons.forEach((btn) => {
        const tab = btn.getAttribute("data-tab");
        if (tab === "login") return;

        if (isLoggedIn) {
          btn.classList.remove("disabled");
        } else {
          btn.classList.add("disabled");
        }
      });
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        const isDisabled = btn.classList.contains("disabled");
        if (isDisabled) {
          alert("Please login first to access this section.");
          return;
        }
        setActiveTab(tab);
      });
    });

    // ==========================
    //  AUTH HANDLERS
    // ==========================
    loginBtn.addEventListener("click", async () => {
      authMessage.textContent = "";
      try {
        const email = loginEmail.value.trim();
        const pass = loginPassword.value.trim();
        if (!email || !pass) {
          authMessage.textContent = "Please fill both email and password.";
          authMessage.style.color = "var(--muted)";
          return;
        }
        await signInWithEmailAndPassword(auth, email, pass);
        authMessage.textContent = "Logged in successfully.";
        authMessage.style.color = "#bbf7d0";
      } catch (err) {
        console.error(err);
        authMessage.textContent = err.message;
        authMessage.style.color = "var(--danger)";
      }
    });

    registerBtn.addEventListener("click", async () => {
      authMessage.textContent = "";
      try {
        const email = loginEmail.value.trim();
        const pass = loginPassword.value.trim();
        if (!email || !pass) {
          authMessage.textContent = "Please fill both email and password.";
          authMessage.style.color = "var(--muted)";
          return;
        }
        await createUserWithEmailAndPassword(auth, email, pass);
        authMessage.textContent = "Company registered and logged in.";
        authMessage.style.color = "#bbf7d0";
      } catch (err) {
        console.error(err);
        authMessage.textContent = err.message;
        authMessage.style.color = "var(--danger)";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;

      if (user) {
        logoutBtn.style.display = "inline-flex";
        updateTabLock(true);
        setActiveTab("dashboard"); // go to dashboard after login
        await loadCompanyKpis();   // load KPIs from Firestore
      } else {
        logoutBtn.style.display = "none";
        updateTabLock(false);
        setActiveTab("login");
        resetKpisToHidden();
      }
    });

    // ==========================
    //  KPIs & FIRESTORE
    // ==========================
    function resetKpisToHidden() {
      // ما نعرض أي قيم افتراضية قبل تسجيل الدخول أو قبل ما الشركة تحفظ قيمها
      kpiAvgLoad.textContent = "--";
      kpiAvgLoad.classList.add("kpi-placeholder");
      kpiCost.textContent = "--";
      kpiCost.classList.add("kpi-placeholder");
      kpiCO2.textContent = "--";
      kpiCO2.classList.add("kpi-placeholder");
      avgLoadInput.value = "";
      costInput.value = "";
      co2Input.value = "";
      kpiStatus.textContent = "";
    }

    async function loadCompanyKpis() {
      if (!currentUser) return;
      resetKpisToHidden();

      try {
        const ref = doc(db, "companies", currentUser.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data();
          const stats = data.stats || {};

          if (
            typeof stats.avgLoad === "number" ||
            typeof stats.cost === "number" ||
            typeof stats.co2 === "number"
          ) {
            // Show KPIs because company already set them at least once
            if (typeof stats.avgLoad === "number") {
              kpiAvgLoad.textContent = stats.avgLoad.toFixed(2) + "%";
              kpiAvgLoad.classList.remove("kpi-placeholder");
              avgLoadInput.value = stats.avgLoad;
            }
            if (typeof stats.cost === "number") {
              kpiCost.textContent = stats.cost.toLocaleString("en-US", {
                maximumFractionDigits: 2,
              });
              kpiCost.classList.remove("kpi-placeholder");
              costInput.value = stats.cost;
            }
            if (typeof stats.co2 === "number") {
              kpiCO2.textContent = stats.co2.toLocaleString("en-US", {
                maximumFractionDigits: 2,
              });
              kpiCO2.classList.remove("kpi-placeholder");
              co2Input.value = stats.co2;
            }
          } else {
            // company doc exists but no stats yet -> keep placeholders
            resetKpisToHidden();
          }
        } else {
          // لا يوجد مستند للشركة → أول مرة، نخليها مخفية
          resetKpisToHidden();
        }
      } catch (err) {
        console.error("Error loading KPIs", err);
        resetKpisToHidden();
      }
    }

    kpiForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("Please login first.");
        return;
      }

      const avgVal = parseFloat(avgLoadInput.value);
      const costVal = parseFloat(costInput.value);
      const co2Val = parseFloat(co2Input.value);

      if (Number.isNaN(avgVal) || Number.isNaN(costVal) || Number.isNaN(co2Val)) {
        kpiStatus.textContent = "Please fill all KPI fields with valid numbers.";
        kpiStatus.style.color = "var(--danger)";
        return;
      }

      try {
        const ref = doc(db, "companies", currentUser.uid);
        await setDoc(
          ref,
          {
            stats: {
              avgLoad: avgVal,
              cost: costVal,
              co2: co2Val,
            },
          },
          { merge: true }
        );

        // بعد الحفظ، نعرضها فوراً في الكروت
        kpiAvgLoad.textContent = avgVal.toFixed(2) + "%";
        kpiAvgLoad.classList.remove("kpi-placeholder");

        kpiCost.textContent = costVal.toLocaleString("en-US", {
          maximumFractionDigits: 2,
        });
        kpiCost.classList.remove("kpi-placeholder");

        kpiCO2.textContent = co2Val.toLocaleString("en-US", {
          maximumFractionDigits: 2,
        });
        kpiCO2.classList.remove("kpi-placeholder");

        kpiStatus.textContent = "KPIs saved successfully.";
        kpiStatus.style.color = "#bbf7d0";

        // تقدر لاحقًا تستخدم هذه الكي بي آي في التحليلات / الرسم
      } catch (err) {
        console.error("Error saving KPIs", err);
        kpiStatus.textContent = "Error saving KPIs.";
        kpiStatus.style.color = "var(--danger)";
      }
    });

    // ==========================
    //  MAP (Leaflet) - FIXED
    // ==========================
    function initMapSafely() {
      const mapContainer = document.getElementById("map");
      if (!mapContainer) return;

      // لو أنشأناه قبل، لا نعيد
      if (!mapInstance) {
        mapInstance = L.map("map", {
          center: [24.7136, 46.6753], // Riyadh
          zoom: 6,
        });

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 18,
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(mapInstance);

        const riyadh = [24.7136, 46.6753];
        const jeddah = [21.4858, 39.1925];
        const dammam = [26.4207, 50.0888];

        L.marker(riyadh).addTo(mapInstance).bindPopup("Riyadh");
        L.marker(jeddah).addTo(mapInstance).bindPopup("Jeddah");
        L.marker(dammam).addTo(mapInstance).bindPopup("Dammam");

        L.polyline([riyadh, jeddah], { weight: 3 }).addTo(mapInstance);
        L.polyline([riyadh, dammam], { weight: 3 }).addTo(mapInstance);
      }

      // مهم جداً: بعد ما يصير الـ div مرئي، نعيد حساب الحجم
      setTimeout(() => {
        mapInstance.invalidateSize();
      }, 200);
    }

    // ==========================
    //  ANALYZE TAB LOGIC
    // ==========================
    simulateShipmentBtn.addEventListener("click", () => {
      if (!currentUser) {
        alert("Please login first.");
        return;
      }
      const origin = shipOrigin.value.trim() || "Unknown origin";
      const dest = shipDestination.value.trim() || "Unknown destination";
      const weight = parseFloat(shipWeight.value) || 0;

      simulateShipmentResult.textContent =
        `Simulation example: Shipment ${origin} → ${dest}, ` +
        `weight ${weight.toFixed(2)} tons. ` +
        `In a real version, this will estimate load factor impact vs your KPIs.`;
    });

    analyzeCsvBtn.addEventListener("click", () => {
      if (!currentUser) {
        alert("Please login first.");
        return;
      }
      csvStatus.textContent =
        "Placeholder: CSV uploaded. Later you can parse and feed results to the optimization + chart.";
    });

    downloadPdfBtn.addEventListener("click", () => {
      if (!currentUser) {
        alert("Please login first.");
        return;
      }
      // هنا اربط دالة الـ PDF الحقيقية اللي عندك أصلاً
      pdfStatus.textContent =
        "Connect this button to your existing jsPDF report function. This code doesn't touch PDF logic.";
    });

    // ==========================
    //  CHART.JS - MOVED TO ANALYZE
    // ==========================
    function initAnalyzeChart() {
      const canvas = document.getElementById("analyzeChart");
      if (!canvas) return;

      const ctx = canvas.getContext("2d");

      // Destroy old chart if exists
      if (analyzeChart) {
        analyzeChart.destroy();
      }

      // Sample data (استبدلها لاحقاً بنتائج الـ optimization أو بيانات حقيقية)
      const labels = ["Riyadh-Jeddah", "Riyadh-Dammam", "Jeddah-Dammam"];
      const beforeLoad = [48, 52, 46];
      const afterLoad = [66.5, 71.2, 63.8];

      analyzeChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Before optimization",
              data: beforeLoad,
              borderWidth: 1,
            },
            {
              label: "After optimization",
              data: afterLoad,
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: "#e5e7eb",
              },
            },
          },
          scales: {
            x: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(55,65,81,0.3)" },
            },
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(55,65,81,0.3)" },
            },
          },
        },
      });
    }

    // نضمن أن الشارت يشتغل أول ما يفتح المستخدم تبويب Analyze (بعد تسجيل الدخول طبعًا)
    const analyzeTabBtn = document.querySelector('[data-tab="analyze"]');
    analyzeTabBtn.addEventListener("click", () => {
      const isDisabled = analyzeTabBtn.classList.contains("disabled");
      if (!isDisabled) {
        setTimeout(() => {
          initAnalyzeChart();
        }, 200);
      }
    });

    // لو احتجت تشغّله فورًا بعد تسجيل الدخول وفي حال كان التاب مفتوح
    // تقدر تنادي initAnalyzeChart() بعد ما تكمّل جلب الداتا.

    // ==========================
    //  INITIAL STATE
    // ==========================
    // خلك على تبويب تسجيل الدخول أول ما يفتح الموقع
    setActiveTab("login");
    updateTabLock(false);
    resetKpisToHidden();
  </script>
</body>
</html>
